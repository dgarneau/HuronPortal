name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

    - name: Deploy with zip (let Azure build)
      run: |
        # Créer un zip du code source uniquement
        zip -r deploy.zip . -x "*.git*" "node_modules/*" ".next/*" "*.md"
        
        # Déployer sur Azure (Azure fera le npm install et npm run build)
        az webapp deploy \
          --resource-group huronportal-rg \
          --name huronportal-app \
          --src-path deploy.zip \
          --type zip \
          --async false
