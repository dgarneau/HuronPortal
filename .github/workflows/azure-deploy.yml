name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        clean: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: |
        rm -rf node_modules .next
        npm ci

    - name: Build Next.js app
      run: |
        rm -rf .next
        npm run build
      env:
        COSMOS_ENDPOINT: ${{ secrets.COSMOS_ENDPOINT }}
        COSMOS_KEY: ${{ secrets.COSMOS_KEY }}
        COSMOS_DATABASE: ${{ secrets.COSMOS_DATABASE }}
        SESSION_SECRET: ${{ secrets.SESSION_SECRET }}

    - name: Verify build output
      run: |
        echo "========================================="
        echo "Checking for bcrypt references in compiled code..."
        echo "========================================="
        if grep -r "bcrypt" .next/standalone/.next/server/app/api/auth/login/route.js 2>/dev/null; then
          echo "❌ ERROR: Found bcrypt reference in compiled code!"
          echo "This should not happen with @noble/hashes"
          exit 1
        else
          echo "✓ No bcrypt references found"
        fi
        
        echo ""
        echo "Checking lib/auth/password.ts source..."
        cat lib/auth/password.ts | head -5
        
        echo ""
        echo "Checking @noble/hashes in node_modules..."
        ls -la node_modules/@noble/hashes/ || echo "❌ @noble/hashes not found!"

    - name: Create deployment package
      run: |
        rm -rf deploy
        mkdir -p deploy/.next/static
        cp -R .next/standalone/* deploy/
        cp -R .next/static/* deploy/.next/static/
        if [ -d public ]; then cp -R public deploy/public; fi
        cp web.config deploy/
        cp package.json deploy/
        cp ecosystem.config.js deploy/
        
        # Ensure @noble/hashes is present in deployment
        if [ ! -d "deploy/node_modules/@noble" ]; then
          echo "WARNING: @noble/hashes not found in standalone build, copying manually..."
          mkdir -p deploy/node_modules/@noble
          cp -R node_modules/@noble/hashes deploy/node_modules/@noble/
          echo "@noble/hashes copied successfully"
        else
          echo "✓ @noble/hashes found in standalone build"
        fi
        
        # Create deployment marker to force cache invalidation
        echo "DEPLOYMENT_ID=$GITHUB_SHA" > deploy/.deployment-id
        echo "BUILT_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> deploy/.deployment-id
        
        echo "========================================="
        echo "Deployment package created successfully"
        echo "Deployment ID: $GITHUB_SHA"
        echo "========================================="

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: 'huronportal-app'
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ./deploy
        clean: true
    
    - name: Force Azure restart and cache clear
      run: |
        echo "Deployment completed. Azure will automatically restart."
        echo "Waiting 10 seconds for deployment to settle..."
        sleep 10
        echo "✓ Deployment process complete"
