exports.id=418,exports.ids=[418],exports.modules={7478:function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);(!r||("get"in r?!t.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.req=t.json=t.toBuffer=void 0;let s=o(i(2615)),a=o(i(8791));async function c(e){let t=0,i=[];for await(let n of e)t+=n.length,i.push(n);return Buffer.concat(i,t)}async function l(e){let t=(await c(e)).toString("utf8");try{return JSON.parse(t)}catch(e){throw e.message+=` (input: ${t})`,e}}t.toBuffer=c,t.json=l,t.req=function(e,t={}){let i=(("string"==typeof e?e:e.href).startsWith("https:")?a:s).request(e,t),n=new Promise((e,t)=>{i.once("response",e).once("error",t).end()});return i.then=n.then.bind(n),i}},4467:function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);(!r||("get"in r?!t.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return r(t,e),t},s=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||n(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),t.Agent=void 0;let a=o(i(8216)),c=o(i(2615)),l=i(8791);s(i(7478),t);let u=Symbol("AgentBaseInternalState");class h extends c.Agent{constructor(e){super(e),this[u]={}}isSecureEndpoint(e){if(e){if("boolean"==typeof e.secureEndpoint)return e.secureEndpoint;if("string"==typeof e.protocol)return"https:"===e.protocol}let{stack:t}=Error();return"string"==typeof t&&t.split("\n").some(e=>-1!==e.indexOf("(https.js:")||-1!==e.indexOf("node:https:"))}incrementSockets(e){if(this.maxSockets===1/0&&this.maxTotalSockets===1/0)return null;this.sockets[e]||(this.sockets[e]=[]);let t=new a.Socket({writable:!1});return this.sockets[e].push(t),this.totalSocketCount++,t}decrementSockets(e,t){if(!this.sockets[e]||null===t)return;let i=this.sockets[e],n=i.indexOf(t);-1!==n&&(i.splice(n,1),this.totalSocketCount--,0===i.length&&delete this.sockets[e])}getName(e){return this.isSecureEndpoint(e)?l.Agent.prototype.getName.call(this,e):super.getName(e)}createSocket(e,t,i){let n={...t,secureEndpoint:this.isSecureEndpoint(t)},r=this.getName(n),o=this.incrementSockets(r);Promise.resolve().then(()=>this.connect(e,n)).then(s=>{if(this.decrementSockets(r,o),s instanceof c.Agent)try{return s.addRequest(e,n)}catch(e){return i(e)}this[u].currentSocket=s,super.createSocket(e,t,i)},e=>{this.decrementSockets(r,o),i(e)})}createConnection(){let e=this[u].currentSocket;if(this[u].currentSocket=void 0,!e)throw Error("No socket was returned in the `connect()` function");return e}get defaultPort(){return this[u].defaultPort??("https:"===this.protocol?443:80)}set defaultPort(e){this[u]&&(this[u].defaultPort=e)}get protocol(){return this[u].protocol??(this.isSecureEndpoint()?"https:":"http:")}set protocol(e){this[u]&&(this[u].protocol=e)}}t.Agent=h},3050:(e,t,i)=>{t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;let i="color: "+this.color;t.splice(1,0,i,"color: inherit");let n=0,r=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(n++,"%c"===e&&(r=n))}),t.splice(r,0,i)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")||t.storage.getItem("DEBUG")}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e},t.useColors=function(){let e;return"undefined"!=typeof window&&!!window.process&&("renderer"===window.process.type||!!window.process.__nwjs)||!("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&(e=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(e[1],10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=i(783)(t);let{formatters:n}=e.exports;n.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}},783:(e,t,i)=>{e.exports=function(e){function t(e){let i,r,o;let s=null;function a(...e){if(!a.enabled)return;let n=Number(new Date),r=n-(i||n);a.diff=r,a.prev=i,a.curr=n,i=n,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(i,n)=>{if("%%"===i)return"%";o++;let r=t.formatters[n];if("function"==typeof r){let t=e[o];i=r.call(a,t),e.splice(o,1),o--}return i}),t.formatArgs.call(a,e),(a.log||t.log).apply(a,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=n,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==s?s:(r!==t.namespaces&&(r=t.namespaces,o=t.enabled(e)),o),set:e=>{s=e}}),"function"==typeof t.init&&t.init(a),a}function n(e,i){let n=t(this.namespace+(void 0===i?":":i)+e);return n.log=this.log,n}function r(e,t){let i=0,n=0,r=-1,o=0;for(;i<e.length;)if(n<t.length&&(t[n]===e[i]||"*"===t[n]))"*"===t[n]?(r=n,o=i):i++,n++;else{if(-1===r)return!1;n=r+1,i=++o}for(;n<t.length&&"*"===t[n];)n++;return n===t.length}return t.debug=t,t.default=t,t.coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){let e=[...t.names,...t.skips.map(e=>"-"+e)].join(",");return t.enable(""),e},t.enable=function(e){for(let i of(t.save(e),t.namespaces=e,t.names=[],t.skips=[],("string"==typeof e?e:"").trim().replace(/\s+/g,",").split(",").filter(Boolean)))"-"===i[0]?t.skips.push(i.slice(1)):t.names.push(i)},t.enabled=function(e){for(let i of t.skips)if(r(e,i))return!1;for(let i of t.names)if(r(e,i))return!0;return!1},t.humanize=i(3974),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach(i=>{t[i]=e[i]}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let i=0;for(let t=0;t<e.length;t++)i=(i<<5)-i+e.charCodeAt(t)|0;return t.colors[Math.abs(i)%t.colors.length]},t.enable(t.load()),t}},9092:(e,t,i)=>{"undefined"==typeof process||"renderer"===process.type||process.__nwjs?e.exports=i(3050):e.exports=i(2226)},2226:(e,t,i)=>{let n=i(4175),r=i(1764);t.init=function(e){e.inspectOpts={};let i=Object.keys(t.inspectOpts);for(let n=0;n<i.length;n++)e.inspectOpts[i[n]]=t.inspectOpts[i[n]]},t.log=function(...e){return process.stderr.write(r.formatWithOptions(t.inspectOpts,...e)+"\n")},t.formatArgs=function(i){let{namespace:n,useColors:r}=this;if(r){let t=this.color,r="\x1b[3"+(t<8?t:"8;5;"+t),o=`  ${r};1m${n} \u001B[0m`;i[0]=o+i[0].split("\n").join("\n"+o),i.push(r+"m+"+e.exports.humanize(this.diff)+"\x1b[0m")}else i[0]=(t.inspectOpts.hideDate?"":new Date().toISOString()+" ")+n+" "+i[0]},t.save=function(e){e?process.env.DEBUG=e:delete process.env.DEBUG},t.load=function(){return process.env.DEBUG},t.useColors=function(){return"colors"in t.inspectOpts?!!t.inspectOpts.colors:n.isatty(process.stderr.fd)},t.destroy=r.deprecate(()=>{},"Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."),t.colors=[6,2,3,4,5,1];try{let e=i(7057);e&&(e.stderr||e).level>=2&&(t.colors=[20,21,26,27,32,33,38,39,40,41,42,43,44,45,56,57,62,63,68,69,74,75,76,77,78,79,80,81,92,93,98,99,112,113,128,129,134,135,148,149,160,161,162,163,164,165,166,167,168,169,170,171,172,173,178,179,184,185,196,197,198,199,200,201,202,203,204,205,206,207,208,209,214,215,220,221])}catch(e){}t.inspectOpts=Object.keys(process.env).filter(e=>/^debug_/i.test(e)).reduce((e,t)=>{let i=t.substring(6).toLowerCase().replace(/_([a-z])/g,(e,t)=>t.toUpperCase()),n=process.env[t];return n=!!/^(yes|on|true|enabled)$/i.test(n)||!/^(no|off|false|disabled)$/i.test(n)&&("null"===n?null:Number(n)),e[i]=n,e},{}),e.exports=i(783)(t);let{formatters:o}=e.exports;o.o=function(e){return this.inspectOpts.colors=this.useColors,r.inspect(e,this.inspectOpts).split("\n").map(e=>e.trim()).join(" ")},o.O=function(e){return this.inspectOpts.colors=this.useColors,r.inspect(e,this.inspectOpts)}},7410:e=>{"use strict";e.exports=function(e,t){t||(t={}),"function"==typeof t&&(t={cmp:t});var i,n="boolean"==typeof t.cycles&&t.cycles,r=t.cmp&&(i=t.cmp,function(e){return function(t,n){return i({key:t,value:e[t]},{key:n,value:e[n]})}}),o=[];return function e(t){if(t&&t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),void 0!==t){if("number"==typeof t)return isFinite(t)?""+t:"null";if("object"!=typeof t)return JSON.stringify(t);if(Array.isArray(t)){for(i=0,s="[";i<t.length;i++)i&&(s+=","),s+=e(t[i])||"null";return s+"]"}if(null===t)return"null";if(-1!==o.indexOf(t)){if(n)return JSON.stringify("__cycle__");throw TypeError("Converting circular structure to JSON")}var i,s,a=o.push(t)-1,c=Object.keys(t).sort(r&&r(t));for(i=0,s="";i<c.length;i++){var l=c[i],u=e(t[l]);u&&(s&&(s+=","),s+=JSON.stringify(l)+":"+u)}return o.splice(a,1),"{"+s+"}"}}(e)}},2616:e=>{"use strict";e.exports=(e,t=process.argv)=>{let i=e.startsWith("-")?"":1===e.length?"-":"--",n=t.indexOf(i+e),r=t.indexOf("--");return -1!==n&&(-1===r||n<r)}},6310:function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);(!r||("get"in r?!t.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return r(t,e),t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HttpProxyAgent=void 0;let a=o(i(8216)),c=o(i(2452)),l=s(i(9092)),u=i(7702),h=i(4467),d=i(7360),p=(0,l.default)("http-proxy-agent");class y extends h.Agent{constructor(e,t){super(t),this.proxy="string"==typeof e?new d.URL(e):e,this.proxyHeaders=t?.headers??{},p("Creating new HttpProxyAgent instance: %o",this.proxy.href);let i=(this.proxy.hostname||this.proxy.host).replace(/^\[|\]$/g,""),n=this.proxy.port?parseInt(this.proxy.port,10):"https:"===this.proxy.protocol?443:80;this.connectOpts={...t?function(e,...t){let i;let n={};for(i in e)t.includes(i)||(n[i]=e[i]);return n}(t,"headers"):null,host:i,port:n}}addRequest(e,t){e._header=null,this.setRequestProps(e,t),super.addRequest(e,t)}setRequestProps(e,t){let{proxy:i}=this,n=t.secureEndpoint?"https:":"http:",r=e.getHeader("host")||"localhost",o=`${n}//${r}`,s=new d.URL(e.path,o);80!==t.port&&(s.port=String(t.port)),e.path=String(s);let a="function"==typeof this.proxyHeaders?this.proxyHeaders():{...this.proxyHeaders};if(i.username||i.password){let e=`${decodeURIComponent(i.username)}:${decodeURIComponent(i.password)}`;a["Proxy-Authorization"]=`Basic ${Buffer.from(e).toString("base64")}`}for(let t of(a["Proxy-Connection"]||(a["Proxy-Connection"]=this.keepAlive?"Keep-Alive":"close"),Object.keys(a))){let i=a[t];i&&e.setHeader(t,i)}}async connect(e,t){let i,n,r;return e._header=null,e.path.includes("://")||this.setRequestProps(e,t),p("Regenerating stored HTTP header string for request"),e._implicitHeader(),e.outputData&&e.outputData.length>0&&(p("Patching connection write() output buffer with updated header"),n=(i=e.outputData[0].data).indexOf("\r\n\r\n")+4,e.outputData[0].data=e._header+i.substring(n),p("Output buffer: %o",e.outputData[0].data)),"https:"===this.proxy.protocol?(p("Creating `tls.Socket`: %o",this.connectOpts),r=c.connect(this.connectOpts)):(p("Creating `net.Socket`: %o",this.connectOpts),r=a.connect(this.connectOpts)),await (0,u.once)(r,"connect"),r}}y.protocols=["http","https"],t.HttpProxyAgent=y},5453:function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);(!r||("get"in r?!t.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return r(t,e),t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HttpsProxyAgent=void 0;let a=o(i(8216)),c=o(i(2452)),l=s(i(7790)),u=s(i(9092)),h=i(4467),d=i(7360),p=i(1510),y=(0,u.default)("https-proxy-agent"),f=e=>void 0===e.servername&&e.host&&!a.isIP(e.host)?{...e,servername:e.host}:e;class g extends h.Agent{constructor(e,t){super(t),this.options={path:void 0},this.proxy="string"==typeof e?new d.URL(e):e,this.proxyHeaders=t?.headers??{},y("Creating new HttpsProxyAgent instance: %o",this.proxy.href);let i=(this.proxy.hostname||this.proxy.host).replace(/^\[|\]$/g,""),n=this.proxy.port?parseInt(this.proxy.port,10):"https:"===this.proxy.protocol?443:80;this.connectOpts={ALPNProtocols:["http/1.1"],...t?C(t,"headers"):null,host:i,port:n}}async connect(e,t){let i;let{proxy:n}=this;if(!t.host)throw TypeError('No "host" provided');"https:"===n.protocol?(y("Creating `tls.Socket`: %o",this.connectOpts),i=c.connect(f(this.connectOpts))):(y("Creating `net.Socket`: %o",this.connectOpts),i=a.connect(this.connectOpts));let r="function"==typeof this.proxyHeaders?this.proxyHeaders():{...this.proxyHeaders},o=a.isIPv6(t.host)?`[${t.host}]`:t.host,s=`CONNECT ${o}:${t.port} HTTP/1.1\r
`;if(n.username||n.password){let e=`${decodeURIComponent(n.username)}:${decodeURIComponent(n.password)}`;r["Proxy-Authorization"]=`Basic ${Buffer.from(e).toString("base64")}`}for(let e of(r.Host=`${o}:${t.port}`,r["Proxy-Connection"]||(r["Proxy-Connection"]=this.keepAlive?"Keep-Alive":"close"),Object.keys(r)))s+=`${e}: ${r[e]}\r
`;let u=(0,p.parseProxyResponse)(i);i.write(`${s}\r
`);let{connect:h,buffered:d}=await u;if(e.emit("proxyConnect",h),this.emit("proxyConnect",h,e),200===h.statusCode)return(e.once("socket",m),t.secureEndpoint)?(y("Upgrading socket connection to TLS"),c.connect({...C(f(t),"host","path","port"),socket:i})):i;i.destroy();let g=new a.Socket({writable:!1});return g.readable=!0,e.once("socket",e=>{y("Replaying proxy buffer for failed request"),(0,l.default)(e.listenerCount("data")>0),e.push(d),e.push(null)}),g}}function m(e){e.resume()}function C(e,...t){let i;let n={};for(i in e)t.includes(i)||(n[i]=e[i]);return n}g.protocols=["http","https"],t.HttpsProxyAgent=g},1510:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.parseProxyResponse=void 0;let r=(0,n(i(9092)).default)("https-proxy-agent:parse-proxy-response");t.parseProxyResponse=function(e){return new Promise((t,i)=>{let n=0,o=[];function s(){let c=e.read();c?function(c){o.push(c),n+=c.length;let l=Buffer.concat(o,n),u=l.indexOf("\r\n\r\n");if(-1===u){r("have not received end of HTTP headers yet..."),s();return}let h=l.slice(0,u).toString("ascii").split("\r\n"),d=h.shift();if(!d)return e.destroy(),i(Error("No header received from proxy CONNECT response"));let p=d.split(" "),y=+p[1],f=p.slice(2).join(" "),g={};for(let t of h){if(!t)continue;let n=t.indexOf(":");if(-1===n)return e.destroy(),i(Error(`Invalid header from proxy CONNECT response: "${t}"`));let r=t.slice(0,n).toLowerCase(),o=t.slice(n+1).trimStart(),s=g[r];"string"==typeof s?g[r]=[s,o]:Array.isArray(s)?s.push(o):g[r]=o}r("got proxy server response: %o %o",d,g),a(),t({connect:{statusCode:y,statusText:f,headers:g},buffered:l})}(c):e.once("readable",s)}function a(){e.removeListener("end",c),e.removeListener("error",l),e.removeListener("readable",s)}function c(){a(),r("onend"),i(Error("Proxy connection ended before receiving CONNECT response"))}function l(e){a(),r("onerror %o",e),i(e)}e.on("error",l),e.on("end",c),s()})}},3974:e=>{function t(e,t,i,n){return Math.round(e/i)+" "+n+(t>=1.5*i?"s":"")}e.exports=function(e,i){i=i||{};var n,r,o=typeof e;if("string"===o&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var i=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*i;case"weeks":case"week":case"w":return 6048e5*i;case"days":case"day":case"d":return 864e5*i;case"hours":case"hour":case"hrs":case"hr":case"h":return 36e5*i;case"minutes":case"minute":case"mins":case"min":case"m":return 6e4*i;case"seconds":case"second":case"secs":case"sec":case"s":return 1e3*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:return}}}}(e);if("number"===o&&isFinite(e))return i.long?(n=Math.abs(e))>=864e5?t(e,n,864e5,"day"):n>=36e5?t(e,n,36e5,"hour"):n>=6e4?t(e,n,6e4,"minute"):n>=1e3?t(e,n,1e3,"second"):e+" ms":(r=Math.abs(e))>=864e5?Math.round(e/864e5)+"d":r>=36e5?Math.round(e/36e5)+"h":r>=6e4?Math.round(e/6e4)+"m":r>=1e3?Math.round(e/1e3)+"s":e+"ms";throw Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},9119:e=>{function t(e){this._comparator=e||t.DEFAULT_COMPARATOR,this._elements=[]}e.exports=t,t.DEFAULT_COMPARATOR=function(e,t){return"number"==typeof e&&"number"==typeof t?e-t:(e=e.toString())==(t=t.toString())?0:e>t?1:-1},t.prototype.isEmpty=function(){return 0===this.size()},t.prototype.peek=function(){if(this.isEmpty())throw Error("PriorityQueue is empty");return this._elements[0]},t.prototype.deq=function(){var e=this.peek(),t=this._elements.pop(),i=this.size();if(0===i)return e;this._elements[0]=t;for(var n=0;n<i;){var r=n,o=2*n+1,s=2*n+2;if(o<i&&this._compare(o,r)>=0&&(r=o),s<i&&this._compare(s,r)>=0&&(r=s),r===n)break;this._swap(r,n),n=r}return e},t.prototype.enq=function(e){for(var t=this._elements.push(e),i=t-1;i>0;){var n=Math.floor((i-1)/2);if(0>=this._compare(i,n))break;this._swap(n,i),i=n}return t},t.prototype.size=function(){return this._elements.length},t.prototype.forEach=function(e){return this._elements.forEach(e)},t.prototype._compare=function(e,t){return this._comparator(this._elements[e],this._elements[t])},t.prototype._swap=function(e,t){var i=this._elements[e];this._elements[e]=this._elements[t],this._elements[t]=i}},1552:function(e){var t;t=function(e){setTimeout(e,0)},"undefined"!=typeof process&&process&&"function"==typeof process.nextTick&&(t=process.nextTick),e.exports=function(e){var i={capacity:e||1,current:0,queue:[],firstHere:!1,take:function(){if(!1===i.firstHere){i.current++,i.firstHere=!0;var e=1}else var e=0;var t={n:1};"function"==typeof arguments[0]?t.task=arguments[0]:t.n=arguments[0],arguments.length>=2&&("function"==typeof arguments[1]?t.task=arguments[1]:t.n=arguments[1]);var n=t.task;if(t.task=function(){n(i.leave)},i.current+t.n-e>i.capacity)return 1===e&&(i.current--,i.firstHere=!1),i.queue.push(t);i.current+=t.n-e,t.task(i.leave),1===e&&(i.firstHere=!1)},leave:function(e){if(e=e||1,i.current-=e,!i.queue.length){if(i.current<0)throw Error("leave called too many times.");return}var n=i.queue[0];n.n+i.current>i.capacity||(i.queue.shift(),i.current+=n.n,t(n.task))},available:function(e){return e=e||1,i.current+e<=i.capacity}};return i}},7057:(e,t,i)=>{"use strict";let n;let r=i(9801),o=i(4175),s=i(2616),{env:a}=process;function c(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}function l(e,t){if(0===n)return 0;if(s("color=16m")||s("color=full")||s("color=truecolor"))return 3;if(s("color=256"))return 2;if(e&&!t&&void 0===n)return 0;let i=n||0;if("dumb"===a.TERM)return i;if("win32"===process.platform){let e=r.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}if("CI"in a)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE"].some(e=>e in a)||"codeship"===a.CI_NAME?1:i;if("TEAMCITY_VERSION"in a)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(a.TEAMCITY_VERSION)?1:0;if("truecolor"===a.COLORTERM)return 3;if("TERM_PROGRAM"in a){let e=parseInt((a.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(a.TERM_PROGRAM){case"iTerm.app":return e>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(a.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(a.TERM)||"COLORTERM"in a?1:i}s("no-color")||s("no-colors")||s("color=false")||s("color=never")?n=0:(s("color")||s("colors")||s("color=true")||s("color=always"))&&(n=1),"FORCE_COLOR"in a&&(n="true"===a.FORCE_COLOR?1:"false"===a.FORCE_COLOR?0:0===a.FORCE_COLOR.length?1:Math.min(parseInt(a.FORCE_COLOR,10),3)),e.exports={supportsColor:function(e){return c(l(e,e&&e.isTTY))},stdout:c(l(!0,o.isatty(1))),stderr:c(l(!0,o.isatty(2)))}},791:(e,t)=>{"use strict";t.S=void 0,t.S={instrumenterImplementation:void 0}},8657:(e,t,i)=>{"use strict";let n,r,o;i.d(t,{gT:()=>s,Pi:()=>oM,iQ:()=>d});let s={HttpHeaders:{Authorization:"authorization",ETag:"etag",MethodOverride:"X-HTTP-Method",Slug:"Slug",ContentType:"Content-Type",LastModified:"Last-Modified",ContentEncoding:"Content-Encoding",CharacterSet:"CharacterSet",UserAgent:"User-Agent",CustomUserAgent:"x-ms-useragent",IfModifiedSince:"If-Modified-Since",IfMatch:"If-Match",IfNoneMatch:"If-None-Match",ContentLength:"Content-Length",AcceptEncoding:"Accept-Encoding",KeepAlive:"Keep-Alive",CacheControl:"Cache-Control",TransferEncoding:"Transfer-Encoding",ContentLanguage:"Content-Language",ContentLocation:"Content-Location",ContentMd5:"Content-Md5",ContentRange:"Content-Range",Accept:"Accept",AcceptCharset:"Accept-Charset",AcceptLanguage:"Accept-Language",IfRange:"If-Range",IfUnmodifiedSince:"If-Unmodified-Since",MaxForwards:"Max-Forwards",ProxyAuthorization:"Proxy-Authorization",AcceptRanges:"Accept-Ranges",ProxyAuthenticate:"Proxy-Authenticate",RetryAfter:"Retry-After",SetCookie:"Set-Cookie",WwwAuthenticate:"Www-Authenticate",Origin:"Origin",Host:"Host",AccessControlAllowOrigin:"Access-Control-Allow-Origin",AccessControlAllowHeaders:"Access-Control-Allow-Headers",KeyValueEncodingFormat:"application/x-www-form-urlencoded",WrapAssertionFormat:"wrap_assertion_format",WrapAssertion:"wrap_assertion",WrapScope:"wrap_scope",SimpleToken:"SWT",HttpDate:"date",Prefer:"Prefer",Location:"Location",Referer:"referer",A_IM:"A-IM",PreferReturnMinimal:"return=minimal",Query:"x-ms-documentdb-query",IsQuery:"x-ms-documentdb-isquery",IsQueryPlan:"x-ms-cosmos-is-query-plan-request",SupportedQueryFeatures:"x-ms-cosmos-supported-query-features",QueryVersion:"x-ms-cosmos-query-version",Continuation:"x-ms-continuation",ContinuationToken:"x-ms-continuation-token",PageSize:"x-ms-max-item-count",ItemCount:"x-ms-item-count",ChangeFeedWireFormatVersion:"x-ms-cosmos-changefeed-wire-format-version",ActivityId:"x-ms-activity-id",CorrelatedActivityId:"x-ms-cosmos-correlated-activityid",PreTriggerInclude:"x-ms-documentdb-pre-trigger-include",PreTriggerExclude:"x-ms-documentdb-pre-trigger-exclude",PostTriggerInclude:"x-ms-documentdb-post-trigger-include",PostTriggerExclude:"x-ms-documentdb-post-trigger-exclude",IndexingDirective:"x-ms-indexing-directive",SessionToken:"x-ms-session-token",ConsistencyLevel:"x-ms-consistency-level",XDate:"x-ms-date",CollectionPartitionInfo:"x-ms-collection-partition-info",CollectionServiceInfo:"x-ms-collection-service-info",RetryAfterInMilliseconds:"x-ms-retry-after-ms",RetryAfterInMs:"x-ms-retry-after-ms",IsFeedUnfiltered:"x-ms-is-feed-unfiltered",ResourceTokenExpiry:"x-ms-documentdb-expiry-seconds",EnableScanInQuery:"x-ms-documentdb-query-enable-scan",EmitVerboseTracesInQuery:"x-ms-documentdb-query-emit-traces",EnableCrossPartitionQuery:"x-ms-documentdb-query-enablecrosspartition",ParallelizeCrossPartitionQuery:"x-ms-documentdb-query-parallelizecrosspartitionquery",ResponseContinuationTokenLimitInKB:"x-ms-documentdb-responsecontinuationtokenlimitinkb",SDKSupportedCapabilities:"x-ms-cosmos-sdk-supportedcapabilities",PopulateQueryMetrics:"x-ms-documentdb-populatequerymetrics",QueryMetrics:"x-ms-documentdb-query-metrics",PopulateIndexMetrics:"x-ms-cosmos-populateindexmetrics-V2",IndexUtilization:"x-ms-cosmos-index-utilization",Version:"x-ms-version",OwnerFullName:"x-ms-alt-content-path",OwnerId:"x-ms-content-path",PartitionKey:"x-ms-documentdb-partitionkey",PartitionKeyRangeID:"x-ms-documentdb-partitionkeyrangeid",StartEpk:"x-ms-start-epk",EndEpk:"x-ms-end-epk",ReadFeedKeyType:"x-ms-read-key-type",MaxEntityCount:"x-ms-root-entity-max-count",CurrentEntityCount:"x-ms-root-entity-current-count",CollectionQuotaInMb:"x-ms-collection-quota-mb",CollectionCurrentUsageInMb:"x-ms-collection-usage-mb",MaxMediaStorageUsageInMB:"x-ms-max-media-storage-usage-mb",CurrentMediaStorageUsageInMB:"x-ms-media-storage-usage-mb",RequestCharge:"x-ms-request-charge",PopulateQuotaInfo:"x-ms-documentdb-populatequotainfo",MaxResourceQuota:"x-ms-resource-quota",OfferType:"x-ms-offer-type",OfferThroughput:"x-ms-offer-throughput",AutoscaleSettings:"x-ms-cosmos-offer-autopilot-settings",DisableRUPerMinuteUsage:"x-ms-documentdb-disable-ru-per-minute-usage",IsRUPerMinuteUsed:"x-ms-documentdb-is-ru-per-minute-used",OfferIsRUPerMinuteThroughputEnabled:"x-ms-offer-is-ru-per-minute-throughput-enabled",IndexTransformationProgress:"x-ms-documentdb-collection-index-transformation-progress",LazyIndexingProgress:"x-ms-documentdb-collection-lazy-indexing-progress",IsUpsert:"x-ms-documentdb-is-upsert",SubStatus:"x-ms-substatus",EnableScriptLogging:"x-ms-documentdb-script-enable-logging",ScriptLogResults:"x-ms-documentdb-script-log-results",ALLOW_MULTIPLE_WRITES:"x-ms-cosmos-allow-tentative-writes",IsBatchRequest:"x-ms-cosmos-is-batch-request",IsBatchAtomic:"x-ms-cosmos-batch-atomic",BatchContinueOnError:"x-ms-cosmos-batch-continue-on-error",DedicatedGatewayPerRequestCacheStaleness:"x-ms-dedicatedgateway-max-age",DedicatedGatewayPerRequestBypassCache:"x-ms-dedicatedgateway-bypass-cache",ForceRefresh:"x-ms-force-refresh",PriorityLevel:"x-ms-cosmos-priority-level",ThroughputBucket:"x-ms-cosmos-throughput-bucket",IsClientEncryptedHeader:"x-ms-cosmos-is-client-encrypted",IntendedCollectionHeader:"x-ms-cosmos-intended-collection-rid",DatabaseRidHeader:"x-ms-cosmos-database-rid",AllowCachedReadsHeader:"x-ms-cosmos-allow-cachedreads"},ThrottledRequestMaxRetryAttemptCount:9,ThrottledRequestMaxWaitTimeInSeconds:30,ThrottledRequestFixedRetryIntervalInMs:0,WritableLocations:"writableLocations",ReadableLocations:"readableLocations",LocationUnavailableExpirationTimeInMs:3e5,StalePartitionUnavailabilityRefreshIntervalInMs:6e4,AllowedPartitionUnavailabilityDurationInMs:3e5,ReadRequestFailureCountThreshold:10,WriteRequestFailureCountThreshold:5,ConsecutiveFailureCountResetIntervalInMS:6e4,ENABLE_MULTIPLE_WRITABLE_LOCATIONS:"enableMultipleWriteLocations",EnablePerPartitionFailover:"enablePerPartitionFailoverBehavior",DefaultUnavailableLocationExpirationTimeMS:3e5,ThrottleRetryCount:"x-ms-throttle-retry-count",ThrottleRetryWaitTimeInMs:"x-ms-throttle-retry-wait-time-ms",CurrentVersion:"2020-07-15",AzureNamespace:"Azure.Cosmos",AzurePackageName:"@azure/cosmos",SDKName:"azure-cosmos-js",SDKVersion:"4.8.0",CosmosDbDiagnosticLevelEnvVarName:"AZURE_COSMOSDB_DIAGNOSTICS_LEVEL",DefaultMaxBulkRequestBodySizeInBytes:220201,MaxBulkOperationsCount:100,BulkMaxDegreeOfConcurrency:20,Encryption:{DiagnosticsDecryptOperation:"Decrypt",DiagnosticsDuration:"Duration in milliseconds",DiagnosticsEncryptionDiagnostics:"EncryptionDiagnostics",DiagnosticsEncryptOperation:"Encrypt",DiagnosticsPropertiesEncryptedCount:"Properties Encrypted Count",DiagnosticsPropertiesDecryptedCount:"Properties Decrypted Count",DiagnosticsStartTime:"Start time"},Quota:{CollectionSize:"collectionSize"},Path:{Root:"/",DatabasesPathSegment:"dbs",CollectionsPathSegment:"colls",UsersPathSegment:"users",DocumentsPathSegment:"docs",PermissionsPathSegment:"permissions",StoredProceduresPathSegment:"sprocs",TriggersPathSegment:"triggers",UserDefinedFunctionsPathSegment:"udfs",ConflictsPathSegment:"conflicts",AttachmentsPathSegment:"attachments",PartitionKeyRangesPathSegment:"pkranges",SchemasPathSegment:"schemas",OffersPathSegment:"offers",TopologyPathSegment:"topology",DatabaseAccountPathSegment:"databaseaccount"},PartitionKeyRange:{MinInclusive:"minInclusive",MaxExclusive:"maxExclusive",Id:"id"},QueryRangeConstants:{MinInclusive:"minInclusive",MaxExclusive:"maxExclusive",min:"min"},EffectiveParitionKeyConstants:{MinimumInclusiveEffectivePartitionKey:"",MaximumExclusiveEffectivePartitionKey:"FF"},EffectivePartitionKeyConstants:{MinimumInclusiveEffectivePartitionKey:"",MaximumExclusiveEffectivePartitionKey:"FF"},AllVersionsAndDeletesChangeFeedWireFormatVersion:"2021-09-15",ChangeFeedIfNoneMatchStartFromNowHeader:"*",DefaultEncryptionCacheTimeToLiveInSeconds:7200,EncryptionCacheRefreshIntervalInMs:6e4,RequestTimeoutForReadsInMs:2e3},a="type=aad&ver=1.0&sig=";(function(e){e.none="",e.database="dbs",e.offer="offers",e.user="users",e.permission="permissions",e.container="colls",e.conflicts="conflicts",e.sproc="sprocs",e.udf="udfs",e.trigger="triggers",e.item="docs",e.pkranges="pkranges",e.partitionkey="partitionKey",e.clientencryptionkey="clientencryptionkeys"})(K||(K={})),function(e){e.get="GET",e.patch="PATCH",e.post="POST",e.put="PUT",e.delete="DELETE"}(H||(H={})),function(e){e.Create="create",e.Replace="replace",e.Upsert="upsert",e.Delete="delete",e.Read="read",e.Query="query",e.Execute="execute",e.Batch="batch",e.Patch="patch"}(q||(q={})),function(e){e.PrimaryMaster="PRIMARY_MASTER",e.SecondaryMaster="SECONDARY_MASTER",e.PrimaryReadOnly="PRIMARY_READONLY",e.SecondaryReadOnly="SECONDARY_READONLY"}(_||(_={})),function(e){e.Item="ITEM",e.StoredProcedure="STORED_PROCEDURE",e.UserDefinedFunction="USER_DEFINED_FUNCTION",e.Trigger="TRIGGER"}(N||(N={})),function(e){e[e.ScopeAccountReadValue=1]="ScopeAccountReadValue",e[e.ScopeAccountListDatabasesValue=2]="ScopeAccountListDatabasesValue",e[e.ScopeDatabaseReadValue=4]="ScopeDatabaseReadValue",e[e.ScopeDatabaseReadOfferValue=8]="ScopeDatabaseReadOfferValue",e[e.ScopeDatabaseListContainerValue=16]="ScopeDatabaseListContainerValue",e[e.ScopeContainerReadValue=32]="ScopeContainerReadValue",e[e.ScopeContainerReadOfferValue=64]="ScopeContainerReadOfferValue",e[e.ScopeAccountCreateDatabasesValue=1]="ScopeAccountCreateDatabasesValue",e[e.ScopeAccountDeleteDatabasesValue=2]="ScopeAccountDeleteDatabasesValue",e[e.ScopeDatabaseDeleteValue=4]="ScopeDatabaseDeleteValue",e[e.ScopeDatabaseReplaceOfferValue=8]="ScopeDatabaseReplaceOfferValue",e[e.ScopeDatabaseCreateContainerValue=16]="ScopeDatabaseCreateContainerValue",e[e.ScopeDatabaseDeleteContainerValue=32]="ScopeDatabaseDeleteContainerValue",e[e.ScopeContainerReplaceValue=64]="ScopeContainerReplaceValue",e[e.ScopeContainerDeleteValue=128]="ScopeContainerDeleteValue",e[e.ScopeContainerReplaceOfferValue=256]="ScopeContainerReplaceOfferValue",e[e.ScopeAccountReadAllAccessValue=65535]="ScopeAccountReadAllAccessValue",e[e.ScopeDatabaseReadAllAccessValue=124]="ScopeDatabaseReadAllAccessValue",e[e.ScopeContainersReadAllAccessValue=96]="ScopeContainersReadAllAccessValue",e[e.ScopeAccountWriteAllAccessValue=65535]="ScopeAccountWriteAllAccessValue",e[e.ScopeDatabaseWriteAllAccessValue=508]="ScopeDatabaseWriteAllAccessValue",e[e.ScopeContainersWriteAllAccessValue=448]="ScopeContainersWriteAllAccessValue",e[e.ScopeContainerExecuteQueriesValue=1]="ScopeContainerExecuteQueriesValue",e[e.ScopeContainerReadFeedsValue=2]="ScopeContainerReadFeedsValue",e[e.ScopeContainerReadStoredProceduresValue=4]="ScopeContainerReadStoredProceduresValue",e[e.ScopeContainerReadUserDefinedFunctionsValue=8]="ScopeContainerReadUserDefinedFunctionsValue",e[e.ScopeContainerReadTriggersValue=16]="ScopeContainerReadTriggersValue",e[e.ScopeContainerReadConflictsValue=32]="ScopeContainerReadConflictsValue",e[e.ScopeItemReadValue=64]="ScopeItemReadValue",e[e.ScopeStoredProcedureReadValue=128]="ScopeStoredProcedureReadValue",e[e.ScopeUserDefinedFunctionReadValue=256]="ScopeUserDefinedFunctionReadValue",e[e.ScopeTriggerReadValue=512]="ScopeTriggerReadValue",e[e.ScopeContainerCreateItemsValue=1]="ScopeContainerCreateItemsValue",e[e.ScopeContainerReplaceItemsValue=2]="ScopeContainerReplaceItemsValue",e[e.ScopeContainerUpsertItemsValue=4]="ScopeContainerUpsertItemsValue",e[e.ScopeContainerDeleteItemsValue=8]="ScopeContainerDeleteItemsValue",e[e.ScopeContainerCreateStoredProceduresValue=16]="ScopeContainerCreateStoredProceduresValue",e[e.ScopeContainerReplaceStoredProceduresValue=32]="ScopeContainerReplaceStoredProceduresValue",e[e.ScopeContainerDeleteStoredProceduresValue=64]="ScopeContainerDeleteStoredProceduresValue",e[e.ScopeContainerExecuteStoredProceduresValue=128]="ScopeContainerExecuteStoredProceduresValue",e[e.ScopeContainerCreateTriggersValue=256]="ScopeContainerCreateTriggersValue",e[e.ScopeContainerReplaceTriggersValue=512]="ScopeContainerReplaceTriggersValue",e[e.ScopeContainerDeleteTriggersValue=1024]="ScopeContainerDeleteTriggersValue",e[e.ScopeContainerCreateUserDefinedFunctionsValue=2048]="ScopeContainerCreateUserDefinedFunctionsValue",e[e.ScopeContainerReplaceUserDefinedFunctionsValue=4096]="ScopeContainerReplaceUserDefinedFunctionsValue",e[e.ScopeContainerDeleteUserDefinedFunctionSValue=8192]="ScopeContainerDeleteUserDefinedFunctionSValue",e[e.ScopeContainerDeleteCONFLICTSValue=16384]="ScopeContainerDeleteCONFLICTSValue",e[e.ScopeItemReplaceValue=65536]="ScopeItemReplaceValue",e[e.ScopeItemUpsertValue=131072]="ScopeItemUpsertValue",e[e.ScopeItemDeleteValue=262144]="ScopeItemDeleteValue",e[e.ScopeStoredProcedureReplaceValue=1048576]="ScopeStoredProcedureReplaceValue",e[e.ScopeStoredProcedureDeleteValue=2097152]="ScopeStoredProcedureDeleteValue",e[e.ScopeStoredProcedureExecuteValue=4194304]="ScopeStoredProcedureExecuteValue",e[e.ScopeUserDefinedFunctionReplaceValue=8388608]="ScopeUserDefinedFunctionReplaceValue",e[e.ScopeUserDefinedFunctionDeleteValue=16777216]="ScopeUserDefinedFunctionDeleteValue",e[e.ScopeTriggerReplaceValue=33554432]="ScopeTriggerReplaceValue",e[e.ScopeTriggerDeleteValue=67108864]="ScopeTriggerDeleteValue",e[e.ScopeContainerReadAllAccessValue=4294967295]="ScopeContainerReadAllAccessValue",e[e.ScopeItemReadAllAccessValue=65]="ScopeItemReadAllAccessValue",e[e.ScopeContainerWriteAllAccessValue=4294967295]="ScopeContainerWriteAllAccessValue",e[e.ScopeItemWriteAllAccessValue=458767]="ScopeItemWriteAllAccessValue",e[e.NoneValue=0]="NoneValue"}(U||(U={})),function(e){e[e.ContainerCreateItems=1]="ContainerCreateItems",e[e.ContainerReplaceItems=2]="ContainerReplaceItems",e[e.ContainerUpsertItems=4]="ContainerUpsertItems",e[e.ContainerDeleteItems=128]="ContainerDeleteItems",e[e.ContainerExecuteQueries=1]="ContainerExecuteQueries",e[e.ContainerReadFeeds=2]="ContainerReadFeeds",e[e.ContainerCreateStoreProcedure=16]="ContainerCreateStoreProcedure",e[e.ContainerReadStoreProcedure=4]="ContainerReadStoreProcedure",e[e.ContainerReplaceStoreProcedure=32]="ContainerReplaceStoreProcedure",e[e.ContainerDeleteStoreProcedure=64]="ContainerDeleteStoreProcedure",e[e.ContainerCreateTriggers=256]="ContainerCreateTriggers",e[e.ContainerReadTriggers=16]="ContainerReadTriggers",e[e.ContainerReplaceTriggers=512]="ContainerReplaceTriggers",e[e.ContainerDeleteTriggers=1024]="ContainerDeleteTriggers",e[e.ContainerCreateUserDefinedFunctions=2048]="ContainerCreateUserDefinedFunctions",e[e.ContainerReadUserDefinedFunctions=8]="ContainerReadUserDefinedFunctions",e[e.ContainerReplaceUserDefinedFunctions=4096]="ContainerReplaceUserDefinedFunctions",e[e.ContainerDeleteUserDefinedFunctions=8192]="ContainerDeleteUserDefinedFunctions",e[e.ContainerExecuteStoredProcedure=128]="ContainerExecuteStoredProcedure",e[e.ContainerReadConflicts=32]="ContainerReadConflicts",e[e.ContainerDeleteConflicts=16384]="ContainerDeleteConflicts",e[e.ContainerReadAny=64]="ContainerReadAny",e[e.ContainerFullAccess=4294967295]="ContainerFullAccess",e[e.ItemReadAny=65536]="ItemReadAny",e[e.ItemFullAccess=65]="ItemFullAccess",e[e.ItemRead=64]="ItemRead",e[e.ItemReplace=65536]="ItemReplace",e[e.ItemUpsert=131072]="ItemUpsert",e[e.ItemDelete=262144]="ItemDelete",e[e.StoreProcedureRead=128]="StoreProcedureRead",e[e.StoreProcedureReplace=1048576]="StoreProcedureReplace",e[e.StoreProcedureDelete=2097152]="StoreProcedureDelete",e[e.StoreProcedureExecute=4194304]="StoreProcedureExecute",e[e.UserDefinedFuntionRead=256]="UserDefinedFuntionRead",e[e.UserDefinedFuntionReplace=8388608]="UserDefinedFuntionReplace",e[e.UserDefinedFuntionDelete=16777216]="UserDefinedFuntionDelete",e[e.TriggerRead=512]="TriggerRead",e[e.TriggerReplace=33554432]="TriggerReplace",e[e.TriggerDelete=67108864]="TriggerDelete"}(z||(z={})),function(e){e.NonValueAggregate="NonValueAggregate",e.Aggregate="Aggregate",e.Distinct="Distinct",e.MultipleOrderBy="MultipleOrderBy",e.OffsetAndLimit="OffsetAndLimit",e.OrderBy="OrderBy",e.Top="Top",e.CompositeAggregate="CompositeAggregate",e.GroupBy="GroupBy",e.MultipleAggregates="MultipleAggregates",e.NonStreamingOrderBy="NonStreamingOrderBy",e.ListAndSetAggregate="ListAndSetAggregate",e.CountIf="CountIf",e.HybridSearch="HybridSearch",e.WeightedRankFusion="WeightedRankFusion",e.HybridSearchSkipOrderByRewrite="HybridSearchSkipOrderByRewrite"}(Q||(Q={})),function(e){e[e.PartitionMerge=1]="PartitionMerge"}(V||(V={})),function(e){e[e.Available=0]="Available",e[e.Unavailable=1]="Unavailable"}(W||(W={})),function(e){e[e.PerPartitionAutomaticFailover=1]="PerPartitionAutomaticFailover",e[e.PerPartitionCircuitBreaker=2]="PerPartitionCircuitBreaker"}($||($={}));class c{deserialize(e){if(!e||e.length<8)throw Error("Invalid byte array for deserialization");return Number(e.readBigInt64LE(0))}serialize(e){let t=BigInt(e),i=Buffer.alloc(8);return i.writeBigInt64LE(t,0),i}}class l{deserialize(e){if(!e||e.length<8)throw Error("Invalid byte array for deserialization");return e.readDoubleLE(0)}serialize(e){if(!Number.isFinite(e))throw Error("Value is out of range");let t=Buffer.alloc(8);return t.writeDoubleLE(e,0),t}}class u{static characterEncoding="utf-8";deserialize(e){return e.toString(u.characterEncoding)}serialize(e){return Buffer.from(e,u.characterEncoding)}}class h{serialize(e){let t=Buffer.alloc(8);return t.writeBigInt64LE(BigInt(e?1:0),0),t}deserialize(e){if(!e||e.length<1)throw Error("Invalid byte array for deserialization");return!!e[0]}}(function(e){e.DETERMINISTIC="Deterministic",e.RANDOMIZED="Randomized"})(j||(j={})),function(e){e[e.Null=1]="Null",e[e.Boolean=2]="Boolean",e[e.Double=3]="Double",e[e.Long=4]="Long",e[e.String=5]="String"}(G||(G={}));class d extends Error{code;substatus;body;headers;activityId;retryAfterInMs;retryAfterInMilliseconds;diagnostics;requestCharge}let p=RegExp("^[/]+"),y=RegExp("[/]+$"),f=RegExp("[/\\\\?#]"),g=RegExp("[/\\\\#]");function m(e){let t,i;if(0===e.length)return{type:void 0,objectBody:void 0};"/"!==e[e.length-1]&&(e+="/"),"/"!==e[0]&&(e="/"+e);let n=e.split("/");return n.length%2==0?(t=n[n.length-2],i=n[n.length-3]):(t=n[n.length-3],i=n[n.length-2]),{type:i,objectBody:{id:t,self:e}}}function C(e){return e===q.Read||e===q.Query}function E(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}function w(e){return e.split("/").slice(0,4).join("/")}function R(e){return e.replace(p,"").replace(y,"")}function x(e,t){if(e.id){if("string"!=typeof e.id)return t.message="Id must be a string.",!1;if(-1!==e.id.indexOf("/")||-1!==e.id.indexOf("\\")||-1!==e.id.indexOf("?")||-1!==e.id.indexOf("#"))return t.message="Id contains illegal chars.",!1;if(" "===e.id[e.id.length-1])return t.message="Id ends with a space.",!1}return!0}function b(e,t){if(e.id){if("string"!=typeof e.id)return t.message="Id must be a string.",!1;if(-1!==e.id.indexOf("/")||-1!==e.id.indexOf("\\")||-1!==e.id.indexOf("#"))return t.message="Id contains illegal chars.",!1}return!0}function v(e){return e=R(e)}function T(e,t){return(e=R(e),t)?"/"+encodeURI(e)+"/"+t:"/"+encodeURI(e)}function S(e){return!e||/^\s*$/.test(e)}function I(e){if("string"!=typeof e)throw Error("invalid input: input is not string");return e.replace(p,"").replace(y,"")}function P(e){if("string"!=typeof e||S(e))throw Error("Resource ID must be a string and cannot be undefined, null or empty");if(f.test(e))throw Error("Illegal characters ['/', '\\', '#', '?'] cannot be used in Resource ID");return!0}function A(e){let{AccountEndpoint:t,AccountKey:i}=e.split(";").reduce((e,t)=>{let[i,...n]=t.split("=");return e[i]=n.join("="),e},{});if(!t||!i)throw Error("Could not parse the provided connection string");return{endpoint:t,key:i}}function M(e){return JSON.parse(JSON.stringify(e,(e,t)=>{if("bigint"==typeof t)throw Error("BigInt type is not supported");return t}))}function D(e){let t=e.indexOf("/",e.indexOf("/")+1);return -1===t?e:e.substring(0,t)}let k={Ok:200,MultiStatus:207,NotModified:304,BadRequest:400,Forbidden:403,NotFound:404,Conflict:409,Gone:410,PreconditionFailed:412,RequestEntityTooLarge:413,FailedDependency:424,TooManyRequests:429,InternalServerError:500,ServiceUnavailable:503,ENOTFOUND:"ENOTFOUND"},O={Unknown:0,IncorrectContainerRidSubstatus:1024,PartitionKeyMismatch:1001,PartitionKeyRangeGone:1002,CompletingSplit:1007,CompletingPartitionMigration:1008,NameCacheIsStale:1e3,ReadSessionNotAvailable:1002,WriteForbidden:3,DatabaseAccountNotFound:1008};function L(e){return P(e=I(e)),s.Path.DatabasesPathSegment+"/"+e}function F(e,t){return P(t=I(t)),L(e)+"/"+s.Path.CollectionsPathSegment+"/"+t}function B(e,t){return P(t=I(t)),L(e)+"/"+s.Path.UsersPathSegment+"/"+t}var K,H,q,_,N,U,z,Q,V,W,$,j,G,J,Y,Z,X,ee,et,ei,en,er,eo,es,ea,ec,el,eu,eh,ed,ep,ey,ef,eg,em,eC,eE,ew,eR,ex,eb,ev,eT,eS,eI,eP,eA,eM,eD,ek,eO,eL,eF,eB,eK=i(6005);async function eH(e,t){return(0,eK.createHmac)("sha256",Buffer.from(e,"base64")).update(t).digest("base64")}async function eq(e,t,i=K.none,n="",r=new Date){if(e.startsWith("type=sas&"))return{[s.HttpHeaders.Authorization]:encodeURIComponent(e),[s.HttpHeaders.XDate]:r.toUTCString()};let o=await e_(e,t,i,n,r);return{[s.HttpHeaders.Authorization]:o,[s.HttpHeaders.XDate]:r.toUTCString()}}async function e_(e,t,i,n="",r=new Date){let o=t.toLowerCase()+"\n"+i.toLowerCase()+"\n"+n+"\n"+r.toUTCString().toLowerCase()+"\n\n";return encodeURIComponent("type=master&ver=1.0&sig="+await eH(e,o))}async function eN(e,t,i,n,r,o){if(e.permissionFeed)for(let t of(e.resourceTokens={},e.permissionFeed)){let i=function(e){if(!e||"string"!=typeof e)return null;let t=I(e).split("/");return t.length%2!=0?null:t[t.length-1]}(t.resource);if(!i)throw Error(`authorization error: ${i} \
                          is an invalid resourceId in permissionFeed`);e.resourceTokens[i]=t._token}e.key?await eU(t,n,r,o,e.key):e.resourceTokens?o[s.HttpHeaders.Authorization]=encodeURIComponent(function(e,t,i){if(e&&Object.keys(e).length>0){if(!t&&!i)return e[Object.keys(e)[0]];if(i&&e[i])return e[i];if(!t||t.length<4)return null;let n=(t=I(t))&&t.split("/")||[];if(6===n.length){let t=n.slice(0,4).map(decodeURIComponent).join("/");if(e[t])return e[t]}let r=n.length%2==0?n.length-1:n.length-2;for(;r>0;r-=2){let t=decodeURI(n[r]);if(e[t])return e[t]}}return null}(e.resourceTokens,i,n)):e.tokenProvider&&(o[s.HttpHeaders.Authorization]=encodeURIComponent(await e.tokenProvider({verb:t,path:i,resourceId:n,resourceType:r,headers:o})))}async function eU(e,t,i,n,r){i===K.offer&&(t=t&&t.toLowerCase()),n=Object.assign(n,await eq(r,e,i,t))}var ez=i(612),eQ=i(7261),eV=i(7742);let eW="undefined"!=typeof process&&process.env&&process.env.DEBUG||void 0,e$=[],ej=[],eG=[];eW&&eY(eW);let eJ=Object.assign(e=>e0(e),{enable:eY,enabled:eZ,disable:function(){let e=n||"";return eY(""),e},log:function(e,...t){eV.stderr.write(`${eQ.format(e,...t)}${ez.EOL}`)}});function eY(e){for(let t of(n=e,e$=[],ej=[],e.split(",").map(e=>e.trim())))t.startsWith("-")?ej.push(t.substring(1)):e$.push(t);for(let e of eG)e.enabled=eZ(e.namespace)}function eZ(e){if(e.endsWith("*"))return!0;for(let t of ej)if(eX(e,t))return!1;for(let t of e$)if(eX(e,t))return!0;return!1}function eX(e,t){if(-1===t.indexOf("*"))return e===t;let i=t;if(-1!==t.indexOf("**")){let e=[],n="";for(let i of t)("*"!==i||"*"!==n)&&(n=i,e.push(i));i=e.join("")}let n=0,r=0,o=i.length,s=e.length,a=-1,c=-1;for(;n<s&&r<o;){if("*"===i[r]){if(a=r,++r===o)return!0;for(;e[n]!==i[r];)if(++n===s)return!1;c=n,n++,r++;continue}if(i[r]===e[n])r++,n++;else{if(!(a>=0)||(r=a+1,(n=c+1)===s))return!1;for(;e[n]!==i[r];)if(++n===s)return!1;c=n,n++,r++;continue}}let l=n===e.length,u=r===i.length,h=r===i.length-1&&"*"===i[r];return l&&(u||h)}function e0(e){let t=Object.assign(function(...i){t.enabled&&(i.length>0&&(i[0]=`${e} ${i[0]}`),t.log(...i))},{enabled:eZ(e),destroy:e1,log:eJ.log,namespace:e,extend:e2});return eG.push(t),t}function e1(){let e=eG.indexOf(this);return e>=0&&(eG.splice(e,1),!0)}function e2(e){let t=e0(`${this.namespace}:${e}`);return t.log=this.log,t}let e6=["verbose","info","warning","error"],e3={verbose:400,info:300,warning:200,error:100};function e5(e,t){t.log=(...t)=>{e.log(...t)}}function e4(e){return e6.includes(e)}function e8(e){let t;let i=new Set,n="undefined"!=typeof process&&process.env&&process.env[e.logLevelEnvVarName]||void 0,r=eJ(e.namespace);function o(e){if(e&&!e4(e))throw Error(`Unknown log level '${e}'. Acceptable values: ${e6.join(",")}`);t=e;let n=[];for(let e of i)s(e)&&n.push(e.namespace);eJ.enable(n.join(","))}function s(e){return!!(t&&e3[e.level]<=e3[t])}function a(e,t){let n=Object.assign(e.extend(t),{level:t});if(e5(e,n),s(n)){let e=eJ.disable();eJ.enable(e+","+n.namespace)}return i.add(n),n}return r.log=(...e)=>{eJ.log(...e)},n&&(e4(n)?o(n):console.error(`${e.logLevelEnvVarName} set to unknown log level '${n}'; logging is not enabled. Acceptable values: ${e6.join(", ")}.`)),{setLogLevel:o,getLogLevel:function(){return t},createClientLogger:function(e){let t=r.extend(e);return e5(r,t),{error:a(t,"error"),warning:a(t,"warning"),info:a(t,"info"),verbose:a(t,"verbose")}},logger:r}}let e9=e8({logLevelEnvVarName:"TYPESPEC_RUNTIME_LOG_LEVEL",namespace:"typeSpecRuntime"});function e7(e){return e9.createClientLogger(e)}e9.logger;let te=e8({logLevelEnvVarName:"AZURE_LOG_LEVEL",namespace:"azure"});function tt(e){return te.createClientLogger(e)}te.logger,function(e){e[e.Gateway=0]="Gateway"}(J||(J={}));let ti=Object.freeze({connectionMode:J.Gateway,requestTimeout:6e4,enableEndpointDiscovery:!0,preferredLocations:[],retryOptions:{maxRetryAttemptCount:s.ThrottledRequestMaxRetryAttemptCount,fixedRetryIntervalInMilliseconds:s.ThrottledRequestFixedRetryIntervalInMs,maxWaitTimeInSeconds:s.ThrottledRequestMaxWaitTimeInSeconds},useMultipleWriteLocations:!0,endpointRefreshRateInMs:3e5,enableBackgroundEndpointRefreshing:!0,enablePartitionLevelFailover:!0,enablePartitionLevelCircuitBreaker:!1});!function(e){e.Strong="Strong",e.BoundedStaleness="BoundedStaleness",e.Session="Session",e.Eventual="Eventual",e.ConsistentPrefix="ConsistentPrefix"}(Y||(Y={}));class tn{writableLocations=[];readableLocations=[];get DatabasesLink(){return this.databasesLink}databasesLink;get MediaLink(){return this.mediaLink}mediaLink;get MaxMediaStorageUsageInMB(){return this.maxMediaStorageUsageInMB}maxMediaStorageUsageInMB;get CurrentMediaStorageUsageInMB(){return this.currentMediaStorageUsageInMB}currentMediaStorageUsageInMB;get ConsistencyPolicy(){return this.consistencyPolicy}consistencyPolicy;enableMultipleWritableLocations;enablePerPartitionFailover=!1;constructor(e,t){this.databasesLink="/dbs/",this.mediaLink="/media/",this.maxMediaStorageUsageInMB=t[s.HttpHeaders.MaxMediaStorageUsageInMB],this.currentMediaStorageUsageInMB=t[s.HttpHeaders.CurrentMediaStorageUsageInMB],this.consistencyPolicy=e.userConsistencyPolicy?e.userConsistencyPolicy.defaultConsistencyLevel:Y.Session,e[s.WritableLocations]&&"localhost"!==e.id&&(this.writableLocations=e[s.WritableLocations]),e[s.ReadableLocations]&&"localhost"!==e.id&&(this.readableLocations=e[s.ReadableLocations]),e[s.ENABLE_MULTIPLE_WRITABLE_LOCATIONS]?this.enableMultipleWritableLocations=!0===e[s.ENABLE_MULTIPLE_WRITABLE_LOCATIONS]||"true"===e[s.ENABLE_MULTIPLE_WRITABLE_LOCATIONS]:this.enableMultipleWritableLocations=!1,e[s.EnablePerPartitionFailover]&&(this.enablePerPartitionFailover=!0===e[s.EnablePerPartitionFailover]||"true"===e[s.EnablePerPartitionFailover])}}(function(e){e.Number="Number",e.String="String",e.Point="Point",e.LineString="LineString",e.Polygon="Polygon",e.MultiPolygon="MultiPolygon"})(Z||(Z={})),function(e){e.consistent="consistent",e.lazy="lazy",e.none="none"}(X||(X={})),function(e){e.LineString="LineString",e.MultiPolygon="MultiPolygon",e.Point="Point",e.Polygon="Polygon"}(ee||(ee={})),function(e){e.Flat="flat",e.DiskANN="diskANN",e.QuantizedFlat="quantizedFlat"}(et||(et={})),function(e){e.Range="Range",e.Spatial="Spatial"}(ei||(ei={}));let tr={};function to(e){return Array.isArray(e)?e.map(e=>void 0===e?tr:e):[e]}(function(e){e[e.V1=1]="V1",e[e.V2=2]="V2"})(en||(en={})),function(e){e.Hash="Hash",e.MultiHash="MultiHash"}(er||(er={})),function(e){e.None="none",e.Read="read",e.All="all"}(eo||(eo={})),function(e){e.High="High",e.Low="Low"}(es||(es={})),function(e){e.All="all",e.Create="create",e.Update="update",e.Delete="delete",e.Replace="replace"}(ea||(ea={})),function(e){e.Pre="pre",e.Post="post"}(ec||(ec={})),(el||(el={})).Javascript="Javascript",function(e){e.Geography="Geography",e.Geometry="Geometry"}(eu||(eu={})),function(e){e.Float16="float16",e.Float32="float32",e.UInt8="uint8",e.Int8="int8"}(eh||(eh={})),function(e){e.Euclidean="euclidean",e.Cosine="cosine",e.DotProduct="dotproduct"}(ed||(ed={}));let ts="/_partitionKey";async function ta(e,t){return(await t.readPartitionKeyDefinition(e)).resource}async function tc(e,t,i,n,r,o){let s;if(n){let n=o??await ta(e,r);n&&t&&t.length>0&&(s=await i.getPartitionKeyRangeIdFromPartitionKey(r.url,t,n,e))}return s}let tl=tt("extractPartitionKey");function tu(e,t){if(!t||!t.paths||t.paths.length<=0){tl.error("Unexpected Partition Key Definition Found.");return}if(1===t.paths.length&&t.paths[0]===ts){let i=th(ts,e);return void 0===i?!0===t.systemKey?[]:void tl.warning("Unsupported PartitionKey found."):(null===i||i===tr)&&!0===t.systemKey?[]:[i]}if(!0===t.systemKey)return[];let i=[];return t.paths.forEach(t=>{let n=th(t,e);if(void 0===n){tl.warning("Unsupported PartitionKey found.");return}i.push(n)}),i}function th(e,t){for(let i of function(e){let t=[],i=0,n=()=>{throw Error("Path "+e+" is invalid at index "+i)},r=()=>{let t=e[i],r=++i;for(;-1===(r=e.indexOf(t,r))&&n(),"\\"===e[r-1];)++r;let o=e.substr(i,r-i);return i=r+1,o},o=()=>{let t=e.indexOf("/",i),n=null;return -1===t?(n=e.substr(i),i=e.length):(n=e.substr(i,t-i),i=t),n=n.trim()};for(;i<e.length&&("/"!==e[i]&&n(),++i!==e.length);)'"'===e[i]||"'"===e[i]?t.push(r()):t.push(o());return t}(e))if("object"==typeof t&&null!==t&&i in t)t=t[i];else{t=void 0;break}return"string"==typeof t||"number"==typeof t||"boolean"==typeof t?t:null===t?null:void 0===t||JSON.stringify(t)===JSON.stringify(tr)?tr:void 0}function td(e){return e?.systemKey?[]:e?.paths.map(()=>tr)}async function tp(e,t,i){return void 0===i&&(i=td(await ta(e,t))),to(i)}function ty(e,t){if(void 0!==e)return e;throw Error(t||"Unexpected 'undefined' value encountered")}function tf(e){return"string"==typeof e||"boolean"==typeof e||"number"==typeof e||void 0!==e&&JSON.stringify(e)===JSON.stringify(tr)||null===e}function tg(e){return tf(e)||Array.isArray(e)}class tm{resource;headers;statusCode;diagnostics;substatus;constructor(e,t,i,n,r){this.resource=e,this.headers=t,this.statusCode=i,this.diagnostics=n,this.substatus=r}get requestCharge(){return Number(this.headers[s.HttpHeaders.RequestCharge])||0}get activityId(){return this.headers[s.HttpHeaders.ActivityId]}get etag(){return this.headers[s.HttpHeaders.ETag]}}class tC{requestCharge;constructor(e){this.requestCharge=e}add(...e){let t=this.requestCharge;for(let i of e){if(null==i)throw Error("clientSideMetrics has null or undefined item(s)");t+=i.requestCharge}return new tC(t)}static zero=new tC(0);static createFromArray(...e){if(null==e)throw Error("clientSideMetricsArray is null or undefined item(s)");return this.zero.add(...e)}}let tE={RetrievedDocumentCount:"retrievedDocumentCount",RetrievedDocumentSize:"retrievedDocumentSize",OutputDocumentCount:"outputDocumentCount",OutputDocumentSize:"outputDocumentSize",IndexHitRatio:"indexUtilizationRatio",TotalQueryExecutionTimeInMs:"totalExecutionTimeInMs",QueryCompileTimeInMs:"queryCompileTimeInMs",LogicalPlanBuildTimeInMs:"queryLogicalPlanBuildTimeInMs",PhysicalPlanBuildTimeInMs:"queryPhysicalPlanBuildTimeInMs",QueryOptimizationTimeInMs:"queryOptimizationTimeInMs",IndexLookupTimeInMs:"indexLookupTimeInMs",DocumentLoadTimeInMs:"documentLoadTimeInMs",VMExecutionTimeInMs:"VMExecutionTimeInMs",DocumentWriteTimeInMs:"writeOutputTimeInMs",SystemFunctionExecuteTimeInMs:"systemFunctionExecuteTimeInMs",UserDefinedFunctionExecutionTimeInMs:"userFunctionExecuteTimeInMs"},tw=Number.MAX_SAFE_INTEGER/1e4,tR=Number.MIN_SAFE_INTEGER/1e4;class tx{_ticks;constructor(e,t,i,n,r){if(!Number.isInteger(e))throw Error("days is not an integer");if(!Number.isInteger(t))throw Error("hours is not an integer");if(!Number.isInteger(i))throw Error("minutes is not an integer");if(!Number.isInteger(n))throw Error("seconds is not an integer");if(!Number.isInteger(r))throw Error("milliseconds is not an integer");let o=(86400*e+3600*t+60*i+n)*1e3+r;if(o>tw||o<tR)throw Error("Total number of milliseconds was either too large or too small");this._ticks=1e4*o}add(e){if(tx.additionDoesOverflow(this._ticks,e._ticks))throw Error("Adding the two timestamps causes an overflow.");let t=this._ticks+e._ticks;return tx.fromTicks(t)}subtract(e){if(tx.subtractionDoesUnderflow(this._ticks,e._ticks))throw Error("Subtracting the two timestamps causes an underflow.");let t=this._ticks-e._ticks;return tx.fromTicks(t)}compareTo(e){if(null==e)return 1;if(!tx.isTimeSpan(e))throw Error("Argument must be a TimeSpan object");return tx.compare(this,e)}duration(){return tx.fromTicks(this._ticks>=0?this._ticks:-this._ticks)}equals(e){return!!tx.isTimeSpan(e)&&this._ticks===e._ticks}negate(){return tx.fromTicks(-this._ticks)}days(){return Math.floor(this._ticks/864e9)}hours(){return Math.floor(this._ticks/36e9)}milliseconds(){return Math.floor(this._ticks/1e4)}seconds(){return Math.floor(this._ticks/1e7)}ticks(){return this._ticks}totalDays(){return 11574074074074074e-28*this._ticks}totalHours(){return 27777777777777777e-27*this._ticks}totalMilliseconds(){return 1e-4*this._ticks}totalMinutes(){return 16666666666666667e-25*this._ticks}totalSeconds(){return 1e-7*this._ticks}static fromTicks(e){let t=new tx(0,0,0,0,0);return t._ticks=e,t}static zero=new tx(0,0,0,0,0);static maxValue=tx.fromTicks(Number.MAX_SAFE_INTEGER);static minValue=tx.fromTicks(Number.MIN_SAFE_INTEGER);static isTimeSpan(e){return e._ticks}static additionDoesOverflow(e,t){let i=e+t;return e!==i-t||t!==i-e}static subtractionDoesUnderflow(e,t){let i=e-t;return e!==i+t||t!==e-i}static compare(e,t){return e._ticks>t._ticks?1:e._ticks<t._ticks?-1:0}static interval(e,t){if(isNaN(e))throw Error("value must be a number");let i=e*t;if(i>tw||i<tR)throw Error("timespan too long");return tx.fromTicks(Math.floor(1e4*i))}static fromMilliseconds(e){return tx.interval(e,1)}static fromSeconds(e){return tx.interval(e,1e3)}static fromMinutes(e){return tx.interval(e,6e4)}static fromHours(e){return tx.interval(e,36e5)}static fromDays(e){return tx.interval(e,864e5)}}function tb(e){if(null==e)throw Error("delimitedString is null or undefined");let t={};for(let i of e.split(";")){let e=i.split("=");if(2!==e.length)throw Error("recieved a malformed delimited string");let n=e[0],r=parseFloat(e[1]);t[n]=r}return t}function tv(e,t){return t in e?tx.fromMilliseconds(e[t]):tx.zero}class tT{queryCompilationTime;logicalPlanBuildTime;physicalPlanBuildTime;queryOptimizationTime;constructor(e,t,i,n){this.queryCompilationTime=e,this.logicalPlanBuildTime=t,this.physicalPlanBuildTime=i,this.queryOptimizationTime=n}add(...e){let t=this.queryCompilationTime,i=this.logicalPlanBuildTime,n=this.physicalPlanBuildTime,r=this.queryOptimizationTime;for(let o of e){if(null==o)throw Error("queryPreparationTimesArray has null or undefined item(s)");t=t.add(o.queryCompilationTime),i=i.add(o.logicalPlanBuildTime),n=n.add(o.physicalPlanBuildTime),r=r.add(o.queryOptimizationTime)}return new tT(t,i,n,r)}toDelimitedString(){return`${tE.QueryCompileTimeInMs}=${this.queryCompilationTime.totalMilliseconds()};${tE.LogicalPlanBuildTimeInMs}=${this.logicalPlanBuildTime.totalMilliseconds()};${tE.PhysicalPlanBuildTimeInMs}=${this.physicalPlanBuildTime.totalMilliseconds()};${tE.QueryOptimizationTimeInMs}=${this.queryOptimizationTime.totalMilliseconds()}`}static zero=new tT(tx.zero,tx.zero,tx.zero,tx.zero);static createFromArray(e){if(null==e)throw Error("queryPreparationTimesArray is null or undefined item(s)");return tT.zero.add(...e)}static createFromDelimitedString(e){let t=tb(e);return new tT(tv(t,tE.QueryCompileTimeInMs),tv(t,tE.LogicalPlanBuildTimeInMs),tv(t,tE.PhysicalPlanBuildTimeInMs),tv(t,tE.QueryOptimizationTimeInMs))}}class tS{queryEngineExecutionTime;systemFunctionExecutionTime;userDefinedFunctionExecutionTime;constructor(e,t,i){this.queryEngineExecutionTime=e,this.systemFunctionExecutionTime=t,this.userDefinedFunctionExecutionTime=i}add(...e){let t=this.queryEngineExecutionTime,i=this.systemFunctionExecutionTime,n=this.userDefinedFunctionExecutionTime;for(let r of e){if(null==r)throw Error("runtimeExecutionTimes has null or undefined item(s)");t=t.add(r.queryEngineExecutionTime),i=i.add(r.systemFunctionExecutionTime),n=n.add(r.userDefinedFunctionExecutionTime)}return new tS(t,i,n)}toDelimitedString(){return`${tE.SystemFunctionExecuteTimeInMs}=${this.systemFunctionExecutionTime.totalMilliseconds()};${tE.UserDefinedFunctionExecutionTimeInMs}=${this.userDefinedFunctionExecutionTime.totalMilliseconds()}`}static zero=new tS(tx.zero,tx.zero,tx.zero);static createFromArray(e){if(null==e)throw Error("runtimeExecutionTimesArray is null or undefined item(s)");return tS.zero.add(...e)}static createFromDelimitedString(e){let t=tb(e),i=tv(t,tE.VMExecutionTimeInMs),n=tv(t,tE.IndexLookupTimeInMs),r=tv(t,tE.DocumentLoadTimeInMs),o=tv(t,tE.DocumentWriteTimeInMs),s=tx.zero;return new tS(s=(s=(s=(s=s.add(i)).subtract(n)).subtract(r)).subtract(o),tv(t,tE.SystemFunctionExecuteTimeInMs),tv(t,tE.UserDefinedFunctionExecutionTimeInMs))}}class tI{retrievedDocumentCount;retrievedDocumentSize;outputDocumentCount;outputDocumentSize;indexHitDocumentCount;totalQueryExecutionTime;queryPreparationTimes;indexLookupTime;documentLoadTime;vmExecutionTime;runtimeExecutionTimes;documentWriteTime;clientSideMetrics;constructor(e,t,i,n,r,o,s,a,c,l,u,h,d){this.retrievedDocumentCount=e,this.retrievedDocumentSize=t,this.outputDocumentCount=i,this.outputDocumentSize=n,this.indexHitDocumentCount=r,this.totalQueryExecutionTime=o,this.queryPreparationTimes=s,this.indexLookupTime=a,this.documentLoadTime=c,this.vmExecutionTime=l,this.runtimeExecutionTimes=u,this.documentWriteTime=h,this.clientSideMetrics=d}get indexHitRatio(){return 0===this.retrievedDocumentCount?1:this.indexHitDocumentCount/this.retrievedDocumentCount}add(e){let t=0,i=0,n=0,r=0,o=0,s=tx.zero,a=[],c=tx.zero,l=tx.zero,u=tx.zero,h=[],d=tx.zero,p=[];for(let y of(e.push(this),e))y&&(t+=y.retrievedDocumentCount,i+=y.retrievedDocumentSize,n+=y.outputDocumentCount,r+=y.outputDocumentSize,o+=y.indexHitDocumentCount,s=s.add(y.totalQueryExecutionTime),a.push(y.queryPreparationTimes),c=c.add(y.indexLookupTime),l=l.add(y.documentLoadTime),u=u.add(y.vmExecutionTime),h.push(y.runtimeExecutionTimes),d=d.add(y.documentWriteTime),p.push(y.clientSideMetrics));return new tI(t,i,n,r,o,s,tT.createFromArray(a),c,l,u,tS.createFromArray(h),d,tC.createFromArray(...p))}toDelimitedString(){return tE.RetrievedDocumentCount+"="+this.retrievedDocumentCount+";"+tE.RetrievedDocumentSize+"="+this.retrievedDocumentSize+";"+tE.OutputDocumentCount+"="+this.outputDocumentCount+";"+tE.OutputDocumentSize+"="+this.outputDocumentSize+";"+tE.IndexHitRatio+"="+this.indexHitRatio+";"+tE.TotalQueryExecutionTimeInMs+"="+this.totalQueryExecutionTime.totalMilliseconds()+";"+this.queryPreparationTimes.toDelimitedString()+";"+tE.IndexLookupTimeInMs+"="+this.indexLookupTime.totalMilliseconds()+";"+tE.DocumentLoadTimeInMs+"="+this.documentLoadTime.totalMilliseconds()+";"+tE.VMExecutionTimeInMs+"="+this.vmExecutionTime.totalMilliseconds()+";"+this.runtimeExecutionTimes.toDelimitedString()+";"+tE.DocumentWriteTimeInMs+"="+this.documentWriteTime.totalMilliseconds()}static zero=new tI(0,0,0,0,0,tx.zero,tT.zero,tx.zero,tx.zero,tx.zero,tS.zero,tx.zero,tC.zero);static createFromArray(e){if(!e)throw Error("queryMetricsArray is null or undefined item(s)");return tI.zero.add(e)}static createFromDelimitedString(e,t){let i=tb(e),n=i[tE.IndexHitRatio]||0,r=i[tE.RetrievedDocumentCount]||0,o=i[tE.OutputDocumentCount]||0,s=i[tE.OutputDocumentSize]||0;return new tI(r,i[tE.RetrievedDocumentSize]||0,o,s,n*r,tv(i,tE.TotalQueryExecutionTimeInMs),tT.createFromDelimitedString(e),tv(i,tE.IndexLookupTimeInMs),tv(i,tE.DocumentLoadTimeInMs),tv(i,tE.VMExecutionTimeInMs),tS.createFromDelimitedString(e),tv(i,tE.DocumentWriteTimeInMs),t||tC.zero)}}function tP(e){if("number"==typeof e)return e;if("string"==typeof e)return parseFloat(e);if(!e)return 0;{let t=e[s.HttpHeaders.RequestCharge];return t?parseFloat(t):0}}function tA(){let e={};return e[s.HttpHeaders.RequestCharge]=0,e[s.HttpHeaders.QueryMetrics]={},e}function tM(e,t){if(void 0===e[s.HttpHeaders.RequestCharge]&&(e[s.HttpHeaders.RequestCharge]=0),void 0===e[s.HttpHeaders.QueryMetrics]&&(e[s.HttpHeaders.QueryMetrics]=tI.zero),t){if(e[s.HttpHeaders.RequestCharge]+=tP(t),t[s.HttpHeaders.IsRUPerMinuteUsed]&&(e[s.HttpHeaders.IsRUPerMinuteUsed]=t[s.HttpHeaders.IsRUPerMinuteUsed]),s.HttpHeaders.QueryMetrics in t){let i=e[s.HttpHeaders.QueryMetrics],n=t[s.HttpHeaders.QueryMetrics];for(let e in n)if(i[e]){let t=i[e].add([n[e]]);i[e]=t}else i[e]=n[e]}s.HttpHeaders.IndexUtilization in t&&(e[s.HttpHeaders.IndexUtilization]=t[s.HttpHeaders.IndexUtilization]),s.HttpHeaders.CorrelatedActivityId in t&&(e[s.HttpHeaders.CorrelatedActivityId]=t[s.HttpHeaders.CorrelatedActivityId])}}class tD{resources;headers;hasMoreResults;diagnostics;constructor(e,t,i,n){this.resources=e,this.headers=t,this.hasMoreResults=i,this.diagnostics=n}get continuation(){return this.continuationToken}get continuationToken(){return this.headers[s.HttpHeaders.Continuation]}get queryMetrics(){return this.headers[s.HttpHeaders.QueryMetrics]}get requestCharge(){return tP(this.headers)}get activityId(){return this.headers[s.HttpHeaders.ActivityId]}get correlatedActivityId(){return this.headers[s.HttpHeaders.CorrelatedActivityId]}get indexMetrics(){return function(e){try{if(!e||""===e)return"{}";let t=decodeURIComponent(e),i=JSON.parse(t);return JSON.stringify(i)}catch(e){console.error("Error parsing JSON file:",e.message)}}(this.headers[s.HttpHeaders.IndexUtilization])}}let tk="TimeoutError";class tO extends Error{code=tk;constructor(e="Timeout Error"){super(e),this.name=tk}}let tL=tt("cosmosdb");class tF{minInclusive;maxExclusive;continuationToken;epkMinHeader;epkMaxHeader;constructor(e,t,i,n,r){this.minInclusive=e,this.maxExclusive=t,this.continuationToken=i,this.epkMinHeader=n,this.epkMaxHeader=r}}class tB{result;count;statusCode;diagnostics;subStatusCode;constructor(e,t,i,n,r,o){this.result=e,this.count=t,this.statusCode=i,this.diagnostics=r,this.subStatusCode=o,this.headers=n}get requestCharge(){let e=this.headers[s.HttpHeaders.RequestCharge];return e?parseInt(e,10):null}get activityId(){return this.headers[s.HttpHeaders.ActivityId]}get continuationToken(){return this.headers[s.HttpHeaders.ContinuationToken]}get sessionToken(){return this.headers[s.HttpHeaders.SessionToken]}headers}class tK{min;max;isMinInclusive;isMaxInclusive;constructor(e,t,i,n){this.min=e,this.max=t,this.isMinInclusive=i,this.isMaxInclusive=n}overlaps(e){return!(void 0===this||void 0===e||this.isEmpty()||e.isEmpty())&&(this.min<=e.max||e.min<=this.max)&&(this.min!==e.max||!!this.isMinInclusive&&!!e.isMaxInclusive)&&(e.min!==this.max||!!e.isMinInclusive&&!!this.isMaxInclusive)}isFullRange(){return this.min===s.EffectivePartitionKeyConstants.MinimumInclusiveEffectivePartitionKey&&this.max===s.EffectivePartitionKeyConstants.MaximumExclusiveEffectivePartitionKey&&!0===this.isMinInclusive&&!1===this.isMaxInclusive}isEmpty(){return!(this.isMinInclusive&&this.isMaxInclusive)&&this.min===this.max}static parsePartitionKeyRange(e){return new tK(e[s.PartitionKeyRange.MinInclusive],e[s.PartitionKeyRange.MaxExclusive],!0,!1)}static parseFromDict(e){return new tK(e.min,e.max,e.isMinInclusive,e.isMaxInclusive)}}class tH{orderedPartitionKeyRanges;orderedRanges;orderedPartitionInfo;constructor(e,t){this.orderedPartitionKeyRanges=e,this.orderedRanges=e.map(e=>new tK(e[s.PartitionKeyRange.MinInclusive],e[s.PartitionKeyRange.MaxExclusive],!0,!1)),this.orderedPartitionInfo=t}getOrderedParitionKeyRanges(){return this.orderedPartitionKeyRanges}getOverlappingRanges(e){let t=Array.isArray(e)?e:[e],i={};for(let e of t){let t;if(e.isEmpty())continue;if(e.isFullRange())return this.orderedPartitionKeyRanges;let n=this.orderedRanges.findIndex(t=>{if(e.min>t.min&&e.min<t.max||e.min===t.min||e.min===t.max)return!0});if(n<0)throw Error("error in collection routing map, queried value is less than the start range.");for(let i=this.orderedRanges.length-1;i>=0;i--){let n=this.orderedRanges[i];if(e.max>n.min&&e.max<n.max||e.max===n.min||e.max===n.max){t=i;break}}if(t>this.orderedRanges.length)throw Error("error in collection routing map, queried value is greater than the end range.");for(let r=n;r<t+1;r++)e.overlaps(this.orderedRanges[r])&&(i[this.orderedPartitionKeyRanges[r][s.PartitionKeyRange.MinInclusive]]=this.orderedPartitionKeyRanges[r])}return Object.keys(i).map(e=>i[e]).sort((e,t)=>e[s.PartitionKeyRange.MinInclusive].localeCompare(t[s.PartitionKeyRange.MinInclusive]))}}class tq{clientSideRequestStatistics;diagnosticNode;clientConfig;constructor(e,t,i){this.clientSideRequestStatistics=e,this.diagnosticNode=t,this.clientConfig=i}}function t_(){return Date.now()}function tN(e,t){let i=setInterval(()=>{(async()=>{await e()})()},t);return i.unref&&"function"==typeof i.unref&&i.unref(),i}!function(e){e.PartitionKeyRangeLookUp="PARTITION_KEY_RANGE_LOOK_UP",e.DatabaseAccountLookUp="DATABASE_ACCOUNT_LOOK_UP",e.QueryPlanLookUp="QUERY_PLAN_LOOK_UP",e.DatabaseLookUp="DATABASE_LOOK_UP",e.ContainerLookUp="CONTAINER_LOOK_UP"}(ep||(ep={}));class tU{requestStartTimeUTCinMs;failedAttempts=[];metadataLookups=[];gatewayStatistics=[];locationEndpointsContacted=new Set;encryptionDiagnostics;constructor(){this.requestStartTimeUTCinMs=t_()}recordFailedAttempt(e,t){let i={attemptNumber:t,startTimeUTCInMs:e.startTimeUTCInMs,durationInMs:e.durationInMs,statusCode:e.statusCode,substatusCode:e.subStatusCode,requestPayloadLengthInBytes:e.requestPayloadLengthInBytes,responsePayloadLengthInBytes:e.responsePayloadLengthInBytes,activityId:e.activityId,operationType:e.operationType,resourceType:e.resourceType};this.failedAttempts.push(i)}recordNetworkCall(e){this.gatewayStatistics.push(e)}recordEncryptionDiagnostics(e){let{encryptContent:t,decryptContent:i}=e,n=t[s.Encryption.DiagnosticsDuration]??0,r=i[s.Encryption.DiagnosticsDuration]??0;e.processingDurationInMs=n+r,this.encryptionDiagnostics=e}mergeDiagnostics(e,t){e.locationEndpointsContacted.forEach(e=>this.locationEndpointsContacted.add(e)),e.gatewayStatistics.forEach(e=>this.metadataLookups.push({activityId:e.activityId,requestPayloadLengthInBytes:e.requestPayloadLengthInBytes,responsePayloadLengthInBytes:e.responsePayloadLengthInBytes,startTimeUTCInMs:e.startTimeUTCInMs,operationType:e.operationType,resourceType:e.resourceType,durationInMs:e.durationInMs,metaDataType:t}))}mergeBulkDiagnostics(e){e.locationEndpointsContacted.forEach(e=>this.locationEndpointsContacted.add(e)),e.gatewayStatistics.forEach(e=>this.gatewayStatistics.push(e)),e.metadataLookups.forEach(e=>this.metadataLookups.push(e)),e.failedAttempts.forEach(e=>this.failedAttempts.push(e)),this.encryptionDiagnostics?e.encryptionDiagnostics&&(this.encryptionDiagnostics.decryptContent=e.encryptionDiagnostics.decryptContent,this.encryptionDiagnostics.processingDurationInMs=(this.encryptionDiagnostics.processingDurationInMs||0)+(e.encryptionDiagnostics.processingDurationInMs||0)):this.encryptionDiagnostics=e.encryptionDiagnostics}getClientSideStats(e=t_()){return{requestStartTimeUTCInMs:this.requestStartTimeUTCinMs,requestDurationInMs:e-this.requestStartTimeUTCinMs,totalRequestPayloadLengthInBytes:this.getTotalRequestPayloadLength(),totalResponsePayloadLengthInBytes:this.getTotalResponsePayloadLength(),locationEndpointsContacted:[...this.locationEndpointsContacted.values()],metadataDiagnostics:{metadataLookups:[...this.metadataLookups]},retryDiagnostics:{failedAttempts:[...this.failedAttempts]},gatewayStatistics:this.gatewayStatistics,encryptionDiagnostics:this.encryptionDiagnostics}}getTotalRequestPayloadLength(){let e=0;return this.gatewayStatistics.forEach(t=>e+=t.requestPayloadLengthInBytes),this.metadataLookups.forEach(t=>e+=t.requestPayloadLengthInBytes),this.failedAttempts.forEach(t=>e+=t.requestPayloadLengthInBytes),e}getTotalResponsePayloadLength(){let e=0;return this.gatewayStatistics.forEach(t=>e+=t.responsePayloadLengthInBytes),this.metadataLookups.forEach(t=>e+=t.responsePayloadLengthInBytes),this.failedAttempts.forEach(t=>e+=t.responsePayloadLengthInBytes),e}recordEndpointResolution(e){this.locationEndpointsContacted.add(e)}}!function(e){e.info="info",e.debug="debug",e.debugUnsafe="debug-unsafe"}(ey||(ey={}));let tz=[ey.info,ey.debug,ey.debugUnsafe];function tQ(e,t){let i=tz.indexOf(e),n=tz.indexOf(t);return -1!==i&&-1!==n&&i<=n}function tV(){return crypto.randomUUID()}"undefined"!=typeof window&&window.document,"object"==typeof self&&"function"==typeof self?.importScripts&&(self.constructor?.name==="DedicatedWorkerGlobalScope"||self.constructor?.name==="ServiceWorkerGlobalScope"||self.constructor?.name),"undefined"!=typeof Deno&&void 0!==Deno.version&&Deno.version.deno,"undefined"!=typeof Bun&&Bun.version,void 0!==globalThis.process&&globalThis.process.version&&globalThis.process.versions?.node,"undefined"!=typeof navigator&&navigator?.product;class tW extends Error{constructor(e){super(e),this.name="AbortError"}}class t${id;nodeType;parent;children;data;startTimeUTCInMs;durationInMs;diagnosticLevel;diagnosticCtx;encryptionDiagnostics;constructor(e,t,i,n={},r=t_(),o=new tU){this.id=tV(),this.nodeType=t,this.startTimeUTCInMs=r,this.data=n,this.children=[],this.durationInMs=0,this.parent=i,this.diagnosticCtx=o,this.diagnosticLevel=e,this.encryptionDiagnostics={encryptContent:{},decryptContent:{},processingDurationInMs:0}}addLog(e){this.data.log||(this.data.log=[]),this.data.log.push(e)}sanitizeHeaders(e){return e}updateTimestamp(e=t_()){this.durationInMs=e-this.startTimeUTCInMs}recordSuccessfulNetworkCall(e,t,i,n,r){let o={activityId:i.headers.toJSON()[s.HttpHeaders.ActivityId],correlateActivityId:t.headers[s.HttpHeaders.CorrelatedActivityId],startTimeUTCInMs:e,durationInMs:t_()-e,statusCode:i.status,subStatusCode:n,requestPayloadLengthInBytes:tj(t),responsePayloadLengthInBytes:i?.bodyAsText?.length||0,operationType:t.operationType,resourceType:t.resourceType,partitionKeyRangeId:t.partitionKeyRangeId},a={OperationType:o.operationType,resourceType:o.resourceType,requestPayloadLengthInBytes:o.requestPayloadLengthInBytes};tQ(ey.debugUnsafe,this.diagnosticLevel)&&(a={...a,headers:this.sanitizeHeaders(t.headers),requestBody:t.body,responseBody:i.bodyAsText,url:r}),this.addData({requestPayloadLengthInBytes:o.requestPayloadLengthInBytes,responsePayloadLengthInBytes:o.responsePayloadLengthInBytes,startTimeUTCInMs:o.startTimeUTCInMs,durationInMs:o.durationInMs,requestData:a}),this.diagnosticCtx.recordNetworkCall(o)}recordFailedNetworkCall(e,t,i,n,r,o){this.addData({failedAttempty:!0});let a=tj(t);this.diagnosticCtx.recordFailedAttempt({activityId:o[s.HttpHeaders.ActivityId],correlatedActivityId:t.headers[s.HttpHeaders.CorrelatedActivityId],startTimeUTCInMs:e,durationInMs:t_()-e,statusCode:n,subStatusCode:r,requestPayloadLengthInBytes:a,responsePayloadLengthInBytes:0,operationType:t.operationType,resourceType:t.resourceType},i);let c={OperationType:t.operationType,resourceType:t.resourceType,requestPayloadLengthInBytes:a};if(tQ(ey.debugUnsafe,this.diagnosticLevel)){var l,u;c={...c,headers:this.sanitizeHeaders(t.headers),requestBody:t.body,url:(l=t.endpoint,u=t.path,R(l)+u)}}this.addData({failedAttempty:!0,requestData:c})}recordEndpointResolution(e){this.addData({selectedLocation:e}),this.diagnosticCtx.recordEndpointResolution(e)}addData(e,t,i=this.diagnosticLevel){i!==ey.info&&(this.data={...this.data,...e},t&&this.addLog(t))}addChildNode(e,t,i){return this.diagnosticCtx.mergeDiagnostics(e.diagnosticCtx,i),tQ(t,this.diagnosticLevel)&&(e.parent=this,this.children.push(e)),e}addBulkChildNode(e,t){return this.diagnosticCtx.mergeBulkDiagnostics(e.diagnosticCtx),tQ(t,this.diagnosticLevel)&&(e.parent=this,this.children.push(e)),e}initializeChildNode(e,t,i={}){if(!tQ(t,this.diagnosticLevel))return this;{let t=new t$(this.diagnosticLevel,e,this,i,t_(),this.diagnosticCtx);return this.children.push(t),t}}recordQueryResult(e,t){if(tQ(t,this.diagnosticLevel)){let t=this.data.queryRecordsRead??0;Array.isArray(e)&&(this.data.queryRecordsRead=t+e.length)}}beginEncryptionDiagnostics(e){let t=t_();switch(e){case s.Encryption.DiagnosticsEncryptOperation:this.encryptionDiagnostics.encryptContent[s.Encryption.DiagnosticsStartTime]=t;break;case s.Encryption.DiagnosticsDecryptOperation:this.encryptionDiagnostics.decryptContent[s.Encryption.DiagnosticsStartTime]=t;break;default:throw new d("Invalid operation type for encryption diagnostics")}}endEncryptionDiagnostics(e,t){let i=t_(),n=0;switch(e){case s.Encryption.DiagnosticsEncryptOperation:n=i-this.encryptionDiagnostics.encryptContent[s.Encryption.DiagnosticsStartTime],this.encryptionDiagnostics.encryptContent[s.Encryption.DiagnosticsDuration]=n,void 0!==t&&(this.encryptionDiagnostics.encryptContent[s.Encryption.DiagnosticsPropertiesEncryptedCount]=t);break;case s.Encryption.DiagnosticsDecryptOperation:n=i-this.encryptionDiagnostics.decryptContent[s.Encryption.DiagnosticsStartTime],this.encryptionDiagnostics.decryptContent[s.Encryption.DiagnosticsDuration]=n,void 0!==t&&(this.encryptionDiagnostics.decryptContent[s.Encryption.DiagnosticsPropertiesDecryptedCount]=t);break;default:throw new d("Invalid operation type for encryption diagnostics")}this.diagnosticCtx.recordEncryptionDiagnostics(this.encryptionDiagnostics)}toDiagnosticNode(){return{id:this.id,nodeType:this.nodeType,children:this.children.map(e=>e.toDiagnosticNode()),data:this.data,startTimeUTCInMs:this.startTimeUTCInMs,durationInMs:this.durationInMs}}toDiagnostic(e){let t=function e(t){return t.parent?e(t.parent):t}(this),i=tQ(ey.debug,this.diagnosticLevel)?t.toDiagnosticNode():void 0,n=tQ(ey.debug,this.diagnosticLevel)?e:void 0;return new tq(this.diagnosticCtx.getClientSideStats(),i,n)}}function tj(e){return e.body?e.body.length:0}function tG(){return new tq({requestDurationInMs:0,requestStartTimeUTCInMs:t_(),totalRequestPayloadLengthInBytes:0,totalResponsePayloadLengthInBytes:0,locationEndpointsContacted:[],retryDiagnostics:{failedAttempts:[]},metadataDiagnostics:{metadataLookups:[]},gatewayStatistics:[]},{id:tV(),nodeType:ef.CLIENT_REQUEST_NODE,children:[],data:{},startTimeUTCInMs:t_(),durationInMs:0})}async function tJ(e,t,i,n={}){let r=t.initializeChildNode(i,ey.debug,n);try{let t=await e(r);return r.updateTimestamp(),t}catch(e){throw r.addData({failure:!0}),r.updateTimestamp(),e}}async function tY(e,t,i){let n=new t$(t.diagnosticLevel,ef.METADATA_REQUEST_NODE,null);try{let r=await e(n);return t.addChildNode(n,ey.debug,i),r}catch(e){throw t.addChildNode(n,ey.debug,i),e}}async function tZ(e,t,i=ef.CLIENT_REQUEST_NODE){let n=new t$(t.diagnosticLevel,i,null);try{let i=await e(n);n.updateTimestamp();let r=n.toDiagnostic(t.getClientConfig());return"object"==typeof i&&null!==i&&(i.diagnostics=r),t.recordDiagnostics(r),i}catch(i){n.updateTimestamp(),n.addData({failure:!0});let e=n.toDiagnostic(t.getClientConfig());throw i.diagnostics=e,t.recordDiagnostics(e),i}}function tX(e,t){let i=e[0][s.PartitionKeyRange.MinInclusive],n=t[0][s.PartitionKeyRange.MinInclusive];return i>n?1:i<n?-1:0}function t0(e){let t=new Uint8Array(e.length/2);for(let i=0;i<e.length;i+=2)t[i/2]=parseInt(e.substr(i,2),16);return t}function t1(e){return Array.from(e).map(e=>("00"+e.toString(16)).slice(-2)).join("")}function t2(e){let t=new Uint8Array(e.reduce((e,t)=>e+t.length,0)),i=0;for(let n of e)t.set(n,i),i+=n.length;return t}!function(e){e.CLIENT_REQUEST_NODE="CLIENT_REQUEST_NODE",e.METADATA_REQUEST_NODE="METADATA_REQUEST_NODE",e.HTTP_REQUEST="HTTP_REQUEST",e.BATCH_REQUEST="BATCH_REQUEST",e.PARALLEL_QUERY_NODE="PARALLEL_QUERY_NODE",e.DEFAULT_QUERY_NODE="DEFAULT_QUERY_NODE",e.QUERY_REPAIR_NODE="QUERY_REPAIR_NODE",e.BACKGROUND_REFRESH_THREAD="BACKGROUND_REFRESH_THREAD",e.REQUEST_ATTEMPTS="REQUEST_ATTEMPTS"}(ef||(ef={}));let t6={Undefined:"00",Null:"01",False:"02",True:"03",Number:"05",String:"08",Infinity:"FF"};function t3(e){let t=function(e){let t=t5(e),i=BigInt("0x8000000000000000");return i>t?t^i:~t+BigInt(1)}(e),i=t0(t6.Number);i=t2([i,t0((t>>BigInt(56)&BigInt(255)).toString(16).padStart(2,"0"))]),t=t<<BigInt(8)&BigInt("0xffffffffffffffff");let n=BigInt(0),r=!0;do{if(r)r=!1;else{let e=n.toString(16).padStart(2,"0");"00"!==e&&(i=t2([i,t0(e)]))}n=t>>BigInt(56)&BigInt(255)|BigInt(1),t=t<<BigInt(7)&BigInt("0xffffffffffffffff")}while(t!==BigInt(0));let o=(n&BigInt(254)).toString(16).padStart(2,"0");return"00"!==o&&(i=t2([i,t0(o)])),i}function t5(e){let t=new ArrayBuffer(8);return new DataView(t).setFloat64(0,e),BigInt("0x"+Array.from(new Uint8Array(t)).map(e=>e.toString(16).padStart(2,"0")).join(""))}function t4(e){let t=new Uint8Array(8),i=t5(e);for(let e=0;e<8;e++)t[e]=Number(i>>BigInt(8*e)&BigInt(255));return t}function t8(e,t){return(65535&e)*t+(((e>>>16)*t&65535)<<16)}function t9(e,t){return e<<t|e>>>32-t}function t7(e){return e^=e>>>16,e=t8(e,2246822507),e^=e>>>13,e=t8(e,3266489909),e^=e>>>16}function ie(e,t){e=[e[0]>>>16,65535&e[0],e[1]>>>16,65535&e[1]],t=[t[0]>>>16,65535&t[0],t[1]>>>16,65535&t[1]];let i=[0,0,0,0];return i[3]+=e[3]+t[3],i[2]+=i[3]>>>16,i[3]&=65535,i[2]+=e[2]+t[2],i[1]+=i[2]>>>16,i[2]&=65535,i[1]+=e[1]+t[1],i[0]+=i[1]>>>16,i[1]&=65535,i[0]+=e[0]+t[0],i[0]&=65535,[i[0]<<16|i[1],i[2]<<16|i[3]]}function it(e,t){e=[e[0]>>>16,65535&e[0],e[1]>>>16,65535&e[1]],t=[t[0]>>>16,65535&t[0],t[1]>>>16,65535&t[1]];let i=[0,0,0,0];return i[3]+=e[3]*t[3],i[2]+=i[3]>>>16,i[3]&=65535,i[2]+=e[2]*t[3],i[1]+=i[2]>>>16,i[2]&=65535,i[2]+=e[3]*t[2],i[1]+=i[2]>>>16,i[2]&=65535,i[1]+=e[1]*t[3],i[0]+=i[1]>>>16,i[1]&=65535,i[1]+=e[2]*t[2],i[0]+=i[1]>>>16,i[1]&=65535,i[1]+=e[3]*t[1],i[0]+=i[1]>>>16,i[1]&=65535,i[0]+=e[0]*t[3]+e[1]*t[2]+e[2]*t[1]+e[3]*t[0],i[0]&=65535,[i[0]<<16|i[1],i[2]<<16|i[3]]}function ii(e,t){return 32==(t%=64)?[e[1],e[0]]:t<32?[e[0]<<t|e[1]>>>32-t,e[1]<<t|e[0]>>>32-t]:(t-=32,[e[1]<<t|e[0]>>>32-t,e[0]<<t|e[1]>>>32-t])}function ir(e,t){return 0==(t%=64)?e:t<32?[e[0]<<t|e[1]>>>32-t,e[1]<<t]:[e[1]<<t-32,0]}function io(e,t){return[e[0]^t[0],e[1]^t[1]]}function is(e){return e=it(e=io(e,[0,e[0]>>>1]),[4283543511,3981806797]),e=it(e=io(e,[0,e[0]>>>1]),[3301882366,444984403]),e=io(e,[0,e[0]>>>1])}function ia(e){let t=new Uint8Array(e.length);for(let i=0,n=e.length-1;i<=n;++i,--n)t[i]=e[n],t[n]=e[i];return t}let ic={x86:{hash32:function(e,t){t=t||0;let i=e.length%4,n=e.length-i,r=t,o=0,s=0;for(let t=0;t<n;t+=4)o=t9(o=t8(o=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24,3432918353),15),r^=o=t8(o,461845907),r=t8(r=t9(r,13),5)+3864292196,s=t+4;switch(o=0,i){case 3:o^=e[s+2]<<16;case 2:o^=e[s+1]<<8;case 1:o^=e[s],o=t9(o=t8(o,3432918353),15),r^=o=t8(o,461845907)}return r^=e.length,(r=t7(r))>>>0},hash128:function(e,t){t=t||0;let i=e.length%16,n=e.length-i,r=t,o=t,s=t,a=t,c=0,l=0,u=0,h=0,d=0;for(let t=0;t<n;t+=16)c=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24,l=e[t+4]|e[t+5]<<8|e[t+6]<<16|e[t+7]<<24,u=e[t+8]|e[t+9]<<8|e[t+10]<<16|e[t+11]<<24,h=e[t+12]|e[t+13]<<8|e[t+14]<<16|e[t+15]<<24,c=t9(c=t8(c,597399067),15),r^=c=t8(c,2869860233),r=t8(r=t9(r,19)+o,5)+1444728091,l=t9(l=t8(l,2869860233),16),o^=l=t8(l,951274213),o=t8(o=t9(o,17)+s,5)+197830471,u=t9(u=t8(u,951274213),17),s^=u=t8(u,2716044179),s=t8(s=t9(s,15)+a,5)+2530024501,h=t9(h=t8(h,2716044179),18),a^=h=t8(h,597399067),a=t8(a=t9(a,13)+r,5)+850148119,d=t+16;switch(c=0,l=0,u=0,h=0,i){case 15:h^=e[d+14]<<16;case 14:h^=e[d+13]<<8;case 13:h^=e[d+12],h=t9(h=t8(h,2716044179),18),a^=h=t8(h,597399067);case 12:u^=e[d+11]<<24;case 11:u^=e[d+10]<<16;case 10:u^=e[d+9]<<8;case 9:u^=e[d+8],u=t9(u=t8(u,951274213),17),s^=u=t8(u,2716044179);case 8:l^=e[d+7]<<24;case 7:l^=e[d+6]<<16;case 6:l^=e[d+5]<<8;case 5:l^=e[d+4],l=t9(l=t8(l,2869860233),16),o^=l=t8(l,951274213);case 4:c^=e[d+3]<<24;case 3:c^=e[d+2]<<16;case 2:c^=e[d+1]<<8;case 1:c^=e[d],c=t9(c=t8(c,597399067),15),r^=c=t8(c,2869860233)}return r^=e.length,o^=e.length,s^=e.length,a^=e.length,r+=o+s+a,o+=r,s+=r,a+=r,r=t7(r),o=t7(o),r+=o+(s=t7(s))+(a=t7(a)),o+=r,s+=r,a+=r,("00000000"+(r>>>0).toString(16)).slice(-8)+("00000000"+(o>>>0).toString(16)).slice(-8)+("00000000"+(s>>>0).toString(16)).slice(-8)+("00000000"+(a>>>0).toString(16)).slice(-8)}},x64:{hash128:function(e,t){t=t||0;let i=e.length%16,n=e.length-i,r=[0,t],o=[0,t],s=[0,0],a=[0,0],c=[2277735313,289559509],l=[1291169091,658871167],u=0;for(let t=0;t<n;t+=16)s=[e[t+4]|e[t+5]<<8|e[t+6]<<16|e[t+7]<<24,e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24],a=[e[t+12]|e[t+13]<<8|e[t+14]<<16|e[t+15]<<24,e[t+8]|e[t+9]<<8|e[t+10]<<16|e[t+11]<<24],s=ii(s=it(s,c),31),r=ie(r=ii(r=io(r,s=it(s,l)),27),o),r=ie(it(r,[0,5]),[0,1390208809]),a=ii(a=it(a,l),33),o=ie(o=ii(o=io(o,a=it(a,c)),31),r),o=ie(it(o,[0,5]),[0,944331445]),u=t+16;switch(s=[0,0],a=[0,0],i){case 15:a=io(a,ir([0,e[u+14]],48));case 14:a=io(a,ir([0,e[u+13]],40));case 13:a=io(a,ir([0,e[u+12]],32));case 12:a=io(a,ir([0,e[u+11]],24));case 11:a=io(a,ir([0,e[u+10]],16));case 10:a=io(a,ir([0,e[u+9]],8));case 9:a=ii(a=it(a=io(a,[0,e[u+8]]),l),33),o=io(o,a=it(a,c));case 8:s=io(s,ir([0,e[u+7]],56));case 7:s=io(s,ir([0,e[u+6]],48));case 6:s=io(s,ir([0,e[u+5]],40));case 5:s=io(s,ir([0,e[u+4]],32));case 4:s=io(s,ir([0,e[u+3]],24));case 3:s=io(s,ir([0,e[u+2]],16));case 2:s=io(s,ir([0,e[u+1]],8));case 1:s=ii(s=it(s=io(s,[0,e[u]]),c),31),r=io(r,s=it(s,l))}return r=ie(r=io(r,[0,e.length]),o=io(o,[0,e.length])),o=ie(o,r),r=ie(r=is(r),o=is(o)),o=ie(o,r),t1(ia(t0(("00000000"+(r[0]>>>0).toString(16)).slice(-8)+("00000000"+(r[1]>>>0).toString(16)).slice(-8))))+t1(ia(t0(("00000000"+(o[0]>>>0).toString(16)).slice(-8)+("00000000"+(o[1]>>>0).toString(16)).slice(-8))))}}};function il(e){let t=t2(e.map(iu)),i=function(e){let t=new Uint8Array(e.length);for(let i=0,n=e.length-1;i<=n;++i,--n)t[i]=e[n],t[n]=e[i];return t}(t0(ic.x64.hash128(t)));return i[0]&=63,t1(i).toUpperCase()}function iu(e){switch(typeof e){case"string":return t2([t0(t6.String),new TextEncoder().encode(e),t0(t6.Infinity)]);case"number":{let t=t4(e);return t2([t0(t6.Number),t])}case"boolean":return t0(e?t6.True:t6.False);case"object":if(null===e)return t0(t6.Null);return t0(t6.Undefined);case"undefined":return t0(t6.Undefined);default:throw Error(`Unexpected type: ${typeof e}`)}}function ih(e,t){let i=t?.kind||er.Hash,n=t&&t.version&&t.version===en.V2;switch(i){case er.Hash:return n?il(e):function(e){let t=e[0],i=function(e){switch(typeof e){case"string":{let t=e.substr(0,100);return t2([t0(t6.String),new TextEncoder().encode(t),t0(t6.Undefined)])}case"number":{let t=t4(e);return t2([t0(t6.Number),t])}case"boolean":return t0(e?t6.True:t6.False);case"object":if(null===e)return t0(t6.Null);return t0(t6.Undefined);case"undefined":return t0(t6.Undefined);default:throw Error(`Unexpected type: ${typeof e}`)}}(t);return t1(t2([t3(ic.x86.hash32(i)),function(e){switch(typeof e){case"string":return function(e){let t=t0(t6.String),i=new TextEncoder().encode(e),n=e.length<=100,r=t;for(let e=0;e<(n?i.length:101);e++){let t=i[e];t<255&&t++,r=t2([r,t0(t.toString(16).padStart(2,"0"))])}return n&&(r=t2([r,t0(t6.Undefined)])),r}(e.substring(0,100));case"number":return t3(e);case"boolean":return t0(e?t6.True:t6.False);case"object":if(null===e)return t0(t6.Null);return t0(t6.Undefined);case"undefined":return t0(t6.Undefined);default:throw Error(`Unexpected type: ${typeof e}`)}}(t)])).toUpperCase()}(e);case er.MultiHash:return e.map(e=>il([e])).join("")}}class id{clientContext;collectionRoutingMapByCollectionId;constructor(e){this.clientContext=e,this.collectionRoutingMapByCollectionId={}}async onCollectionRoutingMap(e,t,i=!1){let n=v(e);return(void 0===this.collectionRoutingMapByCollectionId[n]||i)&&(this.collectionRoutingMapByCollectionId[n]=this.requestCollectionRoutingMap(e,t)),this.collectionRoutingMapByCollectionId[n]}async getOverlappingRanges(e,t,i,n=!1){return(await this.onCollectionRoutingMap(e,i,n)).getOverlappingRanges(t)}async requestCollectionRoutingMap(e,t){let{resources:i}=await tY(async t=>this.clientContext.queryPartitionKeyRanges(e).fetchAllInternal(t),t,ep.PartitionKeyRangeLookUp);return function(e){let t={},i={},n=[];for(let r of e)t[r[0][s.PartitionKeyRange.Id]]=r,i[r[1]]=r[0],n.push(r);let r=(n=n.sort(tX)).map(e=>e[0]),o=n.map(e=>e[1]);if(function(e){let t=!1;if(e.length>0){let i=e[0],n=e[e.length-1];t=(t=i[s.PartitionKeyRange.MinInclusive]===s.EffectivePartitionKeyConstants.MinimumInclusiveEffectivePartitionKey)&&n[s.PartitionKeyRange.MaxExclusive]===s.EffectivePartitionKeyConstants.MaximumExclusiveEffectivePartitionKey;for(let i=1;i<e.length;i++){let n=e[i-1],r=e[i];if(!(t=t&&n[s.PartitionKeyRange.MaxExclusive]===r[s.PartitionKeyRange.MinInclusive])){if(n[s.PartitionKeyRange.MaxExclusive]>r[s.PartitionKeyRange.MinInclusive])throw Error("Ranges overlap");break}}}return t}(r))return new tH(r,o)}(i.map(e=>[e,!0]))}async getPartitionKeyRangeIdFromPartitionKey(e,t,i,n){let r=ih(t,i);return function(e,t){let i=0,n=e.length-1;for(;i<=n;){let r=Math.floor((i+n)/2),o=e[r];if(iH(o.minInclusive,o.maxExclusive,t))return o.id;0>t.localeCompare(o.minInclusive)?n=r-1:i=r+1}}((await this.onCollectionRoutingMap(e,n)).getOrderedParitionKeyRanges(),r)}}let ip=s.PartitionKeyRange;class iy{partitionKeyRangeCache;constructor(e){this.partitionKeyRangeCache=new id(e)}static _secondRangeIsAfterFirstRange(e,t){if(void 0===e.max)throw Error("range1 must have max");if(void 0===t.min)throw Error("range2 must have min");return!(e.max>t.min)&&(e.max!==t.min||!e.isMaxInclusive||!t.isMinInclusive)}static _isSortedAndNonOverlapping(e){for(let t=1;t<e.length;t++){let i=e[t-1],n=e[t];if(!this._secondRangeIsAfterFirstRange(i,n))return!1}return!0}static _stringMax(e,t){return e>=t?e:t}static _stringCompare(e,t){return e===t?0:e>t?1:-1}static _subtractRange(e,t){let i=this._stringMax(t[ip.MaxExclusive],e.min),n=0===this._stringCompare(i,e.min)&&e.isMinInclusive;return new tK(i,e.max,n,e.isMaxInclusive)}async getOverlappingRanges(e,t,i){if(!iy._isSortedAndNonOverlapping(t))throw Error("the list of ranges is not a non-overlapping sorted ranges");let n=[];if(0===t.length)return n;let r=await this.partitionKeyRangeCache.onCollectionRoutingMap(e,i),o=0,s=t[0];for(;;){let e;if(s.isEmpty()){if(++o>=t.length)return n;s=t[o];continue}e=n.length>0?iy._subtractRange(s,n[n.length-1]):s;let i=r.getOverlappingRanges(e);if(i.length<=0)throw Error(`error: returned overlapping ranges for queryRange ${e} is empty`);n=n.concat(i);let a=tK.parsePartitionKeyRange(n[n.length-1]);if(!a)throw Error("expected lastKnowTargetRange to be truthy");if(iy._stringCompare(s.max,a.max)>0)throw Error(`error: returned overlapping ranges ${i} \
        does not contain the requested range ${e}`);if(++o>=t.length)return n;for(s=t[o];0>=iy._stringCompare(s.max,a.max);){if(++o>=t.length)return n;s=t[o]}}}}class ig{elements;constructor(){this.elements=[]}modifyFirstElement(e){this.isEmpty()||(this.elements[0]=e)}enqueue(e){this.elements.push(e)}dequeue(){return this.elements.shift()}peek(){return this.isEmpty()?void 0:this.elements[0]}isEmpty(){return 0===this.elements.length}moveFirstElementToTheEnd(){this.isEmpty()||this.elements.push(this.dequeue())}returnSnapshot(){let e=[];return this.elements.map(t=>{let i=new tF(t.epkMinHeader?t.epkMinHeader:t.minInclusive,t.epkMaxHeader?t.epkMaxHeader:t.maxExclusive,t.continuationToken);e.push(i)}),e}}class im{rid;Continuation;constructor(e,t){this.rid=e,this.Continuation=t}}class iC{cfResource;constructor(e){this.cfResource=e}getCfResource(){return this.cfResource}}class iE{cfResource;startTime;constructor(e,t){this.startTime=e,this.cfResource=t}getCfResource(){return this.cfResource}getStartTime(){return this.startTime}}class iw{minInclusive;maxExclusive;constructor(e,t){if(new.target===iw)throw new d("Cannot instantiate abstract class FeedRange");this.minInclusive=e,this.maxExclusive=t}}class iR extends iw{constructor(e,t){super(e,t)}}async function ix(e,t){return t.minInclusive>=e.min&&t.maxExclusive<=e.max?[void 0,void 0]:t.minInclusive<=e.min&&t.maxExclusive>=e.max?[e.min,e.max]:t.minInclusive<=e.min&&t.maxExclusive<=e.max&&t.maxExclusive>=e.min?[e.min,t.maxExclusive]:[t.minInclusive,e.max]}function ib(e,t,i,n){let r={};return r.maxItemCount=e?.maxItemCount,r.sessionToken=e?.sessionToken,r.continuationToken=t,r.changeFeedMode=e?.changeFeedMode,r.excludedLocations=e?.excludedLocations,r.priorityLevel=e?.priorityLevel,r.throughputBucket=e?.throughputBucket,n?r.startFromNow=!0:r.startTime=i,r}async function iv(e){let t=e.map(e=>il([e])).join(""),i=t+s.EffectivePartitionKeyConstants.MaximumExclusiveEffectivePartitionKey;return new tK(t,i,!0,!1)}async function iT(e,t,i,n){let r=0;for(let o of(t.beginEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation),e.result))if(i===eg.AllVersionsAndDeletes){if("current"in o&&null!==o.current){let{body:e,propertiesDecryptedCount:t}=await n.decrypt(o.current);o.current=e,r+=t}if("previous"in o&&null!==o.previous){let{body:e,propertiesDecryptedCount:t}=await n.decrypt(o.previous);o.previous=e,r+=t}}else{let{body:e,propertiesDecryptedCount:t}=await n.decrypt(o);o=e,r+=t}t.endEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation,r)}function iS(e,t,i,n){let r={initialHeaders:{},useLatestVersionFeed:!0,useAllVersionsAndDeletesFeed:!1};return"number"==typeof e.maxItemCount&&(r.maxItemCount=e.maxItemCount),e.sessionToken&&(r.sessionToken=e.sessionToken),e.excludedLocations&&(r.excludedLocations=e.excludedLocations),t?r.accessCondition={type:s.HttpHeaders.IfNoneMatch,condition:t}:i&&(r.initialHeaders[s.HttpHeaders.IfNoneMatch]=s.ChangeFeedIfNoneMatchStartFromNowHeader),n&&(r.initialHeaders[s.HttpHeaders.IfModifiedSince]=n),e.changeFeedMode&&e.changeFeedMode===eg.AllVersionsAndDeletes&&(r.useAllVersionsAndDeletesFeed=!0,r.useLatestVersionFeed=!1),e.throughputBucket&&(r.throughputBucket=e.throughputBucket),e.priorityLevel&&(r.priorityLevel=e.priorityLevel),r}!function(e){e.LatestVersion="Incremental Feed",e.AllVersionsAndDeletes="Full-Fidelity Feed"}(eg||(eg={}));class iI{clientContext;container;partitionKeyRangeCache;resourceId;resourceLink;url;changeFeedOptions;epkRange;continuationToken;queue;startTime;isInstantiated;rId;startFromNow;constructor(e,t,i,n,r,o,s,a){this.clientContext=e,this.container=t,this.partitionKeyRangeCache=i,this.resourceId=n,this.resourceLink=r,this.url=o,this.changeFeedOptions=s,this.epkRange=a,this.queue=new ig,this.continuationToken=s.continuationToken?JSON.parse(s.continuationToken):void 0,this.isInstantiated=!1,s.startFromNow?this.startFromNow=!0:s.startTime&&(this.startTime=s.startTime.toUTCString())}async setIteratorRid(e){let{resource:t}=await this.container.readInternal(e);this.rId=t._rid}continuationTokenRidMatchContainerRid(){return this.continuationToken.rid===this.rId}async fillChangeFeedQueue(e){this.continuationToken?await this.fetchContinuationTokenFeedRanges(e):await this.fetchOverLappingFeedRanges(e),this.isInstantiated=!0}async fetchOverLappingFeedRanges(e){try{for(let t of(await this.partitionKeyRangeCache.getOverlappingRanges(this.url,this.epkRange,e))){let[e,i]=await ix(this.epkRange,t),n=new tF(t.minInclusive,t.maxExclusive,"",e,i);this.queue.enqueue(n)}}catch(e){throw new d(e.message)}}async fetchContinuationTokenFeedRanges(e){let t=this.continuationToken;if(this.continuationTokenRidMatchContainerRid())for(let i of t.Continuation){let t=new tK(i.minInclusive,i.maxExclusive,!0,!1);try{for(let n of(await this.partitionKeyRangeCache.getOverlappingRanges(this.url,t,e))){let[e,r]=await ix(t,n),o=new tF(n.minInclusive,n.maxExclusive,i.continuationToken,e,r);this.queue.enqueue(o)}}catch(e){throw new d(e.message)}}else throw new d("The continuation token is not for the current container definition")}get hasMoreResults(){return!0}async *getAsyncIterator(){do{let e=await this.readNext();yield e}while(this.hasMoreResults)}async readNext(){return tZ(async e=>{let t,i;this.isInstantiated||(await this.setIteratorRid(e),await this.fillChangeFeedQueue(e));do{let[n,r]=await this.fetchNext(e);if(void 0!==(t=r)&&(void 0===i&&(i=n),this.queue.moveFirstElementToTheEnd(),t.statusCode===k.Ok))return t.headers[s.HttpHeaders.ContinuationToken]=this.generateContinuationToken(),this.clientContext.enableEncryption&&await iT(t,e,this.changeFeedOptions.changeFeedMode,this.container.encryptionProcessor),t}while(!this.checkedAllFeedRanges(i));return t.headers[s.HttpHeaders.ContinuationToken]=this.generateContinuationToken(),t},this.clientContext)}generateContinuationToken=()=>JSON.stringify(new im(this.rId,this.queue.returnSnapshot()));async fetchNext(e){let t=this.queue.peek();if(!t)return[void 0,void 0];{let i=await this.getFeedResponse(t,e);if(await this.shouldRetryOnFailure(t,i,e))return this.queue.dequeue(),this.fetchNext(e);{let e=i.headers[s.HttpHeaders.ETag],t=this.queue.peek();return t.continuationToken=e,[t,i]}}}checkedAllFeedRanges(e){if(void 0===e)return!1;let t=this.queue.peek();return e.minInclusive===t?.minInclusive&&e.maxExclusive===t?.maxExclusive&&e.epkMinHeader===t?.epkMinHeader&&e.epkMaxHeader===t?.epkMaxHeader}async shouldRetryOnFailure(e,t,i){if(t.statusCode===k.Ok||t.statusCode===k.NotModified)return!1;if(t.statusCode===k.Gone&&(t.subStatusCode===O.PartitionKeyRangeGone||t.subStatusCode===O.CompletingSplit)){let t=new tK(e.epkMinHeader?e.epkMinHeader:e.minInclusive,e.epkMaxHeader?e.epkMaxHeader:e.maxExclusive,!0,!1),n=await this.partitionKeyRangeCache.getOverlappingRanges(this.url,t,i,!0);if(n.length<1)throw new d("Partition split/merge detected but no overlapping ranges found.");return n.length>=1&&await this.handleSplitOrMerge(!1,n,t,e.continuationToken),!0}return!1}async handleSplitOrMerge(e,t,i,n){let r=0;if(e){let[e,o]=await ix(i,t[0]),s=new tF(t[0].minInclusive,t[0].maxExclusive,n,e,o);this.queue.modifyFirstElement(s),r=1}for(let e=r;e<t.length;e++){let[r,o]=await ix(i,t[e]),s=new tF(t[e].minInclusive,t[e].maxExclusive,n,r,o);this.queue.enqueue(s)}}async getPartitionRangeId(e,t){let i=new tK(e.epkMinHeader?e.epkMinHeader:e.minInclusive,e.epkMaxHeader?e.epkMaxHeader:e.maxExclusive,!0,!1),n=await this.partitionKeyRangeCache.getOverlappingRanges(this.url,i,t,!1);if(n.length<1)throw new d("No overlapping ranges found.");let r=n[0];return(e.minInclusive!==r.minInclusive||e.maxExclusive!==r.maxExclusive||n.length>1)&&await this.handleSplitOrMerge(!0,n,i,e.continuationToken),r.id}async getFeedResponse(e,t){let i=iS(this.changeFeedOptions,e.continuationToken,this.startFromNow,this.startTime),n=await this.getPartitionRangeId(e,t);this.clientContext.enableEncryption&&(await this.container.checkAndInitializeEncryption(),i.containerRid=this.container._rid);try{let e=this.fetchFinalFeedRange(),r=await this.clientContext.queryFeed({path:this.resourceLink,resourceType:K.item,resourceId:this.resourceId,resultFn:e=>e?e.Documents:[],query:void 0,options:i,diagnosticNode:t,partitionKey:void 0,partitionKeyRangeId:n,startEpk:e.epkMinHeader,endEpk:e.epkMaxHeader});return new tB(r.result,r.result?r.result.length:0,r.code,r.headers,tG())}catch(t){if(t.code===k.Gone)return new tB([],0,t.code,t.headers,tG(),t.substatus);let e=new d(t.message);throw e.code=t.code,e.headers=t.headers,e}}fetchFinalFeedRange(){let e=this.queue.peek();if(e)return e;throw new d("No feed range found.")}}class iP{rid;partitionKey;Continuation;constructor(e,t,i){this.rid=e,this.partitionKey=t,this.Continuation=i}}class iA{clientContext;container;resourceId;resourceLink;partitionKey;changeFeedOptions;continuationToken;startTime;rId;isInstantiated;startFromNow;constructor(e,t,i,n,r,o){this.clientContext=e,this.container=t,this.resourceId=i,this.resourceLink=n,this.partitionKey=r,this.changeFeedOptions=o,this.continuationToken=o.continuationToken?JSON.parse(o.continuationToken):void 0,this.isInstantiated=!1,o.startFromNow?this.startFromNow=!0:o.startTime&&(this.startTime=o.startTime.toUTCString())}async instantiateIterator(e){if(await this.setIteratorRid(e),this.clientContext.enableEncryption){await this.container.checkAndInitializeEncryption(),this.partitionKey=M(this.partitionKey),e.beginEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation);let{partitionKeyList:t,encryptedCount:i}=await this.container.encryptionProcessor.getEncryptedPartitionKeyValue(to(this.partitionKey));this.partitionKey=t,e.endEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation,i)}if(this.continuationToken){if(!this.continuationTokenRidMatchContainerRid())throw new d("The continuation is not for the current container definition.")}else this.continuationToken=new iP(this.rId,this.partitionKey,"");this.isInstantiated=!0}continuationTokenRidMatchContainerRid(){return this.continuationToken.rid===this.rId}async setIteratorRid(e){let{resource:t}=await this.container.readInternal(e);this.rId=t._rid}get hasMoreResults(){return!0}async *getAsyncIterator(){do{let e=await this.readNext();yield e}while(this.hasMoreResults)}async readNext(){return tZ(async e=>{this.isInstantiated||await this.instantiateIterator(e);let t=await this.fetchNext(e);return t.statusCode===k.Ok&&this.clientContext.enableEncryption&&await iT(t,e,this.changeFeedOptions.changeFeedMode,this.container.encryptionProcessor),t},this.clientContext)}async fetchNext(e){let t=await this.getFeedResponse(e);return this.continuationToken.Continuation=t.headers[s.HttpHeaders.ETag],t.headers[s.HttpHeaders.ContinuationToken]=JSON.stringify(this.continuationToken),t}async getFeedResponse(e){let t=iS(this.changeFeedOptions,this.continuationToken?.Continuation,this.startFromNow,this.startTime);this.clientContext.enableEncryption&&(t.containerRid=this.container._rid);try{let i=this.clientContext.isPartitionLevelFailOverEnabled(),n=await tc(e,to(this.partitionKey),this.clientContext.partitionKeyRangeCache,i,this.container),r=await this.clientContext.queryFeed({path:this.resourceLink,resourceType:K.item,resourceId:this.resourceId,resultFn:e=>e?e.Documents:[],diagnosticNode:e,query:void 0,options:t,partitionKey:this.partitionKey,partitionKeyRangeId:n});return new tB(r.result,r.result?r.result.length:0,r.code,r.headers,tG())}catch(t){let e=new d(t.message);throw e.code=t.code,e.headers=t.headers,e}}}class iM{cfResource;constructor(e){this.cfResource=e}getCfResource(){return this.cfResource}}!function(e){e[e.FeedRange=0]="FeedRange",e[e.PartitionKey=1]="PartitionKey"}(em||(em={}));class iD{continuationToken;constructor(e){this.continuationToken=e}getCfResource(){return this.continuationToken}getCfResourceJson(){return JSON.parse(this.continuationToken)}getResourceType(){let e=this.getCfResourceJson();if(Object.prototype.hasOwnProperty.call(e,"partitionKey")&&Object.prototype.hasOwnProperty.call(e,"Continuation")&&"string"==typeof e.Continuation)return em.PartitionKey;if(Object.prototype.hasOwnProperty.call(e,"Continuation")&&Array.isArray(e.Continuation)&&e.Continuation.length>0)return em.FeedRange;throw new d("Invalid continuation token.")}}class ik{static Beginning(e){return new iC(e)}static Now(e){return new iM(e)}static Time(e,t){if(!e)throw new d("startTime must be present");if(e instanceof Date==!0)return new iE(e,t);throw new d("startTime must be a Date object.")}static Continuation(e){if(!e)throw new d("Argument continuation must be passed.");if(null==e||""===e.trim())throw new d("Argument continuationToken must be a non-empty string.");return new iD(e)}}async function iO(e,t,i,n){let r=i.url,o=T(r,K.item),a=v(r),c=e.changeFeedStartFrom;if(void 0===c&&(c=ik.Now()),c instanceof iD){let s=c.getCfResourceJson(),l=c.getResourceType(),u=ib(e,c.getCfResource());if(l===em.PartitionKey&&tg(s.partitionKey))return new iA(t,i,a,o,s.partitionKey,u);if(l===em.FeedRange)return new iI(t,i,n,a,o,r,u,void 0);throw new d("Invalid continuation token.")}if(c instanceof iM||c instanceof iE||c instanceof iC){var l;let u=c instanceof iM,h=ib(e,void 0,u?void 0:function(e){if(!(e instanceof iC)&&e instanceof iE)return e.getStartTime()}(c),u),p=c.getCfResource();if(tg(p)){let e=await i.getPartitionKeyDefinition();return void 0!==e&&(l=e.resource)&&l.paths&&l.kind===er.MultiHash&&Array.isArray(p)&&p.length<l.paths.length?new iI(t,i,n,a,o,r,h,await iv(p)):new iA(t,i,a,o,p,h)}{let e;if(void 0===p)e=new tK(s.EffectivePartitionKeyConstants.MinimumInclusiveEffectivePartitionKey,s.EffectivePartitionKeyConstants.MaximumExclusiveEffectivePartitionKey,!0,!1);else if(p instanceof iR&&"string"==typeof p.minInclusive&&"string"==typeof p.maxExclusive&&p.minInclusive>=s.EffectivePartitionKeyConstants.MinimumInclusiveEffectivePartitionKey&&p.maxExclusive<=s.EffectivePartitionKeyConstants.MaximumExclusiveEffectivePartitionKey&&p.maxExclusive>p.minInclusive)e=new tK(p.minInclusive,p.maxExclusive,!0,!1);else throw new d("Invalid feed range.");return new iI(t,i,n,a,o,r,h,e)}}throw new d("Invalid change feed start location.")}class iL{cfOptions;clientContext;container;partitionKeyRangeCache;iterator;isInitialized;constructor(e,t,i,n){this.cfOptions=e,this.clientContext=t,this.container=i,this.partitionKeyRangeCache=n,this.isInitialized=!1}get hasMoreResults(){return!0}async *getAsyncIterator(){await this.initializeIterator();do{let e=await this.iterator.readNext();yield e}while(this.hasMoreResults)}async readNext(){return await this.initializeIterator(),this.iterator.readNext()}async initializeIterator(){if(!this.isInitialized)try{let e=await iO(this.cfOptions,this.clientContext,this.container,this.partitionKeyRangeCache);this.isInitialized=!0,this.iterator=e}catch(e){throw new d(e.message)}}}function iF(e){return"object"==typeof e?JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):e}let iB="application/json";async function iK({clientOptions:e,defaultHeaders:t,verb:i,path:n,resourceId:r,resourceType:o,options:a={},operationType:c,partitionKeyRangeId:l,useMultipleWriteLocations:u,partitionKey:h}){let p={[s.HttpHeaders.ResponseContinuationTokenLimitInKB]:1,[s.HttpHeaders.EnableCrossPartitionQuery]:!0,...t};if((p[s.HttpHeaders.SDKSupportedCapabilities]=V.PartitionMerge,u&&(p[s.HttpHeaders.ALLOW_MULTIPLE_WRITES]=!0),a.continuationTokenLimitInKB&&(p[s.HttpHeaders.ResponseContinuationTokenLimitInKB]=a.continuationTokenLimitInKB),a.continuationToken?p[s.HttpHeaders.Continuation]=a.continuationToken:a.continuation&&(p[s.HttpHeaders.Continuation]=a.continuation),a.preTriggerInclude&&(p[s.HttpHeaders.PreTriggerInclude]=a.preTriggerInclude.constructor===Array?a.preTriggerInclude.join(","):a.preTriggerInclude),a.postTriggerInclude&&(p[s.HttpHeaders.PostTriggerInclude]=a.postTriggerInclude.constructor===Array?a.postTriggerInclude.join(","):a.postTriggerInclude),a.offerType&&(p[s.HttpHeaders.OfferType]=a.offerType),a.offerThroughput&&(p[s.HttpHeaders.OfferThroughput]=a.offerThroughput),a.maxItemCount&&(p[s.HttpHeaders.PageSize]=a.maxItemCount),a.accessCondition&&("IfMatch"===a.accessCondition.type?p[s.HttpHeaders.IfMatch]=a.accessCondition.condition:p[s.HttpHeaders.IfNoneMatch]=a.accessCondition.condition),a.useAllVersionsAndDeletesFeed&&(p[s.HttpHeaders.A_IM]=eg.AllVersionsAndDeletes,p[s.HttpHeaders.ChangeFeedWireFormatVersion]=s.AllVersionsAndDeletesChangeFeedWireFormatVersion),(a.useIncrementalFeed||a.useLatestVersionFeed)&&(p[s.HttpHeaders.A_IM]=eg.LatestVersion),a.indexingDirective&&(p[s.HttpHeaders.IndexingDirective]=a.indexingDirective),a.consistencyLevel&&(p[s.HttpHeaders.ConsistencyLevel]=a.consistencyLevel),a.priorityLevel&&(p[s.HttpHeaders.PriorityLevel]=a.priorityLevel),a.throughputBucket&&(p[s.HttpHeaders.ThroughputBucket]=a.throughputBucket),a.maxIntegratedCacheStalenessInMs&&o===K.item&&("number"==typeof a.maxIntegratedCacheStalenessInMs?p[s.HttpHeaders.DedicatedGatewayPerRequestCacheStaleness]=a.maxIntegratedCacheStalenessInMs.toString():(tL.error(`RangeError: maxIntegratedCacheStalenessInMs "${a.maxIntegratedCacheStalenessInMs}" is not a valid parameter.`),p[s.HttpHeaders.DedicatedGatewayPerRequestCacheStaleness]="null")),a.bypassIntegratedCache&&(p[s.HttpHeaders.DedicatedGatewayPerRequestBypassCache]=a.bypassIntegratedCache.toString()),a.resourceTokenExpirySeconds&&(p[s.HttpHeaders.ResourceTokenExpiry]=a.resourceTokenExpirySeconds),a.sessionToken&&(p[s.HttpHeaders.SessionToken]=a.sessionToken),a.enableScanInQuery&&(p[s.HttpHeaders.EnableScanInQuery]=a.enableScanInQuery),a.populateQuotaInfo&&(p[s.HttpHeaders.PopulateQuotaInfo]=a.populateQuotaInfo),a.populateQueryMetrics&&(p[s.HttpHeaders.PopulateQueryMetrics]=a.populateQueryMetrics),void 0!==a.maxDegreeOfParallelism&&0!==a.maxDegreeOfParallelism&&1!==a.maxDegreeOfParallelism&&(p[s.HttpHeaders.ParallelizeCrossPartitionQuery]=!0),a.populateQuotaInfo&&(p[s.HttpHeaders.PopulateQuotaInfo]=!0),void 0===h||p[s.HttpHeaders.PartitionKey])?void 0!==l&&(p[s.HttpHeaders.PartitionKeyRangeID]=l):p[s.HttpHeaders.PartitionKey]=JSON.stringify(h).replace(/[\u007F-\uFFFF]/g,e=>"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)),(e.key||e.tokenProvider)&&(p[s.HttpHeaders.XDate]=new Date().toUTCString()),i!==H.post&&i!==H.put||p[s.HttpHeaders.ContentType]||(p[s.HttpHeaders.ContentType]=iB),p[s.HttpHeaders.Accept]||(p[s.HttpHeaders.Accept]=iB),a.enableScriptLogging&&(p[s.HttpHeaders.EnableScriptLogging]=a.enableScriptLogging),a.disableRUPerMinuteUsage&&(p[s.HttpHeaders.DisableRUPerMinuteUsage]=!0),a.populateIndexMetrics&&(p[s.HttpHeaders.PopulateIndexMetrics]=a.populateIndexMetrics),e.clientEncryptionOptions&&(p[s.HttpHeaders.IsClientEncryptedHeader]=!0,a.containerRid&&(p[s.HttpHeaders.IntendedCollectionHeader]=a.containerRid)),(e.key||e.resourceTokens||e.tokenProvider||e.permissionFeed)&&await eN(e,i,n,r,o,p),o===K.item&&Object.prototype.hasOwnProperty.call(a,"contentResponseOnWriteEnabled")&&!a.contentResponseOnWriteEnabled){if(c===q.Batch)p[s.HttpHeaders.Prefer]=s.HttpHeaders.PreferReturnMinimal;else throw new d("Currently `contentResponseOnWriteEnabled` option is only supported for batch and bulk operations.")}return p}function iH(e,t,i){let n=i.localeCompare(e)>=0,r=0>i.localeCompare(t);return n&&r}let iq={Create:"Create",Upsert:"Upsert",Read:"Read",Delete:"Delete",Replace:"Replace",Patch:"Patch"};function i_(e){return new TextEncoder().encode(iF(e)).length}function iN(e){return e>=200&&e<=299}class iU{promise;resolveFn;rejectFn;constructor(){this.promise=new Promise((e,t)=>{this.resolveFn=e,this.rejectFn=t})}get task(){return this.promise}setResult(e){this.resolveFn(e)}setException(e){this.rejectFn(e)}}async function iz(e,t,i){if(Object.prototype.hasOwnProperty.call(t,"partitionKey")){let n=to(t.partitionKey),{partitionKeyList:r,encryptedCount:o}=await e.getEncryptedPartitionKeyValue(n);t.partitionKey=r,i+=o}switch(t.operationType){case iq.Create:case iq.Upsert:{let{body:n,propertiesEncryptedCount:r}=await e.encrypt(t.resourceBody);t.resourceBody=n,i+=r;break}case iq.Read:case iq.Delete:await e.isPathEncrypted("/id")&&(t.id=await e.getEncryptedId(t.id),i++);break;case iq.Replace:{await e.isPathEncrypted("/id")&&(t.id=await e.getEncryptedId(t.id),i++);let{body:n,propertiesEncryptedCount:r}=await e.encrypt(t.resourceBody);t.resourceBody=n,i+=r;break}case iq.Patch:{await e.isPathEncrypted("/id")&&(t.id=await e.getEncryptedId(t.id),i++);let n=t.resourceBody;for(let t of Array.isArray(n)?n:n.operations)"value"in t&&await e.isPathEncrypted(t.path)&&(t.value=await e.encryptProperty(t.path,t.value),i++)}}return{operation:t,totalPropertiesEncryptedCount:i}}let iQ={remove:"remove",incr:"incr"},iV=tt("ClientContext");!function(e){e.start="start",e.inProgress="inProgress",e.ended="ended"}(eC||(eC={}));class iW{static STATES=eC;resources;currentIndex;currentPartitionIndex;fetchFunctions;options;continuationToken;get continuation(){return this.continuationToken}state;nextFetchFunction;correlatedActivityId;constructor(e,t,i){this.resources=[],this.currentIndex=0,this.currentPartitionIndex=0,this.fetchFunctions=Array.isArray(t)?t:[t],this.options=e||{},this.continuationToken=this.options.continuationToken||this.options.continuation||null,this.state=iW.STATES.start,this.correlatedActivityId=i}async nextItem(e){return++this.currentIndex,await this.current(e)}async current(e){if(this.currentIndex<this.resources.length)return{result:this.resources[this.currentIndex],headers:tA()};if(!this._canFetchMore())return this.state=iW.STATES.ended,{result:void 0,headers:tA()};{let{result:t,headers:i}=await this.fetchMore(e);return(this.resources=t,0===this.resources.length)?!this.continuationToken&&this.currentPartitionIndex>=this.fetchFunctions.length?(this.state=iW.STATES.ended,{result:void 0,headers:i}):this.current(e):{result:this.resources[this.currentIndex],headers:i}}}hasMoreResults(){return this.state===iW.STATES.start||void 0!==this.continuationToken||this.currentIndex<this.resources.length-1||this.currentPartitionIndex<this.fetchFunctions.length}async fetchMore(e){return tJ(async e=>{let t,i;if(this.currentPartitionIndex>=this.fetchFunctions.length)return{headers:tA(),result:void 0};let n=this.options.continuationToken||this.options.continuation;if(this.options.continuationToken=this.continuationToken,this.currentPartitionIndex>=this.fetchFunctions.length)return{headers:tA(),result:void 0};try{let n;void 0!==this.nextFetchFunction?(iV.verbose("using prefetch"),n=this.nextFetchFunction,this.nextFetchFunction=void 0):(iV.verbose("using fresh fetch"),n=this.fetchFunctions[this.currentPartitionIndex](e,this.options,this.correlatedActivityId));let r=await n;if(t=r.result,e.recordQueryResult(t,ey.debugUnsafe),i=r.headers,this.continuationToken=i[s.HttpHeaders.Continuation],!this.continuationToken&&++this.currentPartitionIndex,this.options&&!0===this.options.bufferItems){let t=this.fetchFunctions[this.currentPartitionIndex];this.nextFetchFunction=t?t(e,{...this.options,continuationToken:this.continuationToken},this.correlatedActivityId):void 0}}catch(e){throw this.state=iW.STATES.ended,e}if(this.state=iW.STATES.inProgress,this.currentIndex=0,this.options.continuationToken=n,this.options.continuation=n,s.HttpHeaders.QueryMetrics in i){let e=i[s.HttpHeaders.QueryMetrics],t=tI.createFromDelimitedString(e);if(s.HttpHeaders.RequestCharge in i){let e=Number(i[s.HttpHeaders.RequestCharge])||0;t=new tI(t.retrievedDocumentCount,t.retrievedDocumentSize,t.outputDocumentCount,t.outputDocumentSize,t.indexHitDocumentCount,t.totalQueryExecutionTime,t.queryPreparationTimes,t.indexLookupTime,t.documentLoadTime,t.vmExecutionTime,t.runtimeExecutionTimes,t.documentWriteTime,new tC(e))}i[s.HttpHeaders.QueryMetrics]={},i[s.HttpHeaders.QueryMetrics]["0"]=t}return{result:t,headers:i}},e,ef.DEFAULT_QUERY_NODE,{queryMethodIdentifier:"fetchMore"})}_canFetchMore(){return this.state===iW.STATES.start||this.continuationToken&&this.state===iW.STATES.inProgress||this.currentPartitionIndex<this.fetchFunctions.length&&this.state===iW.STATES.inProgress}}class i${sum;count;aggregate(e){null!=e&&null!=e.sum&&(null==this.sum&&(this.sum=0,this.count=0),this.sum+=e.sum,this.count+=e.count)}getResult(){if(null!=this.sum&&!(this.count<=0))return this.sum/this.count}}class ij{value;constructor(){this.value=0}aggregate(e){this.value+=e}getResult(){return this.value}}let iG=Object.freeze({NoValue:{ord:0},undefined:{ord:1},boolean:{ord:2,compFunc:(e,t)=>e===t?0:e>t?1:-1},number:{ord:4,compFunc:(e,t)=>e===t?0:e>t?1:-1},string:{ord:5,compFunc:(e,t)=>e===t?0:e>t?1:-1}});class iJ{sortOrder;constructor(e){this.sortOrder=e}targetPartitionKeyRangeDocProdComparator(e,t){let i=e.getTargetParitionKeyRange().minInclusive,n=t.getTargetParitionKeyRange().minInclusive;return i===n?0:i>n?1:-1}compare(e,t){if(e.gotSplit())return -1;if(t.gotSplit())return 1;let i=this.getOrderByItems(e.peekBufferedItems()[0]),n=this.getOrderByItems(t.peekBufferedItems()[0]);this.validateOrderByItems(i,n);for(let e=0;e<i.length;e++){let t=this.compareOrderByItem(i[e],n[e]);if(0!==t){if("Ascending"===this.sortOrder[e])return t;if("Descending"===this.sortOrder[e])return-t}}return this.targetPartitionKeyRangeDocProdComparator(e,t)}compareValue(e,t,i,n){if("object"===t||"object"===n)throw Error("Tried to compare an object type");let r=iG[t].ord,o=r-iG[n].ord;if(0!==o)return o;if(r===iG.undefined.ord||r===iG.NoValue.ord)return 0;let s=iG[t].compFunc;if(void 0===s)throw Error("Cannot find the comparison function");return s(e,i)}compareOrderByItem(e,t){let i=this.getType(e),n=this.getType(t);return this.compareValue(e.item,i,t.item,n)}validateOrderByItems(e,t){if(e.length!==t.length)throw Error(`Expected ${e.length}, but got ${t.length}.`);if(e.length!==this.sortOrder.length)throw Error("orderByItems cannot have a different size than sort orders.");for(let i=0;i<this.sortOrder.length;i++){let n=this.getType(e[i]),r=this.getType(t[i]);if(n!==r)throw Error(`Expected ${n}, but got ${r}. Cannot execute cross partition order-by queries on mixed types. Consider filtering your query using IS_STRING or IS_NUMBER to get around this exception.`)}}getType(e){if(void 0===e||void 0===e.item)return"NoValue";let t=typeof e.item;if(void 0===iG[t])throw Error(`unrecognizable type ${t}`);return t}getOrderByItems(e){return e.orderByItems}}class iY{value;comparer;constructor(){this.value=void 0,this.comparer=new iJ(["Ascending"])}aggregate(e){void 0!==e.max&&(void 0===this.value?this.value=e.max:this.comparer.compareValue(e.max,typeof e.max,this.value,typeof this.value)>0&&(this.value=e.max))}getResult(){return this.value}}class iZ{value;comparer;constructor(){this.value=void 0,this.comparer=new iJ(["Ascending"])}aggregate(e){if(void 0!==e.min){if(void 0===this.value)this.value=e.min;else{let t=null===e.min?"NoValue":typeof e.min,i=null===this.value?"NoValue":typeof this.value;0>this.comparer.compareValue(e.min,t,this.value,i)&&(this.value=e.min)}}}getResult(){return this.value}}class iX{sum;aggregate(e){void 0!==e&&(void 0===this.sum?this.sum=e:this.sum+=e)}getResult(){return this.sum}}class i0{value;aggregate(e){void 0===this.value&&(this.value=e)}getResult(){return this.value}}class i1{value;constructor(){this.value=[]}aggregate(e){Array.isArray(e)&&this.value.push(...e)}getResult(){return[...this.value]}}class i2{value;constructor(){this.value=new Set}aggregate(e){e.forEach(e=>{this.value.add(e)})}getResult(){return Array.from(this.value)}}function i6(e){switch(e){case"Average":return new i$;case"Count":case"CountIf":return new ij;case"Max":return new iY;case"Min":return new iZ;case"Sum":return new iX;case"MakeList":return new i1;case"MakeSet":return new i2;default:return new i0}}!function(e){e[e.Done=0]="Done",e[e.Exception=1]="Exception",e[e.Result=2]="Result"}(eE||(eE={}));class i3{feedResponse;headers;fetchResultType;error;constructor(e,t,i){void 0!==e?(this.feedResponse=e,this.headers=i,this.fetchResultType=eE.Result):(this.error=t,this.fetchResultType=eE.Exception)}}class i5{clientContext;collectionLink;query;targetPartitionKeyRange;fetchResults;allFetched;err;previousContinuationToken;continuationToken;generation=0;internalExecutionContext;startEpk;endEpk;populateEpkRangeHeaders;constructor(e,t,i,n,r,o,s,a,c=!1){this.clientContext=e,this.collectionLink=t,this.query=i,this.targetPartitionKeyRange=n,this.fetchResults=[],this.allFetched=!1,this.err=void 0,this.previousContinuationToken=void 0,this.continuationToken=void 0,this.internalExecutionContext=new iW(r,this.fetchFunction,o),this.startEpk=s,this.endEpk=a,this.populateEpkRangeHeaders=c}peekBufferedItems(){let e=[];for(let t=0,i=!1;t<this.fetchResults.length&&!i;t++){let n=this.fetchResults[t];switch(n.fetchResultType){case eE.Done:case eE.Exception:i=!0;break;case eE.Result:e.push(n.feedResponse)}}return e}fetchFunction=async(e,t,i)=>{let n=T(this.collectionLink,K.item);e.addData({partitionKeyRangeId:this.targetPartitionKeyRange.id});let r=v(this.collectionLink),o=this.populateEpkRangeHeaders?this.startEpk:void 0,s=this.populateEpkRangeHeaders?this.endEpk:void 0;return this.clientContext.queryFeed({path:n,resourceType:K.item,resourceId:r,resultFn:e=>e.Documents,query:this.query,options:t,diagnosticNode:e,partitionKeyRangeId:this.targetPartitionKeyRange.id,correlatedActivityId:i,startEpk:o,endEpk:s})};hasMoreResults(){return this.internalExecutionContext.hasMoreResults()||0!==this.fetchResults.length}gotSplit(){if(0!==this.fetchResults.length){let e=this.fetchResults[0];if(e.fetchResultType===eE.Exception&&i5._needPartitionKeyRangeCacheRefresh(e.error))return!0}return!1}_updateStates(e,t){if(e){this.err=e;return}t&&(this.allFetched=!0),this.internalExecutionContext.continuationToken!==this.continuationToken&&(this.previousContinuationToken=this.continuationToken,this.continuationToken=this.internalExecutionContext.continuationToken)}static _needPartitionKeyRangeCacheRefresh(e){return e.code===k.Gone&&"substatus"in e&&e.substatus===O.PartitionKeyRangeGone}async bufferMore(e){if(this.err)throw this.err;try{let{result:t,headers:i}=await this.internalExecutionContext.fetchMore(e);if(++this.generation,this._updateStates(void 0,void 0===t),void 0!==t){let e=!0;t.forEach(t=>{this.fetchResults.push(new i3(t,void 0,e?i:tA())),e=!1})}if(null!=i&&s.HttpHeaders.QueryMetrics in i){let e=i[s.HttpHeaders.QueryMetrics]["0"];i[s.HttpHeaders.QueryMetrics]={},i[s.HttpHeaders.QueryMetrics][this.targetPartitionKeyRange.id]=e}return i}catch(e){if(i5._needPartitionKeyRangeCacheRefresh(e)){let t=new i3(void 0,e);return this.fetchResults.push(t),e.headers}throw this._updateStates(e,void 0===e.resources),e}}getTargetParitionKeyRange(){return this.targetPartitionKeyRange}peakNextItem(){if(this.err)throw this.err;if(this.allFetched||0===this.fetchResults.length)return;let e=this.fetchResults[0];switch(e.fetchResultType){case eE.Done:case eE.Exception:return;case eE.Result:return e.feedResponse}}async fetchNextItem(){if(this.err)throw this._updateStates(this.err,void 0),this.err;if(this.allFetched)return{result:void 0,headers:tA()};try{let{result:e,headers:t}=this.current();if(this._updateStates(void 0,void 0===e),void 0===e||0===e.length)return{result:void 0,headers:t};return{result:e,headers:t}}catch(e){throw this._updateStates(e,void 0===e.item),e}}async fetchBufferedItems(){if(this.err)throw this._updateStates(this.err,void 0),this.err;if(this.allFetched)return{result:void 0,headers:tA()};let e=[];try{for(;this.fetchResults.length>0;){let{result:t}=this.current();if(this._updateStates(void 0,void 0===t),void 0===t)return{result:e.length>0?e:void 0,headers:tA()};e.push(t)}return{result:e,headers:tA()}}catch(e){throw this._updateStates(e,void 0===e.item),e}}current(){if(this.fetchResults.length>0){let e=this.fetchResults.shift();switch(e.fetchResultType){case eE.Done:return{result:void 0,headers:tA()};case eE.Exception:throw e.error.headers=tA(),e.error;case eE.Result:return{result:e.feedResponse,headers:tA()}}}return this.allFetched?{result:void 0,headers:tA()}:{result:[],headers:tA()}}}var i4=i(9119),i8=i(1552);let i9=tt("parallelQueryExecutionContextBase");!function(e){e.started="started",e.inProgress="inProgress",e.ended="ended"}(ew||(ew={}));class i7{clientContext;collectionLink;query;options;partitionedQueryExecutionInfo;correlatedActivityId;err;state;static STATES=ew;routingProvider;sortOrders;requestContinuation;respHeaders;unfilledDocumentProducersQueue;bufferedDocumentProducersQueue;buffer;sem;diagnosticNodeWrapper;constructor(e,t,i,n,r,o){this.clientContext=e,this.collectionLink=t,this.query=i,this.options=n,this.partitionedQueryExecutionInfo=r,this.correlatedActivityId=o,this.clientContext=e,this.collectionLink=t,this.query=i,this.options=n,this.partitionedQueryExecutionInfo=r,this.correlatedActivityId=o,this.diagnosticNodeWrapper={consumed:!1,diagnosticNode:new t$(e.diagnosticLevel,ef.PARALLEL_QUERY_NODE,null)},this.diagnosticNodeWrapper.diagnosticNode.addData({stateful:!0}),this.err=void 0,this.state=i7.STATES.started,this.routingProvider=new iy(this.clientContext),this.sortOrders=this.partitionedQueryExecutionInfo.queryInfo.orderBy,this.buffer=[],this.requestContinuation=n?n.continuationToken||n.continuation:null,this.respHeaders=tA(),this.unfilledDocumentProducersQueue=new i4((e,t)=>e.generation-t.generation),this.bufferedDocumentProducersQueue=new i4((e,t)=>this.documentProducerComparator(t,e)),this.sem=i8(1);let s=async()=>{try{let e=await this._onTargetPartitionRanges(),t=void 0===n.maxDegreeOfParallelism||n.maxDegreeOfParallelism<1?e.length:Math.min(n.maxDegreeOfParallelism,e.length);i9.info("Query starting against "+e.length+" ranges with parallelism of "+t);let i=[],r=[];if(this.requestContinuation)throw Error("Continuation tokens are not yet supported for cross partition queries");e.forEach(e=>{r.push(this._createTargetPartitionQueryExecutionContext(e,void 0))}),r.forEach(e=>{try{this.unfilledDocumentProducersQueue.enq(e)}catch(e){this.err=e}}),this.sem.leave()}catch(e){this.err=e,this.sem.leave();return}};this.sem.take(s)}_mergeWithActiveResponseHeaders(e){tM(this.respHeaders,e)}_getAndResetActiveResponseHeaders(){let e=this.respHeaders;return this.respHeaders=tA(),e}getDiagnosticNode(){return this.diagnosticNodeWrapper.diagnosticNode}async _onTargetPartitionRanges(){let e=this.partitionedQueryExecutionInfo.queryRanges.map(e=>tK.parseFromDict(e));return this.routingProvider.getOverlappingRanges(this.collectionLink,e,this.getDiagnosticNode())}async _getReplacementPartitionKeyRanges(e,t){let i=e.targetPartitionKeyRange;this.routingProvider=new iy(this.clientContext);let n=tK.parsePartitionKeyRange(i);return this.routingProvider.getOverlappingRanges(this.collectionLink,[n],t)}async _enqueueReplacementDocumentProducers(e,t,i){let n=await this._getReplacementPartitionKeyRanges(i,t);if(0===n.length)throw e;if(1===n.length){let e=this._createTargetPartitionQueryExecutionContext(n[0],i.continuationToken,i.startEpk,i.endEpk,!0);this.unfilledDocumentProducersQueue.enq(e)}else{let e=[];n.forEach(t=>{let n=tK.parsePartitionKeyRange(t),r=this._createTargetPartitionQueryExecutionContext(t,i.continuationToken,n.min,n.max,!1);e.push(r)}),e.forEach(e=>{e.hasMoreResults()&&this.unfilledDocumentProducersQueue.enq(e)})}}static _needPartitionKeyRangeCacheRefresh(e){return e.code===k.Gone&&"substatus"in e&&e.substatus===O.PartitionKeyRangeGone}hasMoreResults(){return!this.err&&(this.buffer.length>0||this.state!==i7.STATES.ended)}_createTargetPartitionQueryExecutionContext(e,t,i,n,r){let o,s=this.partitionedQueryExecutionInfo.queryInfo.rewrittenQuery,a=this.query;o="string"==typeof a?{query:a}:a,s&&(o=JSON.parse(JSON.stringify(o)),s=s.replace("{documentdb-formattableorderbyquery-filter}","true"),o.query=s);let c={...this.options};return c.continuationToken=t,new i5(this.clientContext,this.collectionLink,o,e,c,this.correlatedActivityId,i,n,r)}async drainBufferedItems(){return new Promise((e,t)=>{this.sem.take(()=>{if(this.err){this.sem.leave(),this.err.headers=this._getAndResetActiveResponseHeaders(),t(this.err);return}if(0===this.buffer.length)return this.sem.leave(),e({result:this.state===i7.STATES.ended?void 0:[],headers:this._getAndResetActiveResponseHeaders()});let i=this.buffer;return this.buffer=[],this.sem.leave(),e({result:i,headers:this._getAndResetActiveResponseHeaders()})})})}async bufferDocumentProducers(e){return new Promise((t,i)=>{this.sem.take(async()=>{if(this.err){this.sem.leave(),i(this.err);return}if(this.updateStates(this.err),this.state===i7.STATES.ended||0===this.unfilledDocumentProducersQueue.size()){this.sem.leave(),t();return}try{let n=void 0===this.options.maxDegreeOfParallelism||this.options.maxDegreeOfParallelism<1?this.unfilledDocumentProducersQueue.size():Math.min(this.options.maxDegreeOfParallelism,this.unfilledDocumentProducersQueue.size()),r=[];for(;r.length<n&&this.unfilledDocumentProducersQueue.size()>0;){let e;try{e=this.unfilledDocumentProducersQueue.deq()}catch(e){this.err=e,this.err.headers=this._getAndResetActiveResponseHeaders(),i(this.err);return}r.push(e)}let o=async n=>{try{let t=await n.bufferMore(e);this._mergeWithActiveResponseHeaders(t);let i=n.peakNextItem();void 0!==i?this.bufferedDocumentProducersQueue.enq(n):n.hasMoreResults()&&this.unfilledDocumentProducersQueue.enq(n)}catch(r){i7._needPartitionKeyRangeCacheRefresh(r)?(await this._enqueueReplacementDocumentProducers(r,e,n),t()):(this.err=r,this.err.headers=this._getAndResetActiveResponseHeaders(),i(r))}};try{await Promise.all(r.map(e=>o(e)))}catch(e){this.err=e,this.err.headers=this._getAndResetActiveResponseHeaders(),i(e);return}t()}catch(e){this.err=e,this.err.headers=this._getAndResetActiveResponseHeaders(),i(e)}finally{this.sem.leave()}})})}async fillBufferFromBufferQueue(e=!1){return new Promise((t,i)=>{this.sem.take(async()=>{if(this.err){this.sem.leave(),this.err.headers=this._getAndResetActiveResponseHeaders(),i(this.err);return}if(this.state===i7.STATES.ended||0===this.bufferedDocumentProducersQueue.size()){this.sem.leave(),t();return}try{if(e)for(;this.unfilledDocumentProducersQueue.isEmpty()&&this.bufferedDocumentProducersQueue.size()>0;){let e=this.bufferedDocumentProducersQueue.deq(),{result:t,headers:i}=await e.fetchNextItem();this._mergeWithActiveResponseHeaders(i),t&&this.buffer.push(t),void 0!==e.peakNextItem()?this.bufferedDocumentProducersQueue.enq(e):e.hasMoreResults()&&this.unfilledDocumentProducersQueue.enq(e)}else for(;this.bufferedDocumentProducersQueue.size()>0;){let e=this.bufferedDocumentProducersQueue.deq(),{result:t,headers:i}=await e.fetchBufferedItems();this._mergeWithActiveResponseHeaders(i),t&&this.buffer.push(...t),e.hasMoreResults()&&this.unfilledDocumentProducersQueue.enq(e)}this.updateStates(this.err)}catch(e){this.err=e,this.err.headers=this._getAndResetActiveResponseHeaders(),i(this.err);return}finally{this.sem.leave()}t()})})}updateStates(e){if(e){this.err=e,this.state=i7.STATES.ended;return}this.state===i7.STATES.started&&(this.state=i7.STATES.inProgress),0===this.unfilledDocumentProducersQueue.size()&&0===this.bufferedDocumentProducersQueue.size()&&(this.state=i7.STATES.ended)}}class ne extends i7{documentProducerComparator(e,t){return e.generation-t.generation}async fetchMore(e){try{return await this.bufferDocumentProducers(e),await this.fillBufferFromBufferQueue(),this.drainBufferedItems()}catch(e){throw console.error("Error fetching more documents:",e),e}}}class nt extends i7{orderByComparator;constructor(e,t,i,n,r,o){super(e,t,i,n,r,o),this.orderByComparator=new iJ(this.sortOrders)}documentProducerComparator(e,t){return this.orderByComparator.compare(e,t)}async fetchMore(e){try{return await this.bufferDocumentProducers(e),await this.fillBufferFromBufferQueue(!0),this.drainBufferedItems()}catch(e){throw console.error("Error fetching more results:",e),e}}}class ni{executionContext;offset;limit;constructor(e,t,i){this.executionContext=e,this.offset=t,this.limit=i}hasMoreResults(){return(this.offset>0||this.limit>0)&&this.executionContext.hasMoreResults()}async fetchMore(e){let t=tA(),i=[],n=await this.executionContext.fetchMore(e);if(tM(t,n.headers),void 0===n||void 0===n.result)return{result:void 0,headers:n.headers};for(let e of n.result)this.offset>0?this.offset--:this.limit>0&&(i.push(e),this.limit--);return{result:i,headers:t}}}class nn{executionContext;emitRawOrderByPayload;constructor(e,t=!1){this.executionContext=e,this.emitRawOrderByPayload=t}hasMoreResults(){return this.executionContext.hasMoreResults()}async fetchMore(e){let t=[],i=await this.executionContext.fetchMore(e);if(void 0===i||void 0===i.result)return{result:void 0,headers:i.headers};for(let e of i.result)this.emitRawOrderByPayload?t.push(e):t.push(e.payload);return{result:t,headers:i.headers}}}async function nr(e){let t=(0,eK.createHash)("sha256");return t.update(e,"utf8"),t.digest("hex")}var no=i(7410);async function ns(e){return nr(no(e))}class na{executionContext;hashedLastResult;constructor(e){this.executionContext=e}hasMoreResults(){return this.executionContext.hasMoreResults()}async fetchMore(e){let t=[],i=await this.executionContext.fetchMore(e);if(void 0===i||void 0===i.result)return{result:void 0,headers:i.headers};for(let e of i.result)if(e){let i=await ns(e);i!==this.hashedLastResult&&(t.push(e),this.hashedLastResult=i)}return{result:t,headers:i.headers}}}class nc{executionContext;hashedResults;constructor(e){this.executionContext=e,this.hashedResults=new Set}hasMoreResults(){return this.executionContext.hasMoreResults()}async fetchMore(e){let t=[],i=await this.executionContext.fetchMore(e);if(void 0===i||void 0===i.result)return{result:void 0,headers:i.headers};for(let e of i.result)if(e){let i=await ns(e);this.hashedResults.has(i)||(t.push(e),this.hashedResults.add(i))}return{result:t,headers:i.headers}}}let nl="__empty__",nu=e=>Object.keys(e).length>0?e.item2?e.item2:e.item:null;class nh{executionContext;queryInfo;constructor(e,t){this.executionContext=e,this.queryInfo=t}groupings=new Map;aggregateResultArray=[];completed=!1;hasMoreResults(){return this.executionContext.hasMoreResults()}async fetchMore(e){if(this.completed)return{result:void 0,headers:tA()};let t=tA(),i=await this.executionContext.fetchMore(e);if(tM(t,i.headers),void 0===i||void 0===i.result)return this.groupings.size>0?this.consolidateGroupResults(t):{result:void 0,headers:t};for(let e of i.result)if(e){let t=e.groupByItems?await ns(e.groupByItems):nl,i=this.groupings.get(t),n=e.payload;if(i)for(let e of Object.keys(n)){let t=nu(n[e]?n[e]:new Map().set("item2",null));i.get(e).aggregate(t)}else{let e=new Map;for(let i of(this.groupings.set(t,e),Object.keys(n))){let t=this.queryInfo.groupByAliasToAggregateType[i],r=i6(t);if(e.set(i,r),t){let e=nu(n[i]);r.aggregate(e)}else r.aggregate(n[i])}}}return this.executionContext.hasMoreResults()?{result:[],headers:t}:this.consolidateGroupResults(t)}consolidateGroupResults(e){for(let e of this.groupings.values()){let t={};for(let[i,n]of e.entries())t[i]=n.getResult();this.aggregateResultArray.push(t)}return this.completed=!0,{result:this.aggregateResultArray,headers:e}}}class nd{executionContext;queryInfo;aggregators=new Map;aggregateResultArray=[];aggregateType;completed=!1;constructor(e,t){this.executionContext=e,this.queryInfo=t,this.aggregateType=this.queryInfo.aggregates[0]}hasMoreResults(){return this.executionContext.hasMoreResults()}async fetchMore(e){if(this.completed)return{result:void 0,headers:tA()};let t=tA(),i=await this.executionContext.fetchMore(e);if(tM(t,i.headers),void 0===i||void 0===i.result)return this.aggregators.size>0?this.generateAggregateResponse(t):{result:void 0,headers:t};for(let e of i.result)if(e){let t=nl,i=e;if(e.groupByItems&&(i=e.payload,t=await ns(e.groupByItems)),this.aggregators.get(t)||this.aggregators.set(t,i6(this.aggregateType)),this.aggregateType){let e=nu(i[0]);null===e&&(this.completed=!0),this.aggregators.get(t).aggregate(e)}else this.aggregators.get(t).aggregate(i)}return this.completed?{result:void 0,headers:t}:this.executionContext.hasMoreResults()?{result:[],headers:t}:this.generateAggregateResponse(t)}generateAggregateResponse(e){for(let e of this.aggregators.values()){let t=e.getResult();void 0!==t&&this.aggregateResultArray.push(t)}return this.completed=!0,{result:this.aggregateResultArray,headers:e}}}class np{pq;compareFn;pqMaxSize;constructor(e,t){this.compareFn=e,this.pq=new i4(this.compareFn),this.pqMaxSize=t}enqueue(e){if(this.pq.size()<this.pqMaxSize)this.pq.enq(e);else{let t=this.pq.peek();this.compareFn(t,e)>0&&(this.pq.deq(),this.pq.enq(e))}}dequeue(){return this.pq.deq()}size(){return this.pq.size()}isEmpty(){return this.pq.isEmpty()}peek(){return this.pq.peek()}getTopElements(){let e=[];for(;!this.pq.isEmpty();)e.unshift(this.pq.deq());return e}reverse(){let e=new np((e,t)=>-this.compareFn(e,t),this.pqMaxSize);for(;!this.pq.isEmpty();)e.enqueue(this.pq.deq());return e}}class ny{map;compareFn;constructor(e){this.compareFn=e,this.map=new Map}set(e,t){if(this.map.has(e)){let i=this.map.get(e);this.replaceResults(i,t)&&this.map.set(e,t)}else this.map.set(e,t)}get(e){if(this.map.has(e))return this.map.get(e)}getAllValuesAndReset(){let e=[];for(let[t,i]of this.map)e.push(i),this.map.delete(t);return e}replaceResults(e,t){return 0>this.compareFn(e,t)}size(){return this.map.size}}let nf=Object.freeze({NoValue:{ord:0},undefined:{ord:1},boolean:{ord:2,compFunc:(e,t)=>e===t?0:e>t?1:-1},number:{ord:4,compFunc:(e,t)=>e===t?0:e>t?1:-1},string:{ord:5,compFunc:(e,t)=>e===t?0:e>t?1:-1}});class ng{sortOrder;constructor(e){this.sortOrder=e}compareItems(e,t){let i=this.getOrderByItems(e),n=this.getOrderByItems(t);for(let e=0;e<i.length;e++){let t=this.compareOrderByItem(i[e],n[e]);if(0!==t){if("Descending"===this.sortOrder[e])return t;if("Ascending"===this.sortOrder[e])return-t}}}getOrderByItems(e){return e.orderByItems}compareOrderByItem(e,t){let i=this.getType(e),n=this.getType(t);return this.compareValue(e.item,i,t.item,n)}getType(e){if(void 0===e||void 0===e.item)return"NoValue";let t=typeof e.item;if(void 0===nf[t])throw Error(`unrecognizable type ${t}`);return t}compareValue(e,t,i,n){if("object"===t||"object"===n)throw Error("Tried to compare an object type");let r=nf[t].ord,o=r-nf[n].ord;if(0!==o)return o;if(r===nf.undefined.ord||r===nf.NoValue.ord)return 0;let s=nf[t].compFunc;if(void 0===s)throw Error("Cannot find the comparison function");return s(e,i)}}class nm{executionContext;queryInfo;priorityQueueBufferSize;emitRawOrderByPayload;aggregateMap;nonStreamingOrderByPQ;finalResultArray;sortOrders;isCompleted=!1;constructor(e,t,i,n=!1){this.executionContext=e,this.queryInfo=t,this.priorityQueueBufferSize=i,this.emitRawOrderByPayload=n,this.sortOrders=this.queryInfo.orderBy;let r=new ng(this.sortOrders);this.aggregateMap=new ny((e,t)=>r.compareItems(e,t)),this.nonStreamingOrderByPQ=new np((e,t)=>r.compareItems(t,e),this.priorityQueueBufferSize)}async buildFinalResultArray(){for(let e of this.aggregateMap.getAllValuesAndReset())this.nonStreamingOrderByPQ.enqueue(e);let e=this.queryInfo.offset?this.queryInfo.offset:0,t=this.nonStreamingOrderByPQ.size()-e;if(t<=0)this.finalResultArray=[];else{this.finalResultArray=Array(t);for(let e=t-1;e>=0;e--)this.emitRawOrderByPayload?this.finalResultArray[e]=this.nonStreamingOrderByPQ.dequeue():this.finalResultArray[e]=this.nonStreamingOrderByPQ.dequeue()?.payload}}hasMoreResults(){return 0!==this.priorityQueueBufferSize&&this.executionContext.hasMoreResults()}async fetchMore(e){if(this.isCompleted)return{result:void 0,headers:tA()};let t=tA();if(this.priorityQueueBufferSize<=0)return{result:void 0,headers:t};if(this.executionContext.hasMoreResults()){let i=await this.executionContext.fetchMore(e);if(void 0===i||void 0===i.result)return(this.isCompleted=!0,this.aggregateMap.size()>0)?(await this.buildFinalResultArray(),{result:this.finalResultArray,headers:i.headers}):{result:void 0,headers:i.headers};for(let e of(t=i.headers,i.result))if(e){let t=await ns(e?.payload);this.aggregateMap.set(t,e)}if(this.executionContext.hasMoreResults())return{result:[],headers:t}}return this.executionContext.hasMoreResults()||this.isCompleted?{result:void 0,headers:t}:(this.isCompleted=!0,await this.buildFinalResultArray(),{result:this.finalResultArray,headers:t})}}class nC{executionContext;sortOrders;priorityQueueBufferSize;offset;emitRawOrderByPayload;nonStreamingOrderByPQ;isCompleted=!1;constructor(e,t,i,n=0,r=!1){this.executionContext=e,this.sortOrders=t,this.priorityQueueBufferSize=i,this.offset=n,this.emitRawOrderByPayload=r;let o=new ng(this.sortOrders);this.nonStreamingOrderByPQ=new np((e,t)=>o.compareItems(t,e),this.priorityQueueBufferSize)}hasMoreResults(){return this.priorityQueueBufferSize>0&&this.executionContext.hasMoreResults()}async fetchMore(e){if(this.isCompleted)return{result:void 0,headers:tA()};let t=tA();if(this.priorityQueueBufferSize<=0)return{result:void 0,headers:t};if(this.executionContext.hasMoreResults()){let i=await this.executionContext.fetchMore(e);if(t=i.headers,void 0===i||void 0===i.result)return(this.isCompleted=!0,this.nonStreamingOrderByPQ.isEmpty())?{result:void 0,headers:t}:this.buildFinalResultArray(t);for(let e of i.result)void 0!==e&&this.nonStreamingOrderByPQ.enqueue(e)}return this.executionContext.hasMoreResults()?{result:[],headers:t}:this.executionContext.hasMoreResults()||this.isCompleted?{result:void 0,headers:t}:(this.isCompleted=!0,this.buildFinalResultArray(t))}async buildFinalResultArray(e){for(this.isCompleted=!0,this.nonStreamingOrderByPQ=this.nonStreamingOrderByPQ.reverse();this.offset<this.priorityQueueBufferSize&&this.offset>0&&!this.nonStreamingOrderByPQ.isEmpty();)this.nonStreamingOrderByPQ.dequeue(),this.offset--;if(!this.nonStreamingOrderByPQ.isEmpty()){let t=[];if(this.emitRawOrderByPayload)for(;!this.nonStreamingOrderByPQ.isEmpty();)t.push(this.nonStreamingOrderByPQ.dequeue());else for(;!this.nonStreamingOrderByPQ.isEmpty();)t.push(this.nonStreamingOrderByPQ.dequeue()?.payload);return{result:t,headers:e}}}}class nE{clientContext;collectionLink;query;options;partitionedQueryExecutionInfo;emitRawOrderByPayload;fetchBuffer;fetchMoreRespHeaders;endpoint;pageSize;vectorSearchBufferSize=0;static DEFAULT_PAGE_SIZE=10;static DEFAULT_MAX_VECTOR_SEARCH_BUFFER_SIZE=5e4;nonStreamingOrderBy=!1;constructor(e,t,i,n,r,o,s=!1){this.clientContext=e,this.collectionLink=t,this.query=i,this.options=n,this.partitionedQueryExecutionInfo=r,this.emitRawOrderByPayload=s,this.endpoint=null,this.pageSize=n.maxItemCount,void 0===this.pageSize&&(this.pageSize=nE.DEFAULT_PAGE_SIZE),this.nonStreamingOrderBy=r.queryInfo.hasNonStreamingOrderBy;let a=r.queryInfo.orderBy;if(this.nonStreamingOrderBy){n.allowUnboundedNonStreamingQueries||this.checkQueryConstraints(r.queryInfo),this.vectorSearchBufferSize=this.calculateVectorSearchBufferSize(r.queryInfo,n);let e=n.vectorSearchBufferSize?n.vectorSearchBufferSize:nE.DEFAULT_MAX_VECTOR_SEARCH_BUFFER_SIZE;if(this.vectorSearchBufferSize>e)throw new d(`Executing a vector search query with TOP or OFFSET + LIMIT value ${this.vectorSearchBufferSize} larger than the vectorSearchBufferSize ${e} is not allowed`);let t=r.queryInfo.distinctType,i=new ne(this.clientContext,this.collectionLink,this.query,this.options,this.partitionedQueryExecutionInfo,o);"None"===t?this.endpoint=new nC(i,a,this.vectorSearchBufferSize,r.queryInfo.offset,this.emitRawOrderByPayload):this.endpoint=new nm(i,r.queryInfo,this.vectorSearchBufferSize,this.emitRawOrderByPayload)}else{Array.isArray(a)&&a.length>0?this.endpoint=new nn(new nt(this.clientContext,this.collectionLink,this.query,this.options,this.partitionedQueryExecutionInfo,o),this.emitRawOrderByPayload):this.endpoint=new ne(this.clientContext,this.collectionLink,this.query,this.options,this.partitionedQueryExecutionInfo,o),(Object.keys(r.queryInfo.groupByAliasToAggregateType).length>0||r.queryInfo.aggregates.length>0||r.queryInfo.groupByExpressions.length>0)&&(r.queryInfo.hasSelectValue?this.endpoint=new nd(this.endpoint,r.queryInfo):this.endpoint=new nh(this.endpoint,r.queryInfo));let e=r.queryInfo.distinctType;"Ordered"===e&&(this.endpoint=new na(this.endpoint)),"Unordered"===e&&(this.endpoint=new nc(this.endpoint));let t=r.queryInfo.top;"number"==typeof t&&(this.endpoint=new ni(this.endpoint,0,t));let i=r.queryInfo.limit,n=r.queryInfo.offset;"number"==typeof i&&"number"==typeof n&&(this.endpoint=new ni(this.endpoint,n,i))}this.fetchBuffer=[]}hasMoreResults(){return 0!==this.fetchBuffer.length||this.endpoint.hasMoreResults()}async fetchMore(e){return this.fetchMoreRespHeaders=tA(),this._fetchMoreImplementation(e)}async _fetchMoreImplementation(e){try{if(this.fetchBuffer.length>=this.pageSize){let e=this.fetchBuffer.slice(0,this.pageSize);return this.fetchBuffer=this.fetchBuffer.slice(this.pageSize),{result:e,headers:this.fetchMoreRespHeaders}}{let t=await this.endpoint.fetchMore(e);if(tM(this.fetchMoreRespHeaders,t.headers),void 0===t||void 0===t.result){if(!(this.fetchBuffer.length>0))return{result:void 0,headers:this.fetchMoreRespHeaders};{let e=this.fetchBuffer;return this.fetchBuffer=[],{result:e,headers:this.fetchMoreRespHeaders}}}if(this.fetchBuffer.push(...t.result),this.options.enableQueryControl){if(this.fetchBuffer.length>=this.pageSize){let e=this.fetchBuffer.slice(0,this.pageSize);return this.fetchBuffer=this.fetchBuffer.slice(this.pageSize),{result:e,headers:this.fetchMoreRespHeaders}}{let e=this.fetchBuffer;return this.fetchBuffer=[],{result:e,headers:this.fetchMoreRespHeaders}}}return this._fetchMoreImplementation(e)}}catch(e){if(tM(this.fetchMoreRespHeaders,e.headers),e.headers=this.fetchMoreRespHeaders,e)throw e}}calculateVectorSearchBufferSize(e,t){return 0===e.top||0===e.limit?0:e.top?e.top:e.limit?e.offset+e.limit:t.vectorSearchBufferSize&&t.vectorSearchBufferSize>0?t.vectorSearchBufferSize:nE.DEFAULT_MAX_VECTOR_SEARCH_BUFFER_SIZE}checkQueryConstraints(e){let t=e.top||0===e.top,i=e.limit||0===e.limit;if(!t&&!i)throw new d("Executing a non-streaming search query without TOP or LIMIT can consume a large number of RUs very fast and have long runtimes. Please ensure you are using one of the above two filters with your vector search query.")}}let nw={Rid:"_rid",Payload:"payload",ComponentScores:"componentScores"};class nR{rid;componentScores;data;score;ranks;constructor(e,t,i){this.rid=e,this.componentScores=t,this.data=i}static create(e){let t,i;let n=e[nw.Rid];if(!n)throw Error(`${nw.Rid} must exist.`);let r=e[nw.Payload];if(!r||"object"!=typeof r)throw Error(`${nw.Payload} must exist.`);let o=r[nw.Payload];if(o&&"object"==typeof o?(t=r[nw.ComponentScores],i=o):(t=e[nw.ComponentScores],i=r),!Array.isArray(t))throw Error(`${nw.ComponentScores} must exist.`);return new nR(n,t,i)}}class nx{globalStatistics;constructor(){this.globalStatistics={documentCount:0,fullTextStatistics:[]}}aggregate(e){if(e&&(this.globalStatistics.documentCount+=e.documentCount,e.fullTextStatistics&&0!==e.fullTextStatistics.length)){if(0===this.globalStatistics.fullTextStatistics.length)this.globalStatistics.fullTextStatistics=e.fullTextStatistics.map(e=>({totalWordCount:e.totalWordCount,hitCounts:[...e.hitCounts]}));else for(let t=0;t<e.fullTextStatistics.length;t++){let i=e.fullTextStatistics[t];this.globalStatistics.fullTextStatistics[t]||(this.globalStatistics.fullTextStatistics[t]={totalWordCount:0,hitCounts:[]}),this.globalStatistics.fullTextStatistics[t].totalWordCount+=i.totalWordCount;for(let e=0;e<i.hitCounts.length;e++)this.globalStatistics.fullTextStatistics[t].hitCounts.length<=e&&this.globalStatistics.fullTextStatistics[t].hitCounts.push(0),this.globalStatistics.fullTextStatistics[t].hitCounts[e]+=i.hitCounts[e]}}}getResult(){return this.globalStatistics}}!function(e){e.uninitialized="uninitialized",e.initialized="initialized",e.draining="draining",e.done="done"}(eR||(eR={}));class nb{clientContext;collectionLink;query;options;partitionedQueryExecutionInfo;correlatedActivityId;allPartitionsRanges;globalStatisticsExecutionContext;componentsExecutionContext=[];pageSize;state;globalStatisticsAggregator;emitRawOrderByPayload=!0;buffer=[];DEFAULT_PAGE_SIZE=10;TOTAL_WORD_COUNT_PLACEHOLDER="documentdb-formattablehybridsearchquery-totalwordcount";HIT_COUNTS_ARRAY_PLACEHOLDER="documentdb-formattablehybridsearchquery-hitcountsarray";TOTAL_DOCUMENT_COUNT_PLACEHOLDER="documentdb-formattablehybridsearchquery-totaldocumentcount";RRF_CONSTANT=60;logger=tt("HybridQueryExecutionContext");hybridSearchResult=[];uniqueItems=new Map;isSingleComponent=!1;constructor(e,t,i,n,r,o,s){if(this.clientContext=e,this.collectionLink=t,this.query=i,this.options=n,this.partitionedQueryExecutionInfo=r,this.correlatedActivityId=o,this.allPartitionsRanges=s,this.state=eR.uninitialized,this.pageSize=this.options.maxItemCount,void 0===this.pageSize&&(this.pageSize=this.DEFAULT_PAGE_SIZE),r.hybridSearchQueryInfo.requiresGlobalStatistics){let e={maxItemCount:this.pageSize};this.globalStatisticsAggregator=new nx;let t=this.partitionedQueryExecutionInfo.hybridSearchQueryInfo.globalStatisticsQuery,i={partitionedQueryExecutionInfoVersion:1,queryInfo:{distinctType:"None",hasSelectValue:!1,groupByAliasToAggregateType:{},rewrittenQuery:t,hasNonStreamingOrderBy:!1},queryRanges:this.allPartitionsRanges};this.globalStatisticsExecutionContext=new ne(this.clientContext,this.collectionLink,t,e,i,this.correlatedActivityId)}else this.createComponentExecutionContexts(),this.state=eR.initialized}async nextItem(e){let t=tA();for(;(this.state===eR.uninitialized||this.state===eR.initialized)&&0===this.buffer.length;)await this.fetchMoreInternal(e,t);return this.state===eR.draining&&this.buffer.length>0?this.drainOne(t):this.done(t)}hasMoreResults(){switch(this.state){case eR.uninitialized:case eR.initialized:return!0;case eR.draining:return this.buffer.length>0;case eR.done:default:return!1}}async fetchMore(e){let t=tA();return this.fetchMoreInternal(e,t)}async fetchMoreInternal(e,t){switch(this.state){case eR.uninitialized:return await this.initialize(e,t),{result:[],headers:t};case eR.initialized:return await this.executeComponentQueries(e,t),{result:[],headers:t};case eR.draining:return this.drain(t);case eR.done:return this.done(t);default:throw Error(`Invalid state: ${this.state}`)}}async initialize(e,t){try{for(;this.globalStatisticsExecutionContext.hasMoreResults();){let i=await this.globalStatisticsExecutionContext.fetchMore(e);if(tM(t,i.headers),i&&i.result)for(let e of i.result)e&&this.globalStatisticsAggregator.aggregate(e)}}catch(e){throw this.state=eR.done,e}this.createComponentExecutionContexts(),this.state=eR.initialized}async executeComponentQueries(e,t){if(this.isSingleComponent){await this.drainSingleComponent(e,t);return}try{if(this.options.enableQueryControl){if(this.componentsExecutionContext.length>0){let i=this.componentsExecutionContext.pop();if(i.hasMoreResults()){let n=await i.fetchMore(e),r=n.result;tM(t,n.headers),r&&r.forEach(e=>{let t=nR.create(e);this.uniqueItems.has(t.rid)||this.uniqueItems.set(t.rid,t)}),i.hasMoreResults()&&this.componentsExecutionContext.push(i)}}0===this.componentsExecutionContext.length&&this.processUniqueItems()}else{for(let i of this.componentsExecutionContext)for(;i.hasMoreResults();){let n=await i.fetchMore(e),r=n.result;tM(t,n.headers),r&&r.forEach(e=>{let t=nR.create(e);this.uniqueItems.has(t.rid)||this.uniqueItems.set(t.rid,t)})}this.processUniqueItems()}}catch(e){throw this.state=eR.done,e}}processUniqueItems(){if(this.uniqueItems.forEach(e=>this.hybridSearchResult.push(e)),0===this.hybridSearchResult.length||1===this.hybridSearchResult.length){this.hybridSearchResult.forEach(e=>this.buffer.push(e.data)),this.state=eR.draining;return}let e=this.extractComponentWeights();this.sortHybridSearchResultByRRFScore(this.hybridSearchResult,e).forEach(e=>this.buffer.push(e.data)),this.applySkipAndTakeToBuffer(),this.state=eR.draining}applySkipAndTakeToBuffer(){let{skip:e,take:t}=this.partitionedQueryExecutionInfo.hybridSearchQueryInfo;e&&(this.buffer=e>=this.buffer.length?[]:this.buffer.slice(e)),t&&(this.buffer=t<=0?[]:this.buffer.slice(0,t))}async drain(e){try{if(0===this.buffer.length)return this.state=eR.done,this.done(e);let t=this.buffer.slice(0,this.pageSize);return this.buffer=this.buffer.slice(this.pageSize),0===this.buffer.length&&(this.state=eR.done),{result:t,headers:e}}catch(e){throw this.state=eR.done,e}}async drainOne(e){try{if(0===this.buffer.length)return this.state=eR.done,this.done(e);let t=this.buffer.shift();return 0===this.buffer.length&&(this.state=eR.done),{result:t,headers:e}}catch(e){throw this.state=eR.done,e}}done(e){return{result:void 0,headers:e}}sortHybridSearchResultByRRFScore(e,t){if(0===e.length)return[];let i=e.map(e=>({rid:e.rid,ranks:Array(e.componentScores.length).fill(0)}));for(let n=0;n<e[0].componentScores.length;n++){e.sort((e,i)=>t[n].comparator(e.componentScores[n],i.componentScores[n]));let r=1;for(let t=0;t<e.length;t++){t>0&&e[t].componentScores[n]!==e[t-1].componentScores[n]&&++r;let o=i.findIndex(i=>i.rid===e[t].rid);i[o].ranks[n]=r}}let n=i.map(e=>({rid:e.rid,rrfScore:this.computeRRFScore(e.ranks,this.RRF_CONSTANT,t)}));return n.sort((e,t)=>t.rrfScore-e.rrfScore),n.map(t=>e.find(e=>e.rid===t.rid))}async drainSingleComponent(e,t){if(this.componentsExecutionContext&&1!==this.componentsExecutionContext.length){this.logger.error("drainSingleComponent called on multiple components");return}try{if(this.options.enableQueryControl){let i=this.componentsExecutionContext[0];if(i.hasMoreResults()){let n=await i.fetchMore(e),r=n.result;tM(t,n.headers),r&&r.forEach(e=>{this.hybridSearchResult.push(nR.create(e))})}i.hasMoreResults()||(this.state=eR.draining,this.hybridSearchResult.forEach(e=>this.buffer.push(e.data)),this.applySkipAndTakeToBuffer(),this.state=eR.draining);return}{let i=this.componentsExecutionContext[0],n=[];for(;i.hasMoreResults();){let r=await i.fetchMore(e),o=r.result;tM(t,r.headers),o&&o.forEach(e=>{n.push(nR.create(e))})}n.forEach(e=>this.buffer.push(e.data)),this.applySkipAndTakeToBuffer(),this.state=eR.draining}}catch(e){throw this.state=eR.done,e}}createComponentExecutionContexts(){let e=this.partitionedQueryExecutionInfo.hybridSearchQueryInfo.componentQueryInfos;for(let t of(this.partitionedQueryExecutionInfo.hybridSearchQueryInfo.requiresGlobalStatistics&&(e=this.processComponentQueries(this.partitionedQueryExecutionInfo.hybridSearchQueryInfo.componentQueryInfos,this.globalStatisticsAggregator.getResult())),e)){let e={partitionedQueryExecutionInfoVersion:1,queryInfo:t,queryRanges:this.partitionedQueryExecutionInfo.queryRanges},i="string"==typeof this.query?t.rewrittenQuery:{query:t.rewrittenQuery,parameters:this.query?.parameters??[]},n=new nE(this.clientContext,this.collectionLink,i,this.options,e,this.correlatedActivityId,this.emitRawOrderByPayload);this.componentsExecutionContext.push(n)}this.isSingleComponent=1===this.componentsExecutionContext.length}processComponentQueries(e,t){return e.map(i=>{let n=i.orderByExpressions;if(i.orderBy&&i.orderBy.length>0){if(!i.hasNonStreamingOrderBy)throw Error("The component query must have a non-streaming order by clause.");n=i.orderByExpressions.map(i=>this.replacePlaceholdersWorkaroud(i,t,e.length))}return{...i,rewrittenQuery:this.replacePlaceholdersWorkaroud(i.rewrittenQuery,t,e.length),orderByExpressions:n}})}replacePlaceholdersWorkaroud(e,t,i){if(!t||!t.documentCount||!Array.isArray(t.fullTextStatistics))throw Error("GlobalStats validation failed");e=e.replace(RegExp(`{${this.TOTAL_DOCUMENT_COUNT_PLACEHOLDER}}`,"g"),t.documentCount.toString());let n=0;for(let r=0;r<i;r++){let i=`{${this.TOTAL_WORD_COUNT_PLACEHOLDER}-${r}}`,o=`{${this.HIT_COUNTS_ARRAY_PLACEHOLDER}-${r}}`;if(!e.includes(i))continue;let s=t.fullTextStatistics[n];e=(e=e.replace(RegExp(i,"g"),s.totalWordCount.toString())).replace(RegExp(o,"g"),`[${s.hitCounts.join(",")}]`),n++}return e}computeRRFScore=(e,t,i)=>{if(e.length!==i.length)throw Error("Ranks and component weights length mismatch");let n=0;for(let r=0;r<e.length;r++)n+=1/(t+e[r])*i[r].weight;return n};extractComponentWeights(){let e=this.partitionedQueryExecutionInfo.hybridSearchQueryInfo,t=!e.componentWeights||0===e.componentWeights.length,i=[];for(let n=0;n<e.componentQueryInfos.length;++n){let r=e.componentQueryInfos[n];if(r.orderBy&&r.orderBy.length>0){if(!r.hasNonStreamingOrderBy)throw Error("The component query should have a non streaming order by");if(!r.orderByExpressions||1!==r.orderByExpressions.length)throw Error("The component query should have exactly one order by expression")}let o=t?1:e.componentWeights[n],s=r.orderBy&&r.orderBy.length>0&&r.orderBy[0].includes("Ascending")?1:-1;i.push({weight:o,comparator:(e,t)=>s*(e-t)})}return i}}class nv{clientContext;query;options;fetchFunctions;resourceLink;resourceType;fetchAllTempResources;fetchAllLastResHeaders;queryExecutionContext;queryPlanPromise;isInitialized;correlatedActivityId;partitionKeyRangeCache;constructor(e,t,i,n,r,o){this.clientContext=e,this.query=t,this.options=i,this.fetchFunctions=n,this.resourceLink=r,this.resourceType=o,this.query=t,this.fetchFunctions=n,this.options=i||{},this.resourceLink=r,this.fetchAllLastResHeaders=tA(),this.reset(),this.isInitialized=!1,this.partitionKeyRangeCache=this.clientContext.partitionKeyRangeCache}async *getAsyncIterator(){let e=new t$(this.clientContext.diagnosticLevel,ef.CLIENT_REQUEST_NODE,null);yield*this.getAsyncIteratorInternal(e)}async *getAsyncIteratorInternal(e){for(this.reset(),this.queryPlanPromise=this.fetchQueryPlan(e);this.queryExecutionContext.hasMoreResults();){let t;try{t=await this.queryExecutionContext.fetchMore(e)}catch(i){if(this.needsQueryPlan(i)){await this.createExecutionContext(e);try{t=await this.queryExecutionContext.fetchMore(e)}catch(e){this.handleSplitError(e)}}else throw i}let i=new tD(t.result,t.headers,this.queryExecutionContext.hasMoreResults(),e.toDiagnostic(this.clientContext.getClientConfig()));e=new t$(this.clientContext.diagnosticLevel,ef.CLIENT_REQUEST_NODE,null),void 0!==t.result&&(yield i)}}hasMoreResults(){return this.queryExecutionContext.hasMoreResults()}async fetchAll(){return tZ(async e=>this.fetchAllInternal(e),this.clientContext)}async fetchAllInternal(e){let t;this.reset();try{t=await this.toArrayImplementation(e)}catch(e){this.handleSplitError(e)}return t}async fetchNext(){return tZ(async e=>this.fetchNextInternal(e),this.clientContext)}async fetchNextInternal(e){let t;this.queryPlanPromise=tY(async e=>this.fetchQueryPlan(e),e,ep.QueryPlanLookUp),this.isInitialized||await this.init(e);try{t=await this.queryExecutionContext.fetchMore(e)}catch(i){if(this.needsQueryPlan(i)){await this.createExecutionContext(e);try{t=await this.queryExecutionContext.fetchMore(e)}catch(e){this.handleSplitError(e)}}else throw i}return new tD(t.result,t.headers,this.queryExecutionContext.hasMoreResults(),tG())}reset(){this.correlatedActivityId=tV(),this.queryPlanPromise=void 0,this.fetchAllLastResHeaders=tA(),this.fetchAllTempResources=[],this.queryExecutionContext=new iW(this.options,this.fetchFunctions,this.correlatedActivityId)}async toArrayImplementation(e){for(this.queryPlanPromise=tY(async e=>this.fetchQueryPlan(e),e,ep.QueryPlanLookUp),this.isInitialized||await this.init(e);this.queryExecutionContext.hasMoreResults();){let t;try{t=await this.queryExecutionContext.fetchMore(e)}catch(i){if(this.needsQueryPlan(i))await this.createExecutionContext(e),t=await this.queryExecutionContext.fetchMore(e);else throw i}let{result:i,headers:n}=t;tM(this.fetchAllLastResHeaders,n),i&&this.fetchAllTempResources.push(...i)}return new tD(this.fetchAllTempResources,this.fetchAllLastResHeaders,this.queryExecutionContext.hasMoreResults(),tG())}async createExecutionContext(e){let t=await this.queryPlanPromise;if(t instanceof Error)throw t;let i=t.result;i.hybridSearchQueryInfo&&null!==i.hybridSearchQueryInfo?await this.createHybridQueryExecutionContext(i,e):await this.createPipelinedExecutionContext(i)}async createHybridQueryExecutionContext(e,t){let i=(await this.partitionKeyRangeCache.onCollectionRoutingMap(this.resourceLink,t)).getOrderedParitionKeyRanges().map(e=>({min:e.minInclusive,max:e.maxExclusive,isMinInclusive:!0,isMaxInclusive:!1}));this.queryExecutionContext=new nb(this.clientContext,this.resourceLink,this.query,this.options,e,this.correlatedActivityId,i)}async createPipelinedExecutionContext(e){let t=e.queryInfo;if(t.aggregates.length>0&&!1===t.hasSelectValue)throw Error("Aggregate queries must use the VALUE keyword");this.queryExecutionContext=new nE(this.clientContext,this.resourceLink,this.query,this.options,e,this.correlatedActivityId)}async fetchQueryPlan(e){return this.queryPlanPromise||this.resourceType!==K.item?this.queryPlanPromise:this.clientContext.getQueryPlan(T(this.resourceLink)+"/docs",K.item,this.resourceLink,this.query,this.options,e,this.correlatedActivityId).catch(e=>e)}needsQueryPlan(e){if(e.body?.additionalErrorInfo||e.message.includes("Cross partition query only supports"))return e.code===k.BadRequest&&this.resourceType===K.item;throw e}initPromise;async init(e){if(!0!==this.isInitialized)return void 0===this.initPromise&&(this.initPromise=this._init(e)),this.initPromise}async _init(e){!0===this.options.forceQueryPlan&&this.resourceType===K.item&&await this.createExecutionContext(e),this.isInitialized=!0}handleSplitError(e){if(410===e.code){let t=Error("Encountered partition split and could not recover. This request is retryable");throw t.code=503,t.originalError=e,t}throw e}}class nT extends tm{constructor(e,t,i,n,r){super(e,t,i,r),this.conflict=n}conflict}class nS{container;id;clientContext;partitionKey;get url(){return`/${this.container.url}/${s.Path.ConflictsPathSegment}/${this.id}`}constructor(e,t,i,n){this.container=e,this.id=t,this.clientContext=i,this.partitionKey=n,this.partitionKey=n}async read(e){return tZ(async t=>{let i=T(this.url,K.conflicts),n=v(this.url),r=await this.clientContext.read({path:i,resourceType:K.user,resourceId:n,options:e,diagnosticNode:t});return new nT(r.result,r.headers,r.code,this,tG())},this.clientContext)}async delete(e){return tZ(async t=>{if(void 0===this.partitionKey){let e=await ta(t,this.container);this.partitionKey=td(e)}let i=T(this.url),n=v(this.url),r=await this.clientContext.delete({path:i,resourceType:K.conflicts,resourceId:n,options:e,partitionKey:this.partitionKey,diagnosticNode:t});return new nT(r.result,r.headers,r.code,this,tG())},this.clientContext)}}class nI{container;clientContext;constructor(e,t){this.container=e,this.clientContext=t}query(e,t){let i=T(this.container.url,K.conflicts),n=v(this.container.url);return new nv(this.clientContext,e,t,(t,r)=>this.clientContext.queryFeed({path:i,resourceType:K.conflicts,resourceId:n,resultFn:e=>e.Conflicts,query:e,options:r,diagnosticNode:t}))}readAll(e){return this.query(void 0,e)}}!function(e){e.Custom="Custom",e.LastWriterWins="LastWriterWins"}(ex||(ex={}));class nP extends tm{constructor(e,t,i,n,r,o){super(e,t,i,o,n),this.item=r}item}class nA{container;id;clientContext;partitionKey;get url(){var e,t,i;return e=this.container.database.id,t=this.container.id,function(e){if("string"!=typeof e||S(e))throw Error("Resource ID must be a string and cannot be undefined, null or empty");if(g.test(e))throw Error("Illegal characters ['/', '\\', '#'] cannot be used in Resource ID")}(i=I(i=this.id)),F(e,t)+"/"+s.Path.DocumentsPathSegment+"/"+i}constructor(e,t,i,n){this.container=e,this.id=t,this.clientContext=i,this.partitionKey=void 0===n?void 0:to(n)}async read(e={}){return tZ(async t=>{let i;this.partitionKey=await tp(t,this.container,this.partitionKey);let n=this.url,r=this.partitionKey;try{if(this.clientContext.enableEncryption){await this.container.checkAndInitializeEncryption(),e.containerRid=this.container._rid;let i=0;t.beginEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation);let{partitionKeyList:o,encryptedCount:a}=await this.container.encryptionProcessor.getEncryptedPartitionKeyValue(this.partitionKey);r=o,i+=a,await this.container.encryptionProcessor.isPathEncrypted("/id")&&(n=await this.container.encryptionProcessor.getEncryptedUrl(this.url),i++),t.endEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation,i)}let o=T(n),a=v(n),c=this.clientContext.isPartitionLevelFailOverEnabled(),l=await tc(t,r,this.clientContext.partitionKeyRangeCache,c,this.container);i=await this.clientContext.read({path:o,resourceType:K.item,resourceId:a,options:e,partitionKey:r,diagnosticNode:t,partitionKeyRangeId:l})}catch(e){if(this.clientContext.enableEncryption&&await this.container.throwIfRequestNeedsARetryPostPolicyRefresh(e),e.code!==k.NotFound)throw e;i=e}if(this.clientContext.enableEncryption){t.beginEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation);let{body:e,propertiesDecryptedCount:n}=await this.container.encryptionProcessor.decrypt(i.result);t.endEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation,n),i.result=e}return new nP(i.result,i.headers,i.code,i.substatus,this,tG())},this.clientContext)}async replace(e,t={}){return tZ(async i=>{let n;this.partitionKey=await tp(i,this.container,this.partitionKey);let r=this.partitionKey,o={};if(!b(e,o))throw o;let a=this.url;try{if(this.clientContext.enableEncryption){e=M(e),t=t||{},await this.container.checkAndInitializeEncryption(),t.containerRid=this.container._rid;let n=0;i.beginEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation);let{body:o,propertiesEncryptedCount:c}=await this.container.encryptionProcessor.encrypt(e);e=o,n+=c;let{partitionKeyList:l,encryptedCount:u}=await this.container.encryptionProcessor.getEncryptedPartitionKeyValue(this.partitionKey);r=l,n+=u,await this.container.encryptionProcessor.isPathEncrypted("/id")&&(a=await this.container.encryptionProcessor.getEncryptedUrl(this.url),n++),i.endEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation,n)}let o=T(a),c=v(a),l=this.clientContext.isPartitionLevelFailOverEnabled(),u=await tc(i,r,this.clientContext.partitionKeyRangeCache,l,this.container);n=await this.clientContext.replace({body:e,path:o,resourceType:K.item,resourceId:c,options:t,partitionKey:r,diagnosticNode:i,partitionKeyRangeId:u})}catch(e){throw this.clientContext.enableEncryption&&await this.container.throwIfRequestNeedsARetryPostPolicyRefresh(e),e}if(this.clientContext.enableEncryption)try{i.beginEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation);let{body:e,propertiesDecryptedCount:t}=await this.container.encryptionProcessor.decrypt(n.result);n.result=e,i.endEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation,t)}catch(t){let e=new d(`Item replace operation was successful but response decryption failed: + ${t.message}`);throw e.code=k.ServiceUnavailable,e}return new nP(n.result,n.headers,n.code,n.substatus,this,tG())},this.clientContext)}async delete(e={}){return tZ(async t=>{let i;this.partitionKey=await tp(t,this.container,this.partitionKey);let n=this.partitionKey,r=this.url;try{if(this.clientContext.enableEncryption){await this.container.checkAndInitializeEncryption(),e.containerRid=this.container._rid;let i=0;t.beginEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation);let{partitionKeyList:o,encryptedCount:a}=await this.container.encryptionProcessor.getEncryptedPartitionKeyValue(this.partitionKey);n=o,i+=a,await this.container.encryptionProcessor.isPathEncrypted("/id")&&(r=await this.container.encryptionProcessor.getEncryptedUrl(this.url),i++),t.endEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation,i)}let o=T(r),a=v(r),c=this.clientContext.isPartitionLevelFailOverEnabled(),l=await tc(t,n,this.clientContext.partitionKeyRangeCache,c,this.container);i=await this.clientContext.delete({path:o,resourceType:K.item,resourceId:a,options:e,partitionKey:n,diagnosticNode:t,partitionKeyRangeId:l})}catch(e){throw this.clientContext.enableEncryption&&await this.container.throwIfRequestNeedsARetryPostPolicyRefresh(e),e}return new nP(i.result,i.headers,i.code,i.substatus,this,tG())},this.clientContext)}async patch(e,t={}){return tZ(async i=>{let n;this.partitionKey=await tp(i,this.container,this.partitionKey);let r=this.url,o=this.partitionKey;try{if(this.clientContext.enableEncryption){await this.container.checkAndInitializeEncryption(),t.containerRid=this.container._rid,e=M(e);let n=Array.isArray(e)?e:e.operations;i.beginEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation);let a=0;for(let e of n)if(e.op!==iQ.remove&&await this.container.encryptionProcessor.isPathEncrypted(e.path)){if(e.op===iQ.incr)throw new d(`Increment patch operation is not allowed for encrypted path '${e.path}'`);"value"in e&&(e.value=await this.container.encryptionProcessor.encryptProperty(e.path,e.value)),a++}let{partitionKeyList:c,encryptedCount:l}=await this.container.encryptionProcessor.getEncryptedPartitionKeyValue(o);o=c,a+=l,await this.container.encryptionProcessor.isPathEncrypted("/id")&&(r=await this.container.encryptionProcessor.getEncryptedUrl(this.url),a++),i.endEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation,a)}let a=T(r),c=v(r),l=this.clientContext.isPartitionLevelFailOverEnabled(),u=await tc(i,o,this.clientContext.partitionKeyRangeCache,l,this.container);n=await this.clientContext.patch({body:e,path:a,resourceType:K.item,resourceId:c,options:t,partitionKey:o,diagnosticNode:i,partitionKeyRangeId:u})}catch(e){throw this.clientContext.enableEncryption&&await this.container.throwIfRequestNeedsARetryPostPolicyRefresh(e),e}if(this.clientContext.enableEncryption)try{i.beginEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation);let{body:e,propertiesDecryptedCount:t}=await this.container.encryptionProcessor.decrypt(n.result);n.result=e,i.endEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation,t)}catch(t){let e=new d(`Item patch operation was successful but response decryption failed: + ${t.message}`);throw e.code=k.ServiceUnavailable,e}return new nP(n.result,n.headers,n.code,n.substatus,this,tG())},this.clientContext)}}class nM{result;count;statusCode;diagnostics;constructor(e,t,i,n,r){this.result=e,this.count=t,this.statusCode=i,this.diagnostics=r,this.headers=Object.freeze(n)}get requestCharge(){let e=this.headers[s.HttpHeaders.RequestCharge];return e?parseInt(e,10):null}get activityId(){return this.headers[s.HttpHeaders.ActivityId]}get continuation(){return this.etag}get sessionToken(){return this.headers[s.HttpHeaders.SessionToken]}get etag(){return this.headers[s.HttpHeaders.ETag]}headers}class nD{clientContext;resourceId;resourceLink;partitionKey;changeFeedOptions;static IfNoneMatchAllHeaderValue="*";nextIfNoneMatch;ifModifiedSince;lastStatusCode;isPartitionSpecified;constructor(e,t,i,n,r){this.clientContext=e,this.resourceId=t,this.resourceLink=i,this.partitionKey=n,this.changeFeedOptions=r,this.isPartitionSpecified=void 0!==n;let o=!0;r.continuation&&(this.nextIfNoneMatch=r.continuation,o=!1),r.startTime&&(this.ifModifiedSince=r.startTime.toUTCString(),o=!1),o&&!r.startFromBeginning&&(this.nextIfNoneMatch=nD.IfNoneMatchAllHeaderValue)}get hasMoreResults(){return this.lastStatusCode!==k.NotModified}async *getAsyncIterator(){do{let e=await this.fetchNext();e.count>0&&(yield e)}while(this.hasMoreResults)}async fetchNext(){return tZ(async e=>{let t=await this.getFeedResponse(e);return this.lastStatusCode=t.statusCode,this.nextIfNoneMatch=t.headers[s.HttpHeaders.ETag],t},this.clientContext)}async getFeedResponse(e){if(!this.isPartitionSpecified)throw Error("Container is partitioned, but no partition key or partition key range id was specified.");let t={initialHeaders:{},useIncrementalFeed:!0};"number"==typeof this.changeFeedOptions.maxItemCount&&(t.maxItemCount=this.changeFeedOptions.maxItemCount),this.changeFeedOptions.sessionToken&&(t.sessionToken=this.changeFeedOptions.sessionToken),this.nextIfNoneMatch&&(t.accessCondition={type:s.HttpHeaders.IfNoneMatch,condition:this.nextIfNoneMatch}),this.ifModifiedSince&&(t.initialHeaders[s.HttpHeaders.IfModifiedSince]=this.ifModifiedSince);let i=await this.clientContext.queryFeed({path:this.resourceLink,resourceType:K.item,resourceId:this.resourceId,resultFn:e=>e?e.Documents:[],query:void 0,options:t,partitionKey:this.partitionKey,diagnosticNode:e});return new nM(i.result,i.result?i.result.length:0,i.code,i.headers,tG())}}class nk extends nv{container;encryptionClientContext;encryptionOptions;constructor(e,t,i,n,r){super(e,t,i,n,r.url,K.item),this.container=r,this.encryptionClientContext=e,this.encryptionOptions=i}async *getAsyncIterator(){let e;let t=new t$(this.encryptionClientContext.diagnosticLevel,ef.CLIENT_REQUEST_NODE,null);try{e=yield*nv.prototype.getAsyncIteratorInternal.call(this,t)}catch(e){await this.container.throwIfRequestNeedsARetryPostPolicyRefresh(e)}if(e?.resources?.length>0){let i=0;for(let n of(t.beginEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation),e.resources)){let{body:e,propertiesDecryptedCount:t}=await this.container.encryptionProcessor.decrypt(n);n=e,i+=t}t.endEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation,i)}yield e}async fetchAll(){return tZ(async e=>{let t;try{t=await nv.prototype.fetchAllInternal.call(this,e)}catch(e){await this.container.throwIfRequestNeedsARetryPostPolicyRefresh(e)}if(t?.resources?.length>0){let i=0;for(let n of(e.beginEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation),t.resources)){let{body:e,propertiesDecryptedCount:t}=await this.container.encryptionProcessor.decrypt(n);n=e,i+=t}e.endEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation,i)}return t},this.encryptionClientContext)}async fetchNext(){return tZ(async e=>{let t;try{t=await nv.prototype.fetchNextInternal.call(this,e)}catch(e){await this.container.throwIfRequestNeedsARetryPostPolicyRefresh(e)}if(t?.resources?.length>0){let i=0;for(let n of(e.beginEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation),t.resources)){let{body:e,propertiesDecryptedCount:t}=await this.container.encryptionProcessor.decrypt(n);n=e,i+=t}e.endEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation,i)}return t},this.encryptionClientContext)}async init(e){await this.container.checkAndInitializeEncryption(),this.encryptionOptions.containerRid=this.container._rid,await nv.prototype.init.call(this,e)}}class nO{retryAfterInMs;retriesOn410;MaxRetriesOn410=10;SubstatusCodeBatchResponseSizeExceeded=3402;nextRetryPolicy;constructor(e){this.nextRetryPolicy=e,this.retriesOn410=0}async shouldRetry(e,t){if(!e)return!1;if(e.code===k.Gone){if(this.retriesOn410++,this.retriesOn410>this.MaxRetriesOn410)return!1;if(e.substatus===O.PartitionKeyRangeGone||e.substatus===O.CompletingSplit||e.substatus===O.CompletingPartitionMigration||e.substatus===O.NameCacheIsStale)return!0}if(e.code===k.RequestEntityTooLarge&&e.substatus===this.SubstatusCodeBatchResponseSizeExceeded)return!0;let i=!1;if(e.code===k.TooManyRequests){let n=await this.nextRetryPolicy.shouldRetry(e,t);i=Array.isArray(n)?n[0]:n}return i&&await E(this.nextRetryPolicy.retryAfterInMs),i}}class nL{currentRetryAttemptCount=0;cummulativeWaitTimeinMs=0;retryAfterInMs=0;timeoutInMs;maxTries;fixedRetryIntervalInMs;constructor(e){this.maxTries=e.maxRetryAttemptCount??s.ThrottledRequestMaxRetryAttemptCount,this.fixedRetryIntervalInMs=e.fixedRetryIntervalInMilliseconds??s.ThrottledRequestFixedRetryIntervalInMs;let t=e.maxWaitTimeInSeconds??s.ThrottledRequestMaxWaitTimeInSeconds;this.timeoutInMs=1e3*t,this.currentRetryAttemptCount=0,this.cummulativeWaitTimeinMs=0}async shouldRetry(e,t){return!!e&&this.currentRetryAttemptCount<this.maxTries&&(this.currentRetryAttemptCount++,this.retryAfterInMs=0,this.fixedRetryIntervalInMs?this.retryAfterInMs=this.fixedRetryIntervalInMs:e.retryAfterInMs&&(this.retryAfterInMs=e.retryAfterInMs),this.cummulativeWaitTimeinMs<this.timeoutInMs)&&(this.cummulativeWaitTimeinMs+=this.retryAfterInMs,t.addData({successfulRetryPolicy:"resourceThrottle"}),!0)}}class nF{batchOperationsList;currentSize;toBeDispatched;executor;retrier;diagnosticLevel;encryptionEnabled;encryptionProcessor;clientConfigDiagnostics;limiter;processedOperationCountRef;constructor(e,t,i,n,r,o,s,a){this.limiter=e,this.batchOperationsList=[],this.executor=t,this.retrier=i,this.diagnosticLevel=n,this.encryptionEnabled=r,this.encryptionProcessor=s,this.clientConfigDiagnostics=o,this.currentSize=0,this.toBeDispatched=!1,this.processedOperationCountRef=a}tryAdd(e){if(this.toBeDispatched)return!1;if(!e)throw new d("Operation is not defined");if(!e.operationContext)throw new d("Operation context is not defined");if(this.batchOperationsList.length===s.MaxBulkOperationsCount)return!1;let t=i_(e.operationInput);return(!(this.batchOperationsList.length>0)||!(this.currentSize+t>s.DefaultMaxBulkRequestBodySizeInBytes))&&(this.currentSize+=t,this.batchOperationsList.push(e),!0)}isEmpty(){return 0===this.batchOperationsList.length}async dispatch(e){this.toBeDispatched=!0;let t=t_(),i=new t$(this.diagnosticLevel,ef.BATCH_REQUEST,null);try{let n=await this.executor(this.batchOperationsList,i),r=n?.results?.some(e=>"code"in e&&e.code===k.TooManyRequests)?1:0;n?.results?.some(e=>"code"in e&&e.code===k.Gone)&&await this.limiter.pauseAndClear(k.Gone,i),e.add(this.batchOperationsList.length,t_()-t,r);for(let e=0;e<n.operations.length;e++){let t=n.operations[e],r=n.results[e];if(r instanceof d&&await t.operationContext.retryPolicy.shouldRetry(r,t.operationContext.diagnosticNode)){await this.retrier(t,t.operationContext.diagnosticNode);continue}try{if(this.encryptionEnabled&&r.resourceBody){t.operationContext.diagnosticNode.beginEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation);let{body:e,propertiesDecryptedCount:i}=await this.encryptionProcessor.decrypt(r.resourceBody);r.resourceBody=e,t.operationContext.diagnosticNode.endEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation,i)}}catch(e){if("Read"!==t.operationInput.operationType){let i=new d(`Item ${t.operationInput.operationType} operation was successful but response decryption failed: + ${e.message}`);throw i.code=k.ServiceUnavailable,i}}t.operationContext.addDiagnosticChild(i),r.diagnostics=t.operationContext.diagnosticNode.toDiagnostic(this.clientConfigDiagnostics);let o={operationInput:t.unencryptedOperationInput};r instanceof d?o.error=r:o.response=r,t.operationContext.complete(o),this.processedOperationCountRef.count++}}catch(e){for(let t of this.batchOperationsList){let i={operationInput:t.operationInput,error:Object.assign(new d(e.message),{code:k.InternalServerError,diagnostics:t.operationContext.diagnosticNode.toDiagnostic(this.clientConfigDiagnostics)})};t.operationContext.fail(i),this.processedOperationCountRef.count++}}finally{this.batchOperationsList=[]}}getOperations(){return this.batchOperationsList}}class nB{limiterQueue;oldPartitionMetric;partitionMetric;congestionWaitTimeInMs=1e3;congestionIncreaseFactor=1;congestionDecreaseFactor=5;currentDegreeOfConcurrency;constructor(e,t,i){this.limiterQueue=e,this.oldPartitionMetric=i,this.partitionMetric=t,this.currentDegreeOfConcurrency=1}run(){let e=this.partitionMetric.timeTakenInMs-this.oldPartitionMetric.timeTakenInMs;if(e>=this.congestionWaitTimeInMs){let t=this.partitionMetric.numberOfThrottles-this.oldPartitionMetric.numberOfThrottles,i=this.partitionMetric.numberOfItemsOperatedOn-this.oldPartitionMetric.numberOfItemsOperatedOn;this.oldPartitionMetric.add(i,e,t),t>0&&this.decreaseConcurrency(),i>0&&0===t&&this.increaseConcurrency()}}decreaseConcurrency(){let e=Math.min(this.congestionDecreaseFactor,Math.floor(this.currentDegreeOfConcurrency/2));this.currentDegreeOfConcurrency-=e,this.limiterQueue.setConcurrency(this.currentDegreeOfConcurrency),this.congestionWaitTimeInMs+=1e3}increaseConcurrency(){this.currentDegreeOfConcurrency+this.congestionIncreaseFactor<=s.BulkMaxDegreeOfConcurrency&&(this.currentDegreeOfConcurrency+=this.congestionIncreaseFactor,this.limiterQueue.setConcurrency(this.currentDegreeOfConcurrency))}}class nK{numberOfItemsOperatedOn;timeTakenInMs;numberOfThrottles;semaphore;constructor(){this.numberOfItemsOperatedOn=0,this.timeTakenInMs=0,this.numberOfThrottles=0,this.semaphore=i8(1)}add(e,t,i){this.semaphore.take(()=>{try{this.numberOfItemsOperatedOn+=e,this.timeTakenInMs+=t,this.numberOfThrottles+=i}finally{this.semaphore.leave()}})}}class nH{value;next=null;prev=null;constructor(e){this.value=e}}class nq{head=null;tail=null;length=0;push(e){let t=new nH(e);this.head?(this.tail.next=t,t.prev=this.tail,this.tail=t):this.head=this.tail=t,this.length++}shift(){if(!this.head)return null;let e=this.head.value;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,e}clear(){this.head=null,this.tail=null,this.length=0}isEmpty(){return 0===this.length}}class n_{concurrency;running=0;tasks=new nq;terminated=!1;terminatedValue;scheduled=!1;processing=!1;retrier;partitionMetric;refreshPartitionKeyRangeCache;refreshPKRangeCachePromise=void 0;constructor(e,t,i,n){this.concurrency=e,this.partitionMetric=t,this.retrier=i,this.refreshPartitionKeyRangeCache=n}push(e){return this.terminated?(e.getOperations().forEach(e=>this.retrier(e,e.operationContext.diagnosticNode)),Promise.resolve(this.terminatedValue)):new Promise((t,i)=>{this.tasks.push({batcher:e,resolve:t,reject:i}),this.scheduleProcess()})}async pauseAndClear(e,t){this.terminated=!0,this.terminatedValue=e;let i=[];for(;!this.tasks.isEmpty();){let t=this.tasks.shift();if(!t)break;if(e===k.Gone){let e=t.batcher.getOperations();i.push(...e)}t.resolve(e)}if(e===k.Gone)for(let e of(this.refreshPKRangeCachePromise||(this.refreshPKRangeCachePromise=this.refreshPartitionKeyRangeCache(t)),await this.refreshPKRangeCachePromise,i))await this.retrier(e,e.operationContext.diagnosticNode)}scheduleProcess(){if(!this.scheduled&&!this.processing&&!this.terminated){var e;this.scheduled=!0,e=()=>{this.scheduled=!1,this.process()},"undefined"!=typeof process&&"function"==typeof process.nextTick?process.nextTick(e):"function"==typeof setImmediate?setImmediate(e):Promise.resolve().then(e)}}process(){if(!this.terminated){this.processing=!0;try{for(;!this.terminated&&this.running<this.concurrency&&!this.tasks.isEmpty();){let e;let t=this.tasks.shift();if(!t)break;this.running++;try{e=t.batcher.dispatch(this.partitionMetric)}catch(e){t.reject(e),this.running--;continue}e.then(e=>{t.resolve(e)}).catch(e=>{t.reject(e)}).finally(()=>{this.running--,this.terminated||!(this.running<this.concurrency)||this.tasks.isEmpty()||this.scheduleProcess()})}}catch(e){console.error("Unexpected error in task queue processing:",e)}finally{this.processing=!1}}}setConcurrency(e){if(e<1)throw Error("Concurrency must be at least 1");this.concurrency=e,!this.terminated&&this.running<this.concurrency&&this.scheduleProcess()}}class nN{executor;retrier;currentBatcher;lock;partitionMetric;oldPartitionMetric;diagnosticLevel;encryptionEnabled;encryptionProcessor;clientConfigDiagnostics;congestionControlAlgorithm;dispatchLimiterQueue;initialConcurrency=1;processedOperationCountRef;constructor(e,t,i,n,r,o,s,a){this.executor=e,this.retrier=t,this.diagnosticLevel=n,this.encryptionEnabled=r,this.encryptionProcessor=s,this.clientConfigDiagnostics=o,this.oldPartitionMetric=new nK,this.partitionMetric=new nK,this.processedOperationCountRef=a,this.lock=i8(1),this.dispatchLimiterQueue=new n_(this.initialConcurrency,this.partitionMetric,this.retrier,i),this.congestionControlAlgorithm=new nB(this.dispatchLimiterQueue,this.partitionMetric,this.oldPartitionMetric),this.currentBatcher=this.createBatcher()}async add(e){return new Promise((t,i)=>{this.lock.take(()=>{try{for(;!this.currentBatcher.tryAdd(e);){let e=this.getBatchToQueueAndCreate();e&&this.dispatchLimiterQueue.push(e)}t()}catch(n){let t={operationInput:e.unencryptedOperationInput,error:Object.assign(Error(n.message),{code:k.InternalServerError,diagnostics:e.operationContext.diagnosticNode.toDiagnostic(this.clientConfigDiagnostics)})};e.operationContext.fail(t),this.processedOperationCountRef.count++,i(n)}finally{this.lock.leave()}})})}getBatchToQueueAndCreate(){if(this.currentBatcher.isEmpty())return null;let e=this.currentBatcher;return this.currentBatcher=this.createBatcher(),e}addPartialBatchToQueue(){this.lock.take(()=>{try{if(!this.currentBatcher.isEmpty()){let e=this.currentBatcher;this.currentBatcher=this.createBatcher(),this.dispatchLimiterQueue.push(e)}}finally{this.lock.leave()}})}createBatcher(){return new nF(this.dispatchLimiterQueue,this.executor,this.retrier,this.diagnosticLevel,this.encryptionEnabled,this.clientConfigDiagnostics,this.encryptionProcessor,this.processedOperationCountRef)}runCongestionAlgorithm(){this.congestionControlAlgorithm.run()}async dispose(){await this.dispatchLimiterQueue.pauseAndClear(null),this.currentBatcher=void 0}}class nU{pkRangeId;retryPolicy;diagnosticNode;taskCompletionSource;constructor(e,t,i){this.pkRangeId=e,this.retryPolicy=t,this.diagnosticNode=i,this.taskCompletionSource=new iU}get operationPromise(){return this.taskCompletionSource.task}addDiagnosticChild(e){this.diagnosticNode.addBulkChildNode(e,this.diagnosticNode.diagnosticLevel),e.updateTimestamp()}updatePKRangeId(e){this.pkRangeId=e}complete(e){this.taskCompletionSource.setResult(e)}fail(e){this.taskCompletionSource.setException(e.error)}}class nz{statusCode;subStatusCode;headers;operations;results=[];diagnostics;constructor(e,t,i,n){this.statusCode=e,this.subStatusCode=t,this.headers=i,this.operations=n}static createEmptyResponse(e,t,i,n){let r=new nz(t,i,n,e);return r.createAndPopulateResults(e,0,new d),r}static fromResponseMessage(e,t){let i=this.populateFromResponse(e,t);if(!i.results||i.results.length!==t.length){iN(e.code)&&(i=new nz(k.InternalServerError,O.Unknown,e.headers,t));let n=0;if(e.code===k.TooManyRequests){let t=e.headers?.[s.HttpHeaders.RetryAfterInMs];n=!t||isNaN(Number(t))?0:Number(t)}i.createAndPopulateResults(t,n,e)}return i}static populateFromResponse(e,t){let i=[];if(e.result)for(let n=0;n<t.length;n++){let t=e.result[n];if(iN(t?.statusCode)){let n={statusCode:t?.statusCode,eTag:t?.eTag,activityId:e.headers?.[s.HttpHeaders.ActivityId],sessionToken:e.headers?.[s.HttpHeaders.SessionToken],requestCharge:t?.requestCharge,resourceBody:t?.resourceBody,diagnostics:null,headers:e.headers};i.push(n)}else{let n=new d;n.code=t?.statusCode,n.substatus=t?.subStatusCode,n.message=t?.message,n.requestCharge=t?.requestCharge,n.body=t?.resourceBody,n.headers=e.headers,n.activityId=e.headers?.[s.HttpHeaders.ActivityId],n.retryAfterInMs=t?.retryAfterMilliseconds,n.diagnostics=e.diagnostics,i.push(n)}}let n=e.code,r=e.substatus;if(e.code===k.MultiStatus){for(let e of i)if(e instanceof d&&e.statusCode!==k.FailedDependency&&e.statusCode>=k.BadRequest){n="number"==typeof e.code?e.code:Number(e.code),r=e.substatus;break}}let o=new nz(n,r,e.headers,t);return o.results=i,o}createAndPopulateResults(e,t,i){this.results=e.map(()=>{let e=new d;return e.message=i.message,e.code=this.statusCode,e.substatus=this.subStatusCode,e.retryAfterInMs=t,e.activityId=this.headers?.[s.HttpHeaders.ActivityId],e.body=i.body,e.diagnostics=i.diagnostics,e.headers=this.headers,e.requestCharge=i.requestCharge,e})}}class nQ{container;clientContext;partitionKeyRangeCache;helpersByPartitionKeyRangeId;options;partitionKeyDefinition;partitionKeyDefinitionPromise;isCancelled;processedOperationCountRef={count:0};operationPromisesList=[];congestionControlTimer;congestionControlDelayInMs=1e3;staleRidError;operationsPerSleep=100;intervalForPartialBatchInMs=1e3;constructor(e,t,i,n){this.container=e,this.clientContext=t,this.partitionKeyRangeCache=i,this.helpersByPartitionKeyRangeId=new Map,this.options=n,this.executeRequest=this.executeRequest.bind(this),this.reBatchOperation=this.reBatchOperation.bind(this),this.refreshPartitionKeyRangeCache=this.refreshPartitionKeyRangeCache.bind(this),this.isCancelled=!1,this.runCongestionControlTimer()}async execute(e){let t=[];try{for(let i=0;i<e.length;i++)i%this.operationsPerSleep==0&&await E(0),t.push(this.addOperation(e[i],i));for(await Promise.allSettled(t);this.processedOperationCountRef.count<e.length;)this.helpersByPartitionKeyRangeId.forEach(e=>{e.addPartialBatchToQueue()}),await E(this.intervalForPartialBatchInMs)}finally{this.congestionControlTimer&&clearInterval(this.congestionControlTimer)}let i=await Promise.allSettled(this.operationPromisesList);if(this.isCancelled&&this.staleRidError)throw this.staleRidError;return i.map(e=>"fulfilled"===e.status?e.value:e.reason).map(e=>{if(e&&e.error){let{stack:t,...i}=e.error,n={message:e.error.message,...i};return{...e,error:n}}return e})}async addOperation(e,t){let i,n,r,o;if(this.isCancelled)return;if(!e){this.operationPromisesList[t]=Promise.resolve({operationInput:e,error:Object.assign(new d("Operation cannot be null or undefined."),{code:k.InternalServerError})});return}if(("Create"===e.operationType||"Upsert"===e.operationType||"Replace"===e.operationType)&&!e.resourceBody.id){this.operationPromisesList[t]=Promise.resolve({operationInput:e,error:Object.assign(new d(`Operation resource body must have an 'id' for ${e.operationType} operations.`),{code:k.InternalServerError})}),this.processedOperationCountRef.count++;return}if(void 0===e.partitionKey){this.operationPromisesList[t]=Promise.resolve({operationInput:e,error:Object.assign(new d(`PartitionKey is required for ${e.operationType} operations.`),{code:k.InternalServerError})}),this.processedOperationCountRef.count++;return}try{if(n=new t$(this.clientContext.diagnosticLevel,ef.CLIENT_REQUEST_NODE,null),this.partitionKeyDefinition||(this.partitionKeyDefinitionPromise||(this.partitionKeyDefinitionPromise=(async()=>{try{let e=await ta(n,this.container);return this.partitionKeyDefinition=e,e}finally{this.partitionKeyDefinitionPromise=null}})()),await this.partitionKeyDefinitionPromise),r=M(e),this.clientContext.enableEncryption){e=M(e),await this.container.checkAndInitializeEncryption(),n.beginEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation);let{operation:t,totalPropertiesEncryptedCount:i}=await iz(this.container.encryptionProcessor,e,0);e=t,n.endEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation,i)}o=await this.resolvePartitionKeyRangeId(e,n)}catch(e){i=e}let a=this.getHelperForPKRange(o),c=new nU(o,this.getRetryPolicy(),n),l={unencryptedOperationInput:r,operationInput:e,operationContext:c};if(this.operationPromisesList[t]=c.operationPromise,i){let e={operationInput:r,error:Object.assign(new d(i.message),{code:k.InternalServerError,diagnostics:n?.toDiagnostic(this.clientContext.getClientConfig())})};c.fail(e),this.processedOperationCountRef.count++;return}return a.add(l)}async resolvePartitionKeyRangeId(e,t){let i=(await this.partitionKeyRangeCache.onCollectionRoutingMap(this.container.url,t)).getOrderedParitionKeyRanges(),n=ih(to(e.partitionKey),this.partitionKeyDefinition),r=i.find(e=>iH(e.minInclusive,e.maxExclusive,n));if(!r)throw Error("No matching partition key range found for the operation.");return r.id}getRetryPolicy(){return new nO(new nL(this.clientContext.getRetryOptions()))}async executeRequest(e,t){if(this.isCancelled)throw new d("Bulk execution cancelled due to a previous error.");if(!e.length)return;let i=e[0].operationContext.pkRangeId,n=T(this.container.url,K.item),r=[];for(let t of e)r.push(this.prepareOperation(t.operationInput));this.options.containerRid||(this.options.containerRid=this.container._rid);try{let o=await tJ(async e=>this.clientContext.bulk({body:r,partitionKeyRangeId:i,path:n,resourceId:this.container.url,options:this.options,diagnosticNode:e}),t,ef.BATCH_REQUEST);if(!o)throw new d("Failed to fetch bulk response.");return nz.fromResponseMessage(o,e)}catch(t){if(this.clientContext.enableEncryption)try{await this.container.throwIfRequestNeedsARetryPostPolicyRefresh(t)}catch(t){return await this.cancelExecution(t),nz.createEmptyResponse(e,0,0,{})}return nz.fromResponseMessage(t,e)}}prepareOperation(e){return e.partitionKey=to(e.partitionKey),{...e,partitionKey:JSON.stringify(e.partitionKey)}}async reBatchOperation(e,t){let i=await this.resolvePartitionKeyRangeId(e.operationInput,t);e.operationContext.updatePKRangeId(i);let n=this.getHelperForPKRange(i);await n.add(e)}async cancelExecution(e){for(let t of(this.isCancelled=!0,this.staleRidError=e,this.helpersByPartitionKeyRangeId.values()))await t.dispose();this.helpersByPartitionKeyRangeId.clear()}getHelperForPKRange(e){if(this.helpersByPartitionKeyRangeId.has(e))return this.helpersByPartitionKeyRangeId.get(e);let t=new nN(this.executeRequest,this.reBatchOperation,this.refreshPartitionKeyRangeCache,this.clientContext.diagnosticLevel,this.clientContext.enableEncryption,this.clientContext.getClientConfig(),this.container.encryptionProcessor,this.processedOperationCountRef);return this.helpersByPartitionKeyRangeId.set(e,t),t}runCongestionControlTimer(){this.congestionControlTimer=setInterval(()=>{this.helpersByPartitionKeyRangeId.forEach(e=>{e.runCongestionAlgorithm()})},this.congestionControlDelayInMs)}async refreshPartitionKeyRangeCache(e){await this.partitionKeyRangeCache.onCollectionRoutingMap(this.container.url,e,!0)}}function nV(e){return e&&!(tf(e)||Array.isArray(e))}class nW{container;clientContext;partitionKeyRangeCache;constructor(e,t){this.container=e,this.clientContext=t,this.partitionKeyRangeCache=this.clientContext.partitionKeyRangeCache}query(e,t={}){let i=T(this.container.url,K.item),n=v(this.container.url),r=async(r,o,s)=>{let a;t.partitionKey&&(a=to(t.partitionKey));let c=this.clientContext.isPartitionLevelFailOverEnabled(),l=await tc(r,a,this.partitionKeyRangeCache,c,this.container);return await this.clientContext.queryFeed({path:i,resourceType:K.item,resourceId:n,resultFn:e=>e?e.Documents:[],query:e,options:o,partitionKey:t.partitionKey,diagnosticNode:r,correlatedActivityId:s,partitionKeyRangeId:l})};return this.clientContext.enableEncryption?new nk(this.clientContext,e,t,r,this.container):new nv(this.clientContext,e,t,r,this.container.url,K.item)}async getEncryptionQueryIterator(e,t={}){let i=e.toEncryptionSqlQuerySpec(),n=await this.buildSqlQuerySpec(i);if(this.clientContext.enableEncryption&&t.partitionKey){await this.container.checkAndInitializeEncryption();let{partitionKeyList:e,encryptedCount:i}=await this.container.encryptionProcessor.getEncryptedPartitionKeyValue([t.partitionKey]);i>0&&(t.partitionKey=e[0])}return this.query(n,t)}async buildSqlQuerySpec(e){let t=e.parameters,i={query:e.query,parameters:[]};for(let e of t=M(t)){let t;(void 0!==e.type||e.type!==G.Null)&&(t=await this.container.encryptionProcessor.encryptQueryParameter(e.path,e.value,"/id"===e.path,e.type)),i.parameters.push({name:e.name,value:t})}return i}readChangeFeed(e,t){return nV(e)?this.changeFeed(e):this.changeFeed(e,t)}changeFeed(e,t){let i;!t&&nV(e)?(i=void 0,t=e):void 0===e||nV(e)||(i=e),t||(t={});let n=T(this.container.url,K.item),r=v(this.container.url);return new nD(this.clientContext,r,n,i,t)}getChangeFeedIterator(e){let t=void 0!==e?e:{};return function(e){if(!("object"==typeof e&&(0===Object.keys(e).length&&"{}"===JSON.stringify(e)||e&&!(tf(e)||Array.isArray(e)))))throw new d("Invalid Changefeed Iterator Options.");if(e?.maxItemCount&&"number"!=typeof e?.maxItemCount)throw new d("maxItemCount must be number");if(e?.maxItemCount!==void 0&&e?.maxItemCount<1)throw new d("maxItemCount must be a positive number")}(t),new iL(t,this.clientContext,this.container,this.partitionKeyRangeCache)}readAll(e){return this.query("SELECT * from c",e)}async create(e,t={}){return tZ(async i=>{let n;void 0!==e.id&&""!==e.id||t.disableAutomaticIdGeneration||(e.id=tV());let r=await ta(i,this.container),o=tu(e,r);try{if(this.clientContext.enableEncryption){await this.container.checkAndInitializeEncryption(),t.containerRid=this.container._rid,e=M(e),i.beginEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation);let{body:n,propertiesEncryptedCount:a}=await this.container.encryptionProcessor.encrypt(e);e=n,i.endEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation,a),o=tu(e,r)}let a={};if(!b(e,a))throw a;let c=T(this.container.url,K.item),l=v(this.container.url),u=this.clientContext.isPartitionLevelFailOverEnabled(),h=await tc(i,o,this.partitionKeyRangeCache,u,this.container,r);n=await this.clientContext.create({body:e,path:c,resourceType:K.item,resourceId:l,diagnosticNode:i,options:t,partitionKey:o,partitionKeyRangeId:h})}catch(e){throw this.clientContext.enableEncryption&&await this.container.throwIfRequestNeedsARetryPostPolicyRefresh(e),e}if(this.clientContext.enableEncryption)try{i.beginEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation);let{body:e,propertiesDecryptedCount:t}=await this.container.encryptionProcessor.decrypt(n.result);i.endEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation,t),n.result=e,o=tu(n.result,r)}catch(t){let e=new d(`Item creation was successful but response decryption failed: + ${t.message}`);throw e.code=k.ServiceUnavailable,e}let a=new nA(this.container,n.result.id,this.clientContext,o);return new nP(n.result,n.headers,n.code,n.substatus,a,tG())},this.clientContext)}async upsert(e,t={}){return tZ(async i=>{let n;void 0!==e.id&&""!==e.id||t.disableAutomaticIdGeneration||(e.id=tV());let r=await ta(i,this.container),o=tu(e,r);try{if(this.clientContext.enableEncryption){e=M(e),t=t||{},await this.container.checkAndInitializeEncryption(),t.containerRid=this.container._rid,i.beginEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation);let{body:n,propertiesEncryptedCount:a}=await this.container.encryptionProcessor.encrypt(e);e=n,i.endEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation,a),o=tu(e,r)}let a={};if(!b(e,a))throw a;let c=T(this.container.url,K.item),l=v(this.container.url),u=this.clientContext.isPartitionLevelFailOverEnabled(),h=await tc(i,o,this.partitionKeyRangeCache,u,this.container,r);n=await this.clientContext.upsert({body:e,path:c,resourceType:K.item,resourceId:l,options:t,partitionKey:o,diagnosticNode:i,partitionKeyRangeId:h})}catch(e){throw this.clientContext.enableEncryption&&await this.container.throwIfRequestNeedsARetryPostPolicyRefresh(e),e}if(this.clientContext.enableEncryption)try{i.beginEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation);let{body:e,propertiesDecryptedCount:t}=await this.container.encryptionProcessor.decrypt(n.result);i.endEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation,t),n.result=e,o=tu(n.result,r)}catch(t){let e=new d(`Item upsert was successful but response decryption failed: + ${t.message}`);throw e.code=k.ServiceUnavailable,e}let a=new nA(this.container,n.result.id,this.clientContext,o);return new nP(n.result,n.headers,n.code,n.substatus,a,tG())},this.clientContext)}async executeBulkOperations(e,t={}){return new nQ(this.container,this.clientContext,this.partitionKeyRangeCache,t).execute(e)}async bulk(e,t,i){return tZ(async n=>{let r=(await this.partitionKeyRangeCache.onCollectionRoutingMap(this.container.url,n)).getOrderedParitionKeyRanges(),o=await ta(n,this.container);if(this.clientContext.enableEncryption){e=M(e),i=i||{},await this.container.checkAndInitializeEncryption(),i.containerRid=this.container._rid,n.beginEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation);let{operations:t,totalPropertiesEncryptedCount:r}=await this.bulkBatchEncryptionHelper(e);e=t,n.endEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation,r)}let a=r.map(e=>({min:e.minInclusive,max:e.maxExclusive,rangeId:e.id,indexes:[],operations:[]}));this.groupOperationsBasedOnPartitionKey(e,o,i,a);let c=T(this.container.url,K.item),l=[],u=a.filter(e=>e.operations.length).flatMap(e=>(function(e){if(e?.operations===void 0||e.operations.length<1)return[];let t=i_(e.operations[0]),i={...e,operations:[e.operations[0]],indexes:[e.indexes[0]]},n=[];n.push(i);for(let r=1;r<e.operations.length;r++){let o=e.operations[r],a=i_(o);t+a>s.DefaultMaxBulkRequestBodySizeInBytes&&(i={...e,operations:[],indexes:[]},n.push(i),t=0),i.operations.push(o),i.indexes.push(e.indexes[r]),t+=a}return n})(e));return await Promise.all(this.executeBatchOperations(u,c,t,i,n,l,o)),l.diagnostics=n.toDiagnostic(this.clientContext.getClientConfig()),l},this.clientContext)}executeBatchOperations(e,t,i,n,r,o,a){return e.map(async e=>{let c;if(e.operations.length>100)throw Error("Cannot run bulk request with more than 100 operations per partition");try{(c=await tJ(async r=>this.clientContext.bulk({body:e.operations,partitionKeyRangeId:e.rangeId,path:t,resourceId:this.container.url,bulkOptions:i,options:n,diagnosticNode:r}),r,ef.BATCH_REQUEST)).result.forEach((t,i)=>{o[e.indexes[i]]=t})}catch(s){if(this.clientContext.enableEncryption&&await this.container.throwIfRequestNeedsARetryPostPolicyRefresh(s),s.code===k.Gone){if(s.substatus===O.PartitionKeyRangeGone||s.substatus===O.CompletingSplit){let s=new tK(e.min,e.max,!0,!1),c=await this.partitionKeyRangeCache.getOverlappingRanges(this.container.url,s,r,!0);if(c.length<1)throw Error("Partition split/merge detected but no overlapping ranges found.");if(c.length>=1){let s=this.createNewBatches(c,e,a);await Promise.all(this.executeBatchOperations(s,t,i,n,r,o,a))}}else throw Error("Partition key error. An operation has an unsupported partitionKey type"+s.message)}else throw Error(`Bulk request errored with: ${s.message}`)}if(c){try{if(this.clientContext.enableEncryption){r.beginEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation);let e=0;for(let t of c.result)if(t.resourceBody){let{body:i,propertiesDecryptedCount:n}=await this.container.encryptionProcessor.decrypt(t.resourceBody);t.resourceBody=i,e+=n}r.endEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation,e)}}catch(t){let e=new d(`Batch response was received but response decryption failed: + ${t.message}`);throw e.code=k.ServiceUnavailable,e}c.result.forEach((t,i)=>{o[e.indexes[i]]=t})}})}createNewBatches(e,t,i){let n=e.map(e=>({min:e.minInclusive,max:e.maxExclusive,rangeId:e.id,indexes:[],operations:[]})),r=0;return t.operations.forEach(e=>{let o=ih(ty(JSON.parse(e.partitionKey),"undefined value for PartitionKey is not expected during grouping of bulk operations."),i),s=ty(n.find(e=>iH(e.min,e.max,o)),"No suitable Batch found.");s.operations.push(e),s.indexes.push(t.indexes[r]),r++}),n}groupOperationsBasedOnPartitionKey(e,t,i,n){e.forEach((e,r)=>{let{operation:o,partitionKey:s}=function(e,t,i={}){let n;if(e.operationType!==iq.Create&&e.operationType!==iq.Upsert||void 0!==e.resourceBody.id&&""!==e.resourceBody.id||i.disableAutomaticIdGeneration||(e.resourceBody.id=tV()),Object.prototype.hasOwnProperty.call(e,"partitionKey"))n=void 0===e.partitionKey?t.paths.map(()=>tr):to(e.partitionKey);else switch(e.operationType){case iq.Create:case iq.Replace:case iq.Upsert:n=ty(tu(e.resourceBody,t),"Unexpected undefined Partition Key Found.");break;case iq.Read:case iq.Delete:case iq.Patch:n=td(t)}return{operation:{...e,partitionKey:JSON.stringify(n)},partitionKey:n}}(e,t,i),a=ih(ty(s,"undefined value for PartitionKey is not expected during grouping of bulk operations."),t),c=ty(n.find(e=>iH(e.min,e.max,a)),"No suitable Batch found.");c.operations.push(o),c.indexes.push(r)})}async batch(e,t,i){return tZ(async n=>{let r;e.map(e=>(function(e,t={}){return e.operationType!==iq.Create&&e.operationType!==iq.Upsert||void 0!==e.resourceBody.id&&""!==e.resourceBody.id||t.disableAutomaticIdGeneration||(e.resourceBody.id=tV()),e})(e,i)),t=await tp(n,this.container,t);let o=T(this.container.url,K.item);if(e.length>100)throw Error("Cannot run batch request with more than 100 operations per partition");for(let t of e)t&&void 0!==t.partitionKey&&(t.partitionKey=JSON.stringify(to(t.partitionKey)));try{if(this.clientContext.enableEncryption){e=M(e),i=i||{},await this.container.checkAndInitializeEncryption(),i.containerRid=this.container._rid;let r=0;if(n.beginEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation),t){let e=to(t),{partitionKeyList:i,encryptedCount:n}=await this.container.encryptionProcessor.getEncryptedPartitionKeyValue(e);t=i,r+=n}let{operations:o,totalPropertiesEncryptedCount:a}=await this.bulkBatchEncryptionHelper(e);e=o,r+=a,n.endEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation,r)}let a=this.clientContext.isPartitionLevelFailOverEnabled(),c=await tc(n,t,this.partitionKeyRangeCache,a,this.container);r=await this.clientContext.batch({body:e,partitionKey:t,path:o,resourceId:this.container.url,options:i,diagnosticNode:n,partitionKeyRangeId:c})}catch(e){throw this.clientContext.enableEncryption&&await this.container.throwIfRequestNeedsARetryPostPolicyRefresh(e),Error(`Batch request error: ${e.message}`)}if(this.clientContext.enableEncryption)try{n.beginEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation);let e=0;for(let t of r.result)if(t.resourceBody){let{body:i,propertiesDecryptedCount:n}=await this.container.encryptionProcessor.decrypt(t.resourceBody);t.resourceBody=i,e+=n}n.endEncryptionDiagnostics(s.Encryption.DiagnosticsDecryptOperation,e)}catch(t){let e=new d(`Batch response was received but response decryption failed: + ${t.message}`);throw e.code=k.ServiceUnavailable,e}return r},this.clientContext)}async bulkBatchEncryptionHelper(e){let t=0,i=[];for(let n of e){let{operation:e,totalPropertiesEncryptedCount:r}=await iz(this.container.encryptionProcessor,n,t);t=r,i.push(e)}return{operations:i,totalPropertiesEncryptedCount:t}}}class n$ extends tm{constructor(e,t,i,n,r){super(e,t,i,r),this.storedProcedure=n}storedProcedure;get sproc(){return this.storedProcedure}}class nj{container;id;clientContext;get url(){var e,t,i;return e=this.container.database.id,t=this.container.id,P(i=I(i=this.id)),F(e,t)+"/"+s.Path.StoredProceduresPathSegment+"/"+i}constructor(e,t,i){this.container=e,this.id=t,this.clientContext=i}async read(e){return tZ(async t=>{let i=T(this.url),n=v(this.url),r=await this.clientContext.read({path:i,resourceType:K.sproc,resourceId:n,options:e,diagnosticNode:t});return new n$(r.result,r.headers,r.code,this,tG())},this.clientContext)}async replace(e,t){return tZ(async i=>{e.body&&(e.body=e.body.toString());let n={};if(!x(e,n))throw n;let r=T(this.url),o=v(this.url),s=await this.clientContext.replace({body:e,path:r,resourceType:K.sproc,resourceId:o,options:t,diagnosticNode:i});return new n$(s.result,s.headers,s.code,this,tG())},this.clientContext)}async delete(e){return tZ(async t=>{let i=T(this.url),n=v(this.url),r=await this.clientContext.delete({path:i,resourceType:K.sproc,resourceId:n,options:e,diagnosticNode:t});return new n$(r.result,r.headers,r.code,this,tG())},this.clientContext)}async execute(e,t,i){return tZ(async n=>{void 0===e&&(e=td(await ta(n,this.container)));let r=await this.clientContext.execute({sprocLink:this.url,params:t,options:i,partitionKey:e,diagnosticNode:n});return new tm(r.result,r.headers,r.code,tG())},this.clientContext)}}class nG{container;clientContext;constructor(e,t){this.container=e,this.clientContext=t}query(e,t){let i=T(this.container.url,K.sproc),n=v(this.container.url);return new nv(this.clientContext,e,t,(t,r)=>this.clientContext.queryFeed({path:i,resourceType:K.sproc,resourceId:n,resultFn:e=>e.StoredProcedures,query:e,options:r,diagnosticNode:t}))}readAll(e){return this.query(void 0,e)}async create(e,t){return tZ(async i=>{e.body&&(e.body=e.body.toString());let n={};if(!x(e,n))throw n;let r=T(this.container.url,K.sproc),o=v(this.container.url),s=await this.clientContext.create({body:e,path:r,resourceType:K.sproc,resourceId:o,options:t,diagnosticNode:i}),a=new nj(this.container,s.result.id,this.clientContext);return new n$(s.result,s.headers,s.code,a,tG())},this.clientContext)}}class nJ extends tm{constructor(e,t,i,n,r){super(e,t,i,r),this.trigger=n}trigger}class nY{container;id;clientContext;get url(){var e,t,i;return e=this.container.database.id,t=this.container.id,P(i=I(i=this.id)),F(e,t)+"/"+s.Path.TriggersPathSegment+"/"+i}constructor(e,t,i){this.container=e,this.id=t,this.clientContext=i}async read(e){return tZ(async t=>{let i=T(this.url),n=v(this.url),r=await this.clientContext.read({path:i,resourceType:K.trigger,resourceId:n,options:e,diagnosticNode:t});return new nJ(r.result,r.headers,r.code,this,tG())},this.clientContext)}async replace(e,t){return tZ(async i=>{e.body&&(e.body=e.body.toString());let n={};if(!x(e,n))throw n;let r=T(this.url),o=v(this.url),s=await this.clientContext.replace({body:e,path:r,resourceType:K.trigger,resourceId:o,options:t,diagnosticNode:i});return new nJ(s.result,s.headers,s.code,this,tG())},this.clientContext)}async delete(e){return tZ(async t=>{let i=T(this.url),n=v(this.url),r=await this.clientContext.delete({path:i,resourceType:K.trigger,resourceId:n,options:e,diagnosticNode:t});return new nJ(r.result,r.headers,r.code,this,tG())},this.clientContext)}}class nZ{container;clientContext;constructor(e,t){this.container=e,this.clientContext=t}query(e,t){let i=T(this.container.url,K.trigger),n=v(this.container.url);return new nv(this.clientContext,e,t,(t,r)=>this.clientContext.queryFeed({path:i,resourceType:K.trigger,resourceId:n,resultFn:e=>e.Triggers,query:e,options:r,diagnosticNode:t}))}readAll(e){return this.query(void 0,e)}async create(e,t){return tZ(async i=>{e.body&&(e.body=e.body.toString());let n={};if(!x(e,n))throw n;let r=T(this.container.url,K.trigger),o=v(this.container.url),s=await this.clientContext.create({body:e,path:r,resourceType:K.trigger,resourceId:o,options:t,diagnosticNode:i}),a=new nY(this.container,s.result.id,this.clientContext);return new nJ(s.result,s.headers,s.code,a,tG())},this.clientContext)}}class nX extends tm{constructor(e,t,i,n,r){super(e,t,i,r),this.userDefinedFunction=n}userDefinedFunction;get udf(){return this.userDefinedFunction}}class n0{container;id;clientContext;get url(){var e,t,i;return e=this.container.database.id,t=this.container.id,P(i=I(i=this.id)),F(e,t)+"/"+s.Path.UserDefinedFunctionsPathSegment+"/"+i}constructor(e,t,i){this.container=e,this.id=t,this.clientContext=i}async read(e){return tZ(async t=>{let i=T(this.url),n=v(this.url),r=await this.clientContext.read({path:i,resourceType:K.udf,resourceId:n,options:e,diagnosticNode:t});return new nX(r.result,r.headers,r.code,this,tG())},this.clientContext)}async replace(e,t){return tZ(async i=>{e.body&&(e.body=e.body.toString());let n={};if(!x(e,n))throw n;let r=T(this.url),o=v(this.url),s=await this.clientContext.replace({body:e,path:r,resourceType:K.udf,resourceId:o,options:t,diagnosticNode:i});return new nX(s.result,s.headers,s.code,this,tG())},this.clientContext)}async delete(e){return tZ(async t=>{let i=T(this.url),n=v(this.url),r=await this.clientContext.delete({path:i,resourceType:K.udf,resourceId:n,options:e,diagnosticNode:t});return new nX(r.result,r.headers,r.code,this,tG())},this.clientContext)}}class n1{container;clientContext;constructor(e,t){this.container=e,this.clientContext=t}query(e,t){let i=T(this.container.url,K.udf),n=v(this.container.url);return new nv(this.clientContext,e,t,(t,r)=>this.clientContext.queryFeed({path:i,resourceType:K.udf,resourceId:n,resultFn:e=>e.UserDefinedFunctions,query:e,options:r,diagnosticNode:t}))}readAll(e){return this.query(void 0,e)}async create(e,t){return tZ(async i=>{e.body&&(e.body=e.body.toString());let n={};if(!x(e,n))throw n;let r=T(this.container.url,K.udf),o=v(this.container.url),s=await this.clientContext.create({body:e,path:r,resourceType:K.udf,resourceId:o,options:t,diagnosticNode:i}),a=new n0(this.container,s.result.id,this.clientContext);return new nX(s.result,s.headers,s.code,a,tG())},this.clientContext)}}class n2{container;clientContext;constructor(e,t){this.container=e,this.clientContext=t}storedProcedure(e){return new nj(this.container,e,this.clientContext)}trigger(e){return new nY(this.container,e,this.clientContext)}userDefinedFunction(e){return new n0(this.container,e,this.clientContext)}$sprocs;get storedProcedures(){return this.$sprocs||(this.$sprocs=new nG(this.container,this.clientContext)),this.$sprocs}$triggers;get triggers(){return this.$triggers||(this.$triggers=new nZ(this.container,this.clientContext)),this.$triggers}$udfs;get userDefinedFunctions(){return this.$udfs||(this.$udfs=new n1(this.container,this.clientContext)),this.$udfs}}class n6 extends tm{constructor(e,t,i,n,r){super(e,t,i,r),this.container=n}container}class n3 extends tm{constructor(e,t,i,n,r){super(e,t,i,n),this.offer=r}offer}class n5{client;id;clientContext;get url(){return`/${s.Path.OffersPathSegment}/${this.id}`}constructor(e,t,i){this.client=e,this.id=t,this.clientContext=i}async read(e){return tZ(async t=>{let i=await this.clientContext.read({path:this.url,resourceType:K.offer,resourceId:this.id,options:e,diagnosticNode:t});return new n3(i.result,i.headers,i.code,tG(),this)},this.clientContext)}async replace(e,t){return tZ(async i=>{let n={};if(!x(e,n))throw n;let r=await this.clientContext.replace({body:e,path:this.url,resourceType:K.offer,resourceId:this.id,options:t,diagnosticNode:i});return new n3(r.result,r.headers,r.code,tG(),this)},this.clientContext)}}class n4{client;clientContext;constructor(e,t){this.client=e,this.clientContext=t}query(e,t){return new nv(this.clientContext,e,t,(t,i)=>this.clientContext.queryFeed({path:"/offers",resourceType:K.offer,resourceId:"",resultFn:e=>e.Offers,query:e,options:i,diagnosticNode:t}))}readAll(e){return this.query(void 0,e)}}class n8 extends tm{constructor(e,t,i,n,r){super(e,t,i,r),this.clientEncryptionKeyProperties=n}clientEncryptionKeyProperties}(eb||(eb={})).AEAD_AES_256_CBC_HMAC_SHA256="AEAD_AES_256_CBC_HMAC_SHA256",(ev||(ev={})).AzureKeyVault="AZURE_KEY_VAULT",(eT||(eT={})).RSA_OAEP="RSA-OAEP",tt("keyvault-keys"),function(e){e.EC="EC",e.ECHSM="EC-HSM",e.RSA="RSA",e.RSAHSM="RSA-HSM",e.Oct="oct",e.OctHSM="oct-HSM"}(eS||(eS={})),function(e){e.Encrypt="encrypt",e.Decrypt="decrypt",e.Sign="sign",e.Verify="verify",e.WrapKey="wrapKey",e.UnwrapKey="unwrapKey",e.Import="import",e.Export="export"}(eI||(eI={})),function(e){e.Purgeable="Purgeable",e.RecoverablePurgeable="Recoverable+Purgeable",e.Recoverable="Recoverable",e.RecoverableProtectedSubscription="Recoverable+ProtectedSubscription",e.CustomizedRecoverablePurgeable="CustomizedRecoverable+Purgeable",e.CustomizedRecoverable="CustomizedRecoverable",e.CustomizedRecoverableProtectedSubscription="CustomizedRecoverable+ProtectedSubscription"}(eP||(eP={})),!function(e){e.P256="P-256",e.P384="P-384",e.P521="P-521",e.P256K="P-256K"}(eA||(eA={})),function(e){e.RSAOaep="RSA-OAEP",e.RSAOaep256="RSA-OAEP-256",e.RSA15="RSA1_5",e.A128GCM="A128GCM",e.A192GCM="A192GCM",e.A256GCM="A256GCM",e.A128KW="A128KW",e.A192KW="A192KW",e.A256KW="A256KW",e.A128CBC="A128CBC",e.A192CBC="A192CBC",e.A256CBC="A256CBC",e.A128Cbcpad="A128CBCPAD",e.A192Cbcpad="A192CBCPAD",e.A256Cbcpad="A256CBCPAD",e.CkmAesKeyWrap="CKM_AES_KEY_WRAP",e.CkmAesKeyWrapPad="CKM_AES_KEY_WRAP_PAD"}(eM||(eM={})),function(e){e.PS256="PS256",e.PS384="PS384",e.PS512="PS512",e.RS256="RS256",e.RS384="RS384",e.RS512="RS512",e.HS256="HS256",e.HS384="HS384",e.HS512="HS512",e.Rsnull="RSNULL",e.ES256="ES256",e.ES384="ES384",e.ES512="ES512",e.ES256K="ES256K"}(eD||(eD={})),function(e){e.CkmRsaAesKeyWrap="CKM_RSA_AES_KEY_WRAP",e.RsaAesKeyWrap256="RSA_AES_KEY_WRAP_256",e.RsaAesKeyWrap384="RSA_AES_KEY_WRAP_384"}(ek||(ek={})),function(e){e.V75="7.5",e.V76Preview2="7.6-preview.2",e.V76="7.6"}(eO||(eO={})),tt("keyvault-keys");class n9 extends Error{constructor(e){super(e),this.name="AbortError"}}function n7(e){return e.toLowerCase()}class re{_headersMap;constructor(e){if(this._headersMap=new Map,e)for(let t of Object.keys(e))this.set(t,e[t])}set(e,t){this._headersMap.set(n7(e),{name:e,value:String(t).trim()})}get(e){return this._headersMap.get(n7(e))?.value}has(e){return this._headersMap.has(n7(e))}delete(e){this._headersMap.delete(n7(e))}toJSON(e={}){let t={};if(e.preserveCase)for(let e of this._headersMap.values())t[e.name]=e.value;else for(let[e,i]of this._headersMap)t[e]=i.value;return t}toString(){return JSON.stringify(this.toJSON({preserveCase:!0}))}[Symbol.iterator](){return function*(e){for(let t of e.values())yield[t.name,t.value]}(this._headersMap)}}class rt{url;method;headers;timeout;withCredentials;body;multipartBody;formData;streamResponseStatusCodes;enableBrowserStreams;proxySettings;disableKeepAlive;abortSignal;requestId;allowInsecureConnection;onUploadProgress;onDownloadProgress;requestOverrides;authSchemes;constructor(e){this.url=e.url,this.body=e.body,this.headers=e.headers??new re(void 0),this.method=e.method??"GET",this.timeout=e.timeout??0,this.multipartBody=e.multipartBody,this.formData=e.formData,this.disableKeepAlive=e.disableKeepAlive??!1,this.proxySettings=e.proxySettings,this.streamResponseStatusCodes=e.streamResponseStatusCodes,this.withCredentials=e.withCredentials??!1,this.abortSignal=e.abortSignal,this.onUploadProgress=e.onUploadProgress,this.onDownloadProgress=e.onDownloadProgress,this.requestId=e.requestId||tV(),this.allowInsecureConnection=e.allowInsecureConnection??!1,this.enableBrowserStreams=e.enableBrowserStreams??!1,this.requestOverrides=e.requestOverrides,this.authSchemes=e.authSchemes}}let ri=new Set(["Deserialize","Serialize","Retry","Sign"]);class rn{_policies=[];_orderedPolicies;constructor(e){this._policies=e?.slice(0)??[],this._orderedPolicies=void 0}addPolicy(e,t={}){if(t.phase&&t.afterPhase)throw Error("Policies inside a phase cannot specify afterPhase.");if(t.phase&&!ri.has(t.phase))throw Error(`Invalid phase name: ${t.phase}`);if(t.afterPhase&&!ri.has(t.afterPhase))throw Error(`Invalid afterPhase name: ${t.afterPhase}`);this._policies.push({policy:e,options:t}),this._orderedPolicies=void 0}removePolicy(e){let t=[];return this._policies=this._policies.filter(i=>(!e.name||i.policy.name!==e.name)&&(!e.phase||i.options.phase!==e.phase)||(t.push(i.policy),!1)),this._orderedPolicies=void 0,t}sendRequest(e,t){return this.getOrderedPolicies().reduceRight((e,t)=>i=>t.sendRequest(i,e),t=>e.sendRequest(t))(t)}getOrderedPolicies(){return this._orderedPolicies||(this._orderedPolicies=this.orderPolicies()),this._orderedPolicies}clone(){return new rn(this._policies)}static create(){return new rn}orderPolicies(){let e=[],t=new Map;function i(e){return{name:e,policies:new Set,hasRun:!1,hasAfterPolicies:!1}}let n=i("Serialize"),r=i("None"),o=i("Deserialize"),s=i("Retry"),a=i("Sign"),c=[n,r,o,s,a];function l(e){return"Retry"===e?s:"Serialize"===e?n:"Deserialize"===e?o:"Sign"===e?a:r}for(let e of this._policies){let i=e.policy,n=e.options,r=i.name;if(t.has(r))throw Error("Duplicate policy names not allowed in pipeline");let o={policy:i,dependsOn:new Set,dependants:new Set};n.afterPhase&&(o.afterPhase=l(n.afterPhase),o.afterPhase.hasAfterPolicies=!0),t.set(r,o),l(n.phase).policies.add(o)}for(let e of this._policies){let{policy:i,options:n}=e,r=i.name,o=t.get(r);if(!o)throw Error(`Missing node for policy ${r}`);if(n.afterPolicies)for(let e of n.afterPolicies){let i=t.get(e);i&&(o.dependsOn.add(i),i.dependants.add(o))}if(n.beforePolicies)for(let e of n.beforePolicies){let i=t.get(e);i&&(i.dependsOn.add(o),o.dependants.add(i))}}function u(i){for(let n of(i.hasRun=!0,i.policies))if((!n.afterPhase||n.afterPhase.hasRun&&!n.afterPhase.policies.size)&&0===n.dependsOn.size){for(let t of(e.push(n.policy),n.dependants))t.dependsOn.delete(n);t.delete(n.policy.name),i.policies.delete(n)}}let h=0;for(;t.size>0;){h++;let t=e.length;if(function(){for(let e of c){if(u(e),e.policies.size>0&&e!==r){r.hasRun||u(r);return}e.hasAfterPolicies&&u(r)}}(),e.length<=t&&h>1)throw Error("Cannot satisfy policy dependencies due to requirements cycle.")}return e}}function rr(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)&&!(e instanceof RegExp)&&!(e instanceof Date)}let ro=eQ.inspect.custom,rs="REDACTED",ra=["x-ms-client-request-id","x-ms-return-client-request-id","x-ms-useragent","x-ms-correlation-request-id","x-ms-request-id","client-request-id","ms-cv","return-client-request-id","traceparent","Access-Control-Allow-Credentials","Access-Control-Allow-Headers","Access-Control-Allow-Methods","Access-Control-Allow-Origin","Access-Control-Expose-Headers","Access-Control-Max-Age","Access-Control-Request-Headers","Access-Control-Request-Method","Origin","Accept","Accept-Encoding","Cache-Control","Connection","Content-Length","Content-Type","Date","ETag","Expires","If-Match","If-Modified-Since","If-None-Match","If-Unmodified-Since","Last-Modified","Pragma","Request-Id","Retry-After","Server","Transfer-Encoding","User-Agent","WWW-Authenticate"],rc=["api-version"];class rl{allowedHeaderNames;allowedQueryParameters;constructor({additionalAllowedHeaderNames:e=[],additionalAllowedQueryParameters:t=[]}={}){e=ra.concat(e),t=rc.concat(t),this.allowedHeaderNames=new Set(e.map(e=>e.toLowerCase())),this.allowedQueryParameters=new Set(t.map(e=>e.toLowerCase()))}sanitize(e){let t=new Set;return JSON.stringify(e,(e,i)=>{if(i instanceof Error)return{...i,name:i.name,message:i.message};if("headers"===e)return this.sanitizeHeaders(i);if("url"===e)return this.sanitizeUrl(i);if("query"===e)return this.sanitizeQuery(i);if("body"!==e){if("response"===e)return;if("operationSpec"===e)return;else if(Array.isArray(i)||rr(i)){if(t.has(i))return"[Circular]";t.add(i)}return i}},2)}sanitizeUrl(e){if("string"!=typeof e||null===e||""===e)return e;let t=new URL(e);if(!t.search)return e;for(let[e]of t.searchParams)this.allowedQueryParameters.has(e.toLowerCase())||t.searchParams.set(e,rs);return t.toString()}sanitizeHeaders(e){let t={};for(let i of Object.keys(e))this.allowedHeaderNames.has(i.toLowerCase())?t[i]=e[i]:t[i]=rs;return t}sanitizeQuery(e){if("object"!=typeof e||null===e)return e;let t={};for(let i of Object.keys(e))this.allowedQueryParameters.has(i.toLowerCase())?t[i]=e[i]:t[i]=rs;return t}}let ru=new rl;class rh extends Error{static REQUEST_SEND_ERROR="REQUEST_SEND_ERROR";static PARSE_ERROR="PARSE_ERROR";code;statusCode;request;response;details;constructor(e,t={}){super(e),this.name="RestError",this.code=t.code,this.statusCode=t.statusCode,Object.defineProperty(this,"request",{value:t.request,enumerable:!1}),Object.defineProperty(this,"response",{value:t.response,enumerable:!1});let i=this.request?.agent?{maxFreeSockets:this.request.agent.maxFreeSockets,maxSockets:this.request.agent.maxSockets}:void 0;Object.defineProperty(this,ro,{value:()=>`RestError: ${this.message} 
 ${ru.sanitize({...this,request:{...this.request,agent:i},response:this.response})}`,enumerable:!1}),Object.setPrototypeOf(this,rh.prototype)}}var rd=i(8849),rp=i(2286),ry=i(5628),rf=i(4492);let rg=e7("ts-http-runtime"),rm={};function rC(e){return e&&"function"==typeof e.pipe}function rE(e){return!1===e.readable?Promise.resolve():new Promise(t=>{let i=()=>{t(),e.removeListener("close",i),e.removeListener("end",i),e.removeListener("error",i)};e.on("close",i),e.on("end",i),e.on("error",i)})}function rw(e){return e&&"number"==typeof e.byteLength}class rR extends rf.Transform{loadedBytes=0;progressCallback;_transform(e,t,i){this.push(e),this.loadedBytes+=e.length;try{this.progressCallback({loadedBytes:this.loadedBytes}),i()}catch(e){i(e)}}constructor(e){super(),this.progressCallback=e}}class rx{cachedHttpAgent;cachedHttpsAgents=new WeakMap;async sendRequest(e){var t,i;let n,r,o;let s=new AbortController;if(e.abortSignal){if(e.abortSignal.aborted)throw new n9("The operation was aborted. Request has already been canceled.");n=e=>{"abort"===e.type&&s.abort()},e.abortSignal.addEventListener("abort",n)}e.timeout>0&&(r=setTimeout(()=>{let t=new rl;rg.info(`request to '${t.sanitizeUrl(e.url)}' timed out. canceling...`),s.abort()},e.timeout));let a=e.headers.get("Accept-Encoding"),c=a?.includes("gzip")||a?.includes("deflate"),l="function"==typeof e.body?e.body():e.body;if(l&&!e.headers.has("Content-Length")){let i=(t=l)?Buffer.isBuffer(t)?t.length:rC(t)?null:rw(t)?t.byteLength:"string"==typeof t?Buffer.from(t).length:null:0;null!==i&&e.headers.set("Content-Length",i)}try{if(l&&e.onUploadProgress){let t=e.onUploadProgress,i=new rR(t);i.on("error",e=>{rg.error("Error in upload progress",e)}),rC(l)?l.pipe(i):i.end(l),l=i}let t=await this.makeRequest(e,s,l);void 0!==r&&clearTimeout(r);let n=function(e){let t=new re(void 0);for(let i of Object.keys(e.headers)){let n=e.headers[i];Array.isArray(n)?n.length>0&&t.set(i,n[0]):n&&t.set(i,n)}return t}(t),a={status:t.statusCode??0,headers:n,request:e};if("HEAD"===e.method)return t.resume(),a;o=c?function(e,t){let i=t.get("Content-Encoding");if("gzip"===i){let t=ry.createGunzip();return e.pipe(t),t}if("deflate"===i){let t=ry.createInflate();return e.pipe(t),t}return e}(t,n):t;let u=e.onDownloadProgress;if(u){let e=new rR(u);e.on("error",e=>{rg.error("Error in download progress",e)}),o.pipe(e),o=e}return e.streamResponseStatusCodes?.has(Number.POSITIVE_INFINITY)||e.streamResponseStatusCodes?.has(a.status)?a.readableStreamBody=o:a.bodyAsText=await (i=o,new Promise((e,t)=>{let n=[];i.on("data",e=>{Buffer.isBuffer(e)?n.push(e):n.push(Buffer.from(e))}),i.on("end",()=>{e(Buffer.concat(n).toString("utf8"))}),i.on("error",e=>{e&&e?.name==="AbortError"?t(e):t(new rh(`Error reading response as text: ${e.message}`,{code:rh.PARSE_ERROR}))})})),a}finally{if(e.abortSignal&&n){let t=Promise.resolve();rC(l)&&(t=rE(l));let i=Promise.resolve();rC(o)&&(i=rE(o)),Promise.all([t,i]).then(()=>{n&&e.abortSignal?.removeEventListener("abort",n)}).catch(e=>{rg.warning("Error when cleaning up abortListener on httpRequest",e)})}}}makeRequest(e,t,i){let n=new URL(e.url),r="https:"!==n.protocol;if(r&&!e.allowInsecureConnection)throw Error(`Cannot connect to ${e.url} while allowInsecureConnection is false.`);let o={agent:e.agent??this.getOrCreateAgent(e,r),hostname:n.hostname,path:`${n.pathname}${n.search}`,port:n.port,method:e.method,headers:e.headers.toJSON({preserveCase:!0}),...e.requestOverrides};return new Promise((n,s)=>{let a=r?rd.request(o,n):rp.request(o,n);a.once("error",t=>{s(new rh(t.message,{code:t.code??rh.REQUEST_SEND_ERROR,request:e}))}),t.signal.addEventListener("abort",()=>{let e=new n9("The operation was aborted. Rejecting from abort signal callback while making request.");a.destroy(e),s(e)}),i&&rC(i)?i.pipe(a):i?"string"==typeof i||Buffer.isBuffer(i)?a.end(i):rw(i)?a.end(ArrayBuffer.isView(i)?Buffer.from(i.buffer):Buffer.from(i)):(rg.error("Unrecognized body type",i),s(new rh("Unrecognized body type"))):a.end()})}getOrCreateAgent(e,t){let i=e.disableKeepAlive;if(t)return i?rd.globalAgent:(this.cachedHttpAgent||(this.cachedHttpAgent=new rd.Agent({keepAlive:!0})),this.cachedHttpAgent);{if(i&&!e.tlsSettings)return rp.globalAgent;let t=e.tlsSettings??rm,n=this.cachedHttpsAgents.get(t);return n&&!i===n.options.keepAlive||(rg.info("No cached TLS Agent exist, creating a new Agent"),n=new rp.Agent({keepAlive:!i,...t}),this.cachedHttpsAgents.set(t,n)),n}}}e7("ts-http-runtime retryPolicy"),i(5453),i(6310);async function*rb(){let e=this.getReader();try{for(;;){let{done:t,value:i}=await e.read();if(t)return;yield i}}finally{e.releaseLock()}}i(6162);let rv=tt("core-rest-pipeline");Symbol("rawContent");let rT={span:Symbol.for("@azure/core-tracing span"),namespace:Symbol.for("@azure/core-tracing namespace")};class rS{_contextMap;constructor(e){this._contextMap=e instanceof rS?new Map(e._contextMap):new Map}setValue(e,t){let i=new rS(this);return i._contextMap.set(e,t),i}getValue(e){return this._contextMap.get(e)}deleteValue(e){let t=new rS(this);return t._contextMap.delete(e),t}}let rI=i(791).S;tt("core-rest-pipeline retryPolicy");let rP={forcedRefreshWindowInMs:1e3,retryIntervalInMs:3e3,refreshWindowInMs:12e4};async function rA(e,t,i){async function n(){if(Date.now()<i)try{return await e()}catch{return null}else{let t=await e();if(null===t)throw Error("Failed to refresh access token.");return t}}let r=await n();for(;null===r;)await function(e,t){let i;let{abortSignal:n,abortErrorMsg:r}=(void 0)??{};return function(e,t){let{cleanupBeforeAbort:i,abortSignal:n,abortErrorMsg:r}=t??{};return new Promise((t,o)=>{function s(){o(new tW(r??"The operation was aborted."))}function a(){n?.removeEventListener("abort",c)}function c(){i?.(),a(),s()}if(n?.aborted)return s();try{e(e=>{a(),t(e)},e=>{a(),o(e)})}catch(e){o(e)}n?.addEventListener("abort",c)})}(t=>{i=setTimeout(t,e)},{cleanupBeforeAbort:()=>clearTimeout(i),abortSignal:n,abortErrorMsg:r??"The delay was aborted."})}(t),r=await n();return r}async function rM(e,t){try{return[await t(e),void 0]}catch(e){if((e instanceof rh||function(e){if(rr(e)){let t="string"==typeof e.name,i="string"==typeof e.message;return t&&i}return!1}(e)&&"RestError"===e.name)&&e.response)return[e.response,e];throw e}}async function rD(e){let{scopes:t,getAccessToken:i,request:n}=e,r={abortSignal:n.abortSignal,tracingOptions:n.tracingOptions,enableCae:!0},o=await i(t,r);o&&e.request.headers.set("Authorization",`Bearer ${o.token}`)}function rk(e){return 401===e.status&&e.headers.has("WWW-Authenticate")}async function rO(e,t){let{scopes:i}=e,n=await e.getAccessToken(i,{enableCae:!0,claims:t});return!!n&&(e.request.headers.set("Authorization",`${n.tokenType??"Bearer"} ${n.token}`),!0)}function rL(e){if(!e)return;let t=function(e){let t;let i=/(\w+)\s+((?:\w+=(?:"[^"]*"|[^,]*),?\s*)+)/g,n=/(\w+)="([^"]*)"/g,r=[];for(;null!==(t=i.exec(e));){let e;let i=t[1],o=t[2],s={};for(;null!==(e=n.exec(o));)s[e[1]]=e[2];r.push({scheme:i,params:s})}return r}(e);return t.find(e=>"Bearer"===e.scheme&&e.params.claims&&"insufficient_claims"===e.params.error)?.params.claims}tt("keyvault-common"),function(e){let{namespace:t,packageName:i,packageVersion:n}=e}({namespace:"Microsoft.KeyVault",packageName:"@azure/keyvault-keys",packageVersion:"4.10.0"});let rF=tt("core-lro"),rB=["succeeded","canceled","failed"];function rK(e){let{state:t,stateProxy:i,isOperationError:n}=e;return e=>{throw n(e)&&(i.setError(t,e),i.setFailed(t)),e}}!function(e){e.Encrypt="encrypt",e.Decrypt="decrypt",e.Sign="sign",e.Verify="verify",e.WrapKey="wrapKey",e.UnwrapKey="unwrapKey",e.Import="import"}(eL||(eL={})),i(9714);class rH{keyEncryptionKeyResolver;cacheTimeToLive;RsaOaepEncryptionAlgorithm="RSA-OAEP";cacheRefresher;unwrappedEncryptionKeyCache;providerName;constructor(e,t){this.keyEncryptionKeyResolver=e,this.cacheTimeToLive=t,this.keyEncryptionKeyResolver=e,this.providerName=e.encryptionKeyResolverName,this.unwrappedEncryptionKeyCache={},this.cacheTimeToLive=t,this.clearCacheOnTtlExpiry()}async wrapKey(e,t,i){let n=new Uint8Array(i),r=await this.keyEncryptionKeyResolver.wrapKey(e,t,n);return Buffer.from(r)}async unwrapKey(e,t,i){if(0===this.cacheTimeToLive){let n=await this.keyEncryptionKeyResolver.unwrapKey(e,t,i);return Buffer.from(n)}if(!this.unwrappedEncryptionKeyCache[e]){let n=new Uint8Array(i),r=await this.keyEncryptionKeyResolver.unwrapKey(e,t,n),o=Buffer.from(r);this.unwrappedEncryptionKeyCache[e]=[new Date,o]}return this.unwrappedEncryptionKeyCache[e][1]}async clearCacheOnTtlExpiry(){this.cacheRefresher=tN(async()=>{let e=new Date;for(let t in this.unwrappedEncryptionKeyCache)e.getTime()-this.unwrappedEncryptionKeyCache[t][0].getTime()>this.cacheTimeToLive&&delete this.unwrappedEncryptionKeyCache[t]},s.EncryptionCacheRefreshIntervalInMs)}}class rq{encryptionAlgorithm;name;path;keyStoreProvider;constructor(e,t,i){this.name=e,this.path=t,this.keyStoreProvider=i,this.encryptionAlgorithm=eT.RSA_OAEP}async wrapEncryptionKey(e){return this.keyStoreProvider.wrapKey(this.path,this.encryptionAlgorithm,e)}async unwrapEncryptionKey(e){return this.keyStoreProvider.unwrapKey(this.path,this.encryptionAlgorithm,e)}}class r_{algoVersion=1;blockSizeInBytes=16;encryptionType;dataEncryptionKey;version;versionSize;keySizeInBytes;minimumCipherTextLength;constructor(e,t){this.dataEncryptionKey=e,this.encryptionType=t,this.version=Buffer.from([this.algoVersion]),this.versionSize=Buffer.from([1]),this.keySizeInBytes=32,this.minimumCipherTextLength=1+2*this.blockSizeInBytes+this.keySizeInBytes}encrypt(e){let t;if(this.encryptionType===j.RANDOMIZED)t=(0,eK.randomBytes)(16);else{let i=(0,eK.createHmac)("sha256",this.dataEncryptionKey.ivKeyBuffer);i.update(e),t=i.digest().slice(0,this.blockSizeInBytes)}let i=(0,eK.createCipheriv)("aes-256-cbc",this.dataEncryptionKey.encryptionKeyBuffer,t),n=Buffer.concat([i.update(e),i.final()]),r=this.generateAuthenticationTag(t,n);return Buffer.concat([Buffer.from([this.algoVersion]),r,t,n])}decrypt(e){if(e.length<this.minimumCipherTextLength)throw Error("Invalid cipher text length");if(e[0]!==this.algoVersion)throw Error("Invalid cipher text version");let t=this.keySizeInBytes,i=1+t,n=this.blockSizeInBytes,r=i+n,o=e.length-r,s=e.slice(1,1+t),a=e.slice(i,i+n),c=e.slice(r,r+o);this.validateAuthenticationTag(s,a,c);let l=(0,eK.createDecipheriv)("aes-256-cbc",this.dataEncryptionKey.encryptionKeyBuffer,a),u=l.update(c);return Buffer.concat([u,l.final()])}generateAuthenticationTag(e,t){let i=(0,eK.createHmac)("sha256",this.dataEncryptionKey.macKeyBuffer),n=Buffer.concat([this.version,e,t,this.versionSize]);return i.update(n).digest()}validateAuthenticationTag(e,t,i){let n=this.generateAuthenticationTag(t,i);if(!e.equals(n))throw Error("Invalid authentication tag")}}class rN{encryptionKeyId;encryptionType;encryptionAlgorithm;constructor(e){this.encryptionKeyId=e.clientEncryptionKeyId,this.encryptionType=e.encryptionType,this.encryptionAlgorithm=e.encryptionAlgorithm}async buildEncryptionAlgorithm(e,t,i){return new r_(await this.buildProtectedDataEncryptionKey(e,t,i),this.encryptionType)}async buildProtectedDataEncryptionKey(e,t,i){let n=t.keyEncryptionKeyCache.getOrCreate(e.encryptionKeyWrapMetadata.name,e.encryptionKeyWrapMetadata.value,t.encryptionKeyStoreProvider);return await t.protectedDataEncryptionKeyCache.getOrCreate(this.encryptionKeyId,n,e.wrappedDataEncryptionKey,i)}}class rU{rootKeyBuffer;keySizeInBits=256;keySizeInBytes=this.keySizeInBits/8;encryptionKeyBuffer;macKeyBuffer;ivKeyBuffer;name;constructor(e,t){if(e.length!==this.keySizeInBytes)throw Error("Invalid root key size");this.rootKeyBuffer=e,this.name=t;let i=`Microsoft SQL Server cell encryption key with encryption algorithm:AEAD_AES_256_CBC_HMAC_SHA256 and key length:${this.keySizeInBits}`,n=`Microsoft SQL Server cell MAC key with encryption algorithm:AEAD_AES_256_CBC_HMAC_SHA256 and key length:${this.keySizeInBits}`,r=`Microsoft SQL Server cell IV key with encryption algorithm:AEAD_AES_256_CBC_HMAC_SHA256 and key length:${this.keySizeInBits}`;this.encryptionKeyBuffer=this.getHmacWithSha256(i,this.rootKeyBuffer),this.macKeyBuffer=this.getHmacWithSha256(n,this.rootKeyBuffer),this.ivKeyBuffer=this.getHmacWithSha256(r,this.rootKeyBuffer)}getHmacWithSha256(e,t){let i=(0,eK.createHmac)("sha256",t);return i.update(Buffer.from(e,"utf16le")),i.digest()}}class rz extends rU{keyEncryptionKey;encryptedValue;constructor(e,t,i,n){super(i,e),this.name=e,this.keyEncryptionKey=t,this.encryptedValue=n}}class rQ{containerId;containerRid;database;clientContext;encryptionManager;constructor(e,t,i,n,r){this.containerId=e,this.containerRid=t,this.database=i,this.clientContext=n,this.encryptionManager=r}async encrypt(e){if(!e)throw new d("Input body is null or undefined.");let t=0,i=await this.getEncryptionSetting();if(!i)return{body:e,propertiesEncryptedCount:t};for(let n of i.pathsToEncrypt){let r=n.slice(1);if(!Object.prototype.hasOwnProperty.call(e,r))continue;let o=i.getEncryptionSettingForProperty(n);if(!o)throw new d("Invalid Encryption Setting for the Property: "+r);e[r]=await this.encryptToken(e[r],o,"id"===r),t++}return{body:e,propertiesEncryptedCount:t}}async isPathEncrypted(e){return e=D(e),!!(await this.getEncryptionSetting()).getEncryptionSettingForProperty(e)}async encryptProperty(e,t){e=D(e);let i=await this.getEncryptionSetting();if(!i)return t;let n=i.getEncryptionSettingForProperty(e);return n?t=await this.encryptToken(t,n,"/id"===e):t}async getEncryptedPartitionKeyValue(e){let t=await this.getEncryptionSetting(),i=0;if(!t)return{partitionKeyList:e,encryptedCount:i};let n=t.partitionKeyPaths;for(let r=0;r<n.length;r++){let o=D(n[r]);if(t.pathsToEncrypt.includes(o)){let n=t.getEncryptionSettingForProperty(o);e[r]=await this.encryptToken(e[r],n,"/id"===o),i++}}return{partitionKeyList:e,encryptedCount:i}}async getEncryptedUrl(e){let t=e.split("/"),i=t[t.length-1],n=await this.getEncryptedId(i);return t[t.length-1]=n,t.join("/")}async getEncryptedId(e){let t=await this.getEncryptionSetting();if(!t)return e;let i=t.getEncryptionSettingForProperty("/id");return i?e=await this.encryptToken(e,i,!0):e}async encryptQueryParameter(e,t,i,n){if(null===t)return t;e=D(e);let r=await this.getEncryptionSetting();if(!r)return t;let o=r.getEncryptionSettingForProperty(e);return o?this.encryptToken(t,o,i,n):t}async encryptToken(e,t,i,n){if("object"==typeof e&&null!==e)for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&(e[r]=await this.encryptToken(e[r],t,i,n));else if(Array.isArray(n))for(let r=0;r<e.length;r++)e[r]=await this.encryptToken(e[r],t,i,n);else e=await this.serializeAndEncryptValue(e,t,i,n);return e}async serializeAndEncryptValue(e,t,i,n){if(null===e)return e;let[r,o]=function(e,t){if(t){if(t===G.Long)return[G.Long,new c];if(t===G.Double)return[G.Double,new l];if(t===G.String)return[G.String,new u];if(t===G.Boolean)return[G.Boolean,new h];else throw Error("Invalid or Unsupported data type passed.")}switch(typeof e){case"boolean":return[G.Boolean,new h];case"string":return[G.String,new u];case"object":if(e.constructor===Date)return[G.String,new u];throw Error("Invalid or Unsupported data type passed.");case"number":if(!Number.isInteger(e))return[G.Double,new l];return[G.Long,new c];default:throw Error("Invalid or Unsupported data type passed.")}}(e,n),s=o.serialize(e),a=(await this.buildEncryptionAlgorithm(t)).encrypt(s);if(i&&"string"!=typeof e)throw new d("The id should be of string type.");let p=Buffer.alloc(a.length+1);p[0]=r,a.forEach((e,t)=>{p[t+1]=e});let y=Buffer.from(p).toString("base64");return i&&(y=y.replace(/\//g,"_").replace(/\+/g,"-")),y}async decrypt(e){let t=0;if(null==e)return{body:e,propertiesDecryptedCount:t};let i=await this.getEncryptionSetting();if(!i)return{body:e,propertiesDecryptedCount:t};for(let n of i.pathsToEncrypt){let r=n.slice(1);if(!Object.prototype.hasOwnProperty.call(e,r))continue;let o=i.getEncryptionSettingForProperty(n);if(null==o)throw new d("Invalid Encryption Setting for the Path: "+n);e[r]=await this.decryptToken(e[r],o,"id"===r),t++}return{body:e,propertiesDecryptedCount:t}}async decryptToken(e,t,i){if("object"==typeof e)for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&(e[n]=await this.decryptToken(e[n],t,i));else if(Array.isArray(e))for(let n=0;n<e.length;n++)e[n]=await this.decryptToken(e[n],t,i);else e=await this.deserializeAndDecryptValue(e,t,i);return e}async deserializeAndDecryptValue(e,t,i){i&&(e=e.replace(/_/g,"/").replace(/-/g,"+"));let n=Buffer.from(e,"base64");if(null===n)return null;let r=Buffer.alloc(n.length-1);r=Buffer.from(n.slice(1));let o=(await this.buildEncryptionAlgorithm(t)).decrypt(r);if(null===o)throw new d("returned null plain text");return(function(e){switch(e){case G.Long:return new c;case G.Double:return new l;case G.String:return new u;case G.Boolean:return new h;default:throw Error("Invalid or Unsupported data type passed.")}})(n[0]).deserialize(o)}async getEncryptionSetting(e){let t=this.database._rid+"/"+this.containerRid,i=this.encryptionManager.encryptionSettingsCache.get(t);return e||!i?tZ(async e=>{let i=`/dbs/${this.database.id}/colls/${this.containerId}`,n=`dbs/${this.database.id}/colls/${this.containerId}`,r=await this.clientContext.read({path:i,resourceType:K.container,resourceId:n,diagnosticNode:e});if(!r||!r.result)throw new d("Failed to fetch container definition");let o=r.result._rid,s=r.result.clientEncryptionPolicy,a=r.result.partitionKey.paths;return await this.encryptionManager.encryptionSettingsCache.create(t,o,a,s)},this.clientContext):i}async buildEncryptionAlgorithm(e){let t=`${this.database._rid}/${e.encryptionKeyId}`,i=this.encryptionManager.clientEncryptionKeyPropertiesCache.get(t);i||(i=await this.fetchClientEncryptionKey(e.encryptionKeyId));try{return await e.buildEncryptionAlgorithm(i,this.encryptionManager)}catch(t){if(t.statusCode!==k.Forbidden)throw t;i=await this.fetchClientEncryptionKey(e.encryptionKeyId);try{return await e.buildEncryptionAlgorithm(i,this.encryptionManager,!0)}catch(t){if(t.statusCode!==k.Forbidden)throw t;return i=await this.fetchClientEncryptionKey(e.encryptionKeyId,i.etag),e.buildEncryptionAlgorithm(i,this.encryptionManager)}}}async fetchClientEncryptionKey(e,t){return tZ(async i=>{let n=`/dbs/${this.database.id}/clientencryptionkeys/${e}`,r=`dbs/${this.database.id}/clientencryptionkeys/${e}`,o={};t&&(o.accessCondition={type:s.HttpHeaders.IfNoneMatch,condition:t}),o.databaseRid=this.database._rid;let a=await this.clientContext.read({path:n,resourceType:K.clientencryptionkey,resourceId:r,options:o,diagnosticNode:i});if(!a)throw new d(`Failed to fetch client encryption key ${e}`);if(a.code===k.NotModified)throw new d(`The Client Encryption Key with key id: ${e} on database: ${this.database.id} needs to be rewrapped with a valid Key Encryption Key using rewrapClientEncryptionKey. The Key Encryption Key used to wrap the Client Encryption Key has been revoked`);let c={id:a.result.id,encryptionAlgorithm:a.result.encryptionAlgorithm,wrappedDataEncryptionKey:new Uint8Array(Buffer.from(a.result.wrappedDataEncryptionKey,"base64")),encryptionKeyWrapMetadata:a.result.keyWrapMetadata,etag:a.result._etag},l=this.database._rid+"/"+e;return this.encryptionManager.clientEncryptionKeyPropertiesCache.set(l,c),c},this.clientContext)}}!function(e){e.Integer="Integer",e.Float="Float"}(eF||(eF={}));class rV{database;id;clientContext;encryptionManager;$items;get items(){return this.$items||(this.$items=new nW(this,this.clientContext)),this.$items}$scripts;get scripts(){return this.$scripts||(this.$scripts=new n2(this,this.clientContext)),this.$scripts}$conflicts;get conflicts(){return this.$conflicts||(this.$conflicts=new nI(this,this.clientContext)),this.$conflicts}get url(){return F(this.database.id,this.id)}encryptionProcessor;_rid;isEncryptionInitialized=!1;encryptionInitializationPromise;constructor(e,t,i,n,r){this.database=e,this.id=t,this.clientContext=i,this.encryptionManager=n,this._rid=r,this.clientContext.enableEncryption&&(this.encryptionProcessor=new rQ(this.id,this._rid,this.database,this.clientContext,this.encryptionManager))}item(e,t){return new nA(this,e,this.clientContext,t)}conflict(e,t){return new nS(this,e,this.clientContext,t)}async read(e){return tZ(async t=>this.readInternal(t,e),this.clientContext)}async readInternal(e,t){let i=T(this.url),n=v(this.url),r=await this.clientContext.read({path:i,resourceType:K.container,resourceId:n,options:t,diagnosticNode:e});return this.clientContext.partitionKeyDefinitionCache[this.url]=r.result.partitionKey,new n6(r.result,r.headers,r.code,this,tG())}async replace(e,t){return tZ(async i=>{let n={};if(!x(e,n))throw n;let r=T(this.url),o=v(this.url),s=await this.clientContext.replace({body:e,path:r,resourceType:K.container,resourceId:o,options:t,diagnosticNode:i});return new n6(s.result,s.headers,s.code,this,tG())},this.clientContext)}async delete(e){return tZ(async t=>{let i=T(this.url),n=v(this.url),r=await this.clientContext.delete({path:i,resourceType:K.container,resourceId:n,options:e,diagnosticNode:t});return new n6(r.result,r.headers,r.code,this,tG())},this.clientContext)}async getPartitionKeyDefinition(){return tZ(async e=>this.readPartitionKeyDefinition(e),this.clientContext)}async readPartitionKeyDefinition(e){if(this.url in this.clientContext.partitionKeyDefinitionCache)return e.addData({readFromCache:!0}),new tm(this.clientContext.partitionKeyDefinitionCache[this.url],{},0,tG());let{headers:t,statusCode:i,diagnostics:n}=await tY(async e=>this.readInternal(e),e,ep.ContainerLookUp);return new tm(this.clientContext.partitionKeyDefinitionCache[this.url],t,i,n)}async readOffer(e={}){return tZ(async t=>{let{resource:i}=await this.read(),n=i._self,r=await this.clientContext.queryFeed({path:"/offers",resourceId:"",resourceType:K.offer,query:`SELECT * from root where root.resource = "${n}"`,resultFn:e=>e.Offers,options:e,diagnosticNode:t}),o=r.result[0]?new n5(this.database.client,r.result[0].id,this.clientContext):void 0;return new n3(r.result[0],r.headers,r.code,tG(),o)},this.clientContext)}async getQueryPlan(e){return tZ(async t=>{let i=T(this.url);return this.clientContext.getQueryPlan(i+"/docs",K.item,v(this.url),e,{},t)},this.clientContext)}readPartitionKeyRanges(e){return e=e||{},this.clientContext.queryPartitionKeyRanges(this.url,void 0,e)}async getFeedRanges(){return tZ(async e=>{let{resources:t}=await this.readPartitionKeyRanges().fetchAllInternal(e),i=[];for(let e of t){let t=new iR(e.minInclusive,e.maxExclusive);Object.freeze(t),i.push(t)}return i},this.clientContext)}async deleteAllItemsForPartitionKey(e,t){return tZ(async i=>{let n,r=T(this.url),o=v(this.url);if(r+="/operations/partitionkeydelete",this.clientContext.enableEncryption){await this.checkAndInitializeEncryption(),(t=t||{}).containerRid=this._rid,i.beginEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation);let n=to(e),{partitionKeyList:r,encryptedCount:o}=await this.encryptionProcessor.getEncryptedPartitionKeyValue(n);e=r,i.endEncryptionDiagnostics(s.Encryption.DiagnosticsEncryptOperation,o)}try{n=await this.clientContext.delete({path:r,resourceType:K.container,resourceId:o,options:t,partitionKey:e,method:H.post,diagnosticNode:i})}catch(e){throw this.clientContext.enableEncryption&&await this.throwIfRequestNeedsARetryPostPolicyRefresh(e),e}return new n6(n.result,n.headers,n.code,this,tG())},this.clientContext)}async initializeEncryption(){if(this.clientContext.enableEncryption)await tZ(async e=>{let t=await this.readInternal(e);if(!t||!t.resource)throw new d("Failed to initialize encryption: The container's resource definition could not be retrieved.");this._rid=t.resource._rid,this.encryptionProcessor.containerRid=this._rid;let i=t.resource.clientEncryptionPolicy;if(!i)return;let n=t.resource.partitionKey.paths,r=await this.database.readInternal(e);if(!r||!r.resource)throw new d("Failed to initialize encryption: The database's resource definition could not be retrieved.");this.database._rid=r.resource._rid;let o=this.database._rid+"/"+this._rid;for(let e of(await this.encryptionManager.encryptionSettingsCache.create(o,this._rid,n,i),[...new Set(i.includedPaths.map(e=>e.clientEncryptionKeyId))])){let t=await this.database.readClientEncryptionKey(e);if(!t||!t.clientEncryptionKeyProperties)throw new d(`Failed to initialize encryption: The client encryption key ${e} could not be retrieved.`);let i=t.clientEncryptionKeyProperties,n=this.database._rid+"/"+e;this.encryptionManager.clientEncryptionKeyPropertiesCache.set(n,i)}this.isEncryptionInitialized=!0},this.clientContext);else throw new d("Encryption is not enabled for the client.")}async checkAndInitializeEncryption(){this.isEncryptionInitialized||(this.encryptionInitializationPromise||(this.encryptionInitializationPromise=this.initializeEncryption()),await this.encryptionInitializationPromise)}async throwIfRequestNeedsARetryPostPolicyRefresh(e){let t=this.database._rid+"/"+this._rid,i=this.encryptionManager.encryptionSettingsCache.get(t);if(!e?.code||!e?.headers?.[s.HttpHeaders.SubStatus])return;let n=e.headers[s.HttpHeaders.SubStatus],r=Number(n)===O.PartitionKeyMismatch,o=Number(n)===O.IncorrectContainerRidSubstatus;if(e.code===k.BadRequest&&(r||o)){if(r&&i.partitionKeyPaths.length){let e=null;for(let t of i.partitionKeyPaths){let n=t.split("/")[1];if(e=i.getEncryptionSettingForProperty(n))break}if(null==e)return}if(i.containerRid===(await this.encryptionProcessor.getEncryptionSetting(!0)).containerRid)return;throw await this.initializeEncryption(),new d("Operation has failed due to a possible mismatch in Client Encryption Policy configured on the container. Retrying may fix the issue. Please refer to https://aka.ms/CosmosClientEncryption for more details."+e.message)}}}function rW(e){if(e.throughput){if(e.maxThroughput)throw console.log("should be erroring"),Error("Cannot specify `throughput` with `maxThroughput`");if(e.autoUpgradePolicy)throw Error("Cannot specify autoUpgradePolicy with throughput. Use `maxThroughput` instead")}}class r${database;clientContext;encryptionManager;constructor(e,t,i){this.database=e,this.clientContext=t,this.encryptionManager=i}query(e,t){let i=T(this.database.url,K.container),n=v(this.database.url);return new nv(this.clientContext,e,t,(t,r)=>this.clientContext.queryFeed({path:i,resourceType:K.container,resourceId:n,resultFn:e=>e.DocumentCollections,query:e,options:r,diagnosticNode:t}))}async create(e,t={}){return tZ(async i=>this.createInternal(i,e,t),this.clientContext)}async createInternal(e,t,i={}){let n={};if(!x(t,n))throw n;let r=T(this.database.url,K.container),o=v(this.database.url);if(rW(t),t.maxThroughput){let e={maxThroughput:t.maxThroughput};t.autoUpgradePolicy&&(e.autoUpgradePolicy=t.autoUpgradePolicy);let n=JSON.stringify(e);i.initialHeaders=Object.assign({},i.initialHeaders,{[s.HttpHeaders.AutoscaleSettings]:n}),delete t.maxThroughput,delete t.autoUpgradePolicy}if(t.throughput&&(i.initialHeaders=Object.assign({},i.initialHeaders,{[s.HttpHeaders.OfferThroughput]:t.throughput}),delete t.throughput),"string"==typeof t.partitionKey){if(!t.partitionKey.startsWith("/"))throw Error("Partition key must start with '/'");t.partitionKey={paths:[t.partitionKey]}}t.partitionKey&&t.partitionKey.paths||(t.partitionKey={paths:[ts]}),this.clientContext.enableEncryption&&t.clientEncryptionPolicy&&(t.clientEncryptionPolicy.policyFormatVersion=t.clientEncryptionPolicy.policyFormatVersion??1,function(e,t){let i=e.policyFormatVersion;if(i<1||i>2)throw new d("Supported versions of client encryption policy are 1 and 2.");let n=new Set;for(let t of e.includedPaths){if(n.has(t.path))throw new d(`Duplicate path found: ${t.path} in client encryption policy.`);if(void 0===t.path||null===t.path||""===t.path||"/"===t.path)throw new d("Path needs to be defined in ClientEncryptionIncludedPath.");if(void 0===t.clientEncryptionKeyId||null===t.clientEncryptionKeyId||""===t.clientEncryptionKeyId||"string"!=typeof t.clientEncryptionKeyId)throw new d("ClientEncryptionKeyId needs to be defined as string type in ClientEncryptionIncludedPath.");if("/"!==t.path[0])throw new d("Path in ClientEncryptionIncludedPath must start with '/'.");if(t.path.split("/").filter(e=>e.length>0).length>1)throw new d("Only top-level paths are currently supported for encryption");n.add(t.path)}let r=e.includedPaths,o=t.paths.map(D),s=!1,a=!1;for(let e of r){if("/id"===e.path&&(a=!0,e.encryptionType!==j.DETERMINISTIC))throw new d("The '/id' property must be encrypted using Deterministic encryption.");if(o.includes(e.path)&&(s=!0,e.encryptionType!==j.DETERMINISTIC))throw new d(`Path: ${e.path} which is part of the partition key has to be encrypted with Deterministic type Encryption.`)}if((s||a)&&1===e.policyFormatVersion)throw new d("Encryption of partition key or id is only supported with policy format version 2.")}(t.clientEncryptionPolicy,t.partitionKey));let a=await this.clientContext.create({body:t,path:r,resourceType:K.container,resourceId:o,diagnosticNode:e,options:i}),c=new rV(this.database,a.result.id,this.clientContext,this.encryptionManager,a.result._rid);return this.clientContext.partitionKeyDefinitionCache[c.url]=a.result.partitionKey,new n6(a.result,a.headers,a.code,c,tG())}async createIfNotExists(e,t){if(!e||null===e.id||void 0===e.id)throw Error("body parameter must be an object with an id property");return tZ(async i=>{try{return await this.database.container(e.id).readInternal(i,t)}catch(n){if(n.code===k.NotFound){let r=await this.createInternal(i,e,t);return tM(r.headers,n.headers),r}throw n}},this.clientContext)}readAll(e){return this.query(void 0,e)}}class rj extends tm{constructor(e,t,i,n,r){super(e,t,i,r),this.permission=n}permission}class rG{user;id;clientContext;get url(){var e,t,i;return e=this.user.database.id,t=this.user.id,P(i=I(i=this.id)),B(e,t)+"/"+s.Path.PermissionsPathSegment+"/"+i}constructor(e,t,i){this.user=e,this.id=t,this.clientContext=i}async read(e){return tZ(async t=>{let i=T(this.url),n=v(this.url),r=await this.clientContext.read({path:i,resourceType:K.permission,resourceId:n,options:e,diagnosticNode:t});return new rj(r.result,r.headers,r.code,this,tG())},this.clientContext)}async replace(e,t){return tZ(async i=>{let n={};if(!x(e,n))throw n;let r=T(this.url),o=v(this.url),s=await this.clientContext.replace({body:e,path:r,resourceType:K.permission,resourceId:o,options:t,diagnosticNode:i});return new rj(s.result,s.headers,s.code,this,tG())},this.clientContext)}async delete(e){return tZ(async t=>{let i=T(this.url),n=v(this.url),r=await this.clientContext.delete({path:i,resourceType:K.permission,resourceId:n,options:e,diagnosticNode:t});return new rj(r.result,r.headers,r.code,this,tG())},this.clientContext)}}class rJ{user;clientContext;constructor(e,t){this.user=e,this.clientContext=t}query(e,t){let i=T(this.user.url,K.permission),n=v(this.user.url);return new nv(this.clientContext,e,t,(t,r)=>this.clientContext.queryFeed({path:i,resourceType:K.permission,resourceId:n,resultFn:e=>e.Permissions,query:e,options:r,diagnosticNode:t}))}readAll(e){return this.query(void 0,e)}async create(e,t){return tZ(async i=>{let n={};if(!x(e,n))throw n;let r=T(this.user.url,K.permission),o=v(this.user.url),s=await this.clientContext.create({body:e,path:r,resourceType:K.permission,resourceId:o,diagnosticNode:i,options:t}),a=new rG(this.user,s.result.id,this.clientContext);return new rj(s.result,s.headers,s.code,a,tG())},this.clientContext)}async upsert(e,t){return tZ(async i=>{let n={};if(!x(e,n))throw n;let r=T(this.user.url,K.permission),o=v(this.user.url),s=await this.clientContext.upsert({body:e,path:r,resourceType:K.permission,resourceId:o,options:t,diagnosticNode:i}),a=new rG(this.user,s.result.id,this.clientContext);return new rj(s.result,s.headers,s.code,a,tG())},this.clientContext)}}class rY extends tm{constructor(e,t,i,n,r){super(e,t,i,r),this.user=n}user}class rZ{database;id;clientContext;permissions;get url(){return B(this.database.id,this.id)}constructor(e,t,i){this.database=e,this.id=t,this.clientContext=i,this.permissions=new rJ(this,this.clientContext)}permission(e){return new rG(this,e,this.clientContext)}async read(e){return tZ(async t=>{let i=T(this.url),n=v(this.url),r=await this.clientContext.read({path:i,resourceType:K.user,resourceId:n,options:e,diagnosticNode:t});return new rY(r.result,r.headers,r.code,this,tG())},this.clientContext)}async replace(e,t){return tZ(async i=>{let n={};if(!x(e,n))throw n;let r=T(this.url),o=v(this.url),s=await this.clientContext.replace({body:e,path:r,resourceType:K.user,resourceId:o,options:t,diagnosticNode:i});return new rY(s.result,s.headers,s.code,this,tG())},this.clientContext)}async delete(e){return tZ(async t=>{let i=T(this.url),n=v(this.url),r=await this.clientContext.delete({path:i,resourceType:K.user,resourceId:n,options:e,diagnosticNode:t});return new rY(r.result,r.headers,r.code,this,tG())},this.clientContext)}}class rX{database;clientContext;constructor(e,t){this.database=e,this.clientContext=t}query(e,t){let i=T(this.database.url,K.user),n=v(this.database.url);return new nv(this.clientContext,e,t,(t,r)=>this.clientContext.queryFeed({path:i,resourceType:K.user,resourceId:n,resultFn:e=>e.Users,query:e,options:r,diagnosticNode:t}))}readAll(e){return this.query(void 0,e)}async create(e,t){return tZ(async i=>{let n={};if(!x(e,n))throw n;let r=T(this.database.url,K.user),o=v(this.database.url),s=await this.clientContext.create({body:e,path:r,resourceType:K.user,resourceId:o,options:t,diagnosticNode:i}),a=new rZ(this.database,s.result.id,this.clientContext);return new rY(s.result,s.headers,s.code,a,tG())},this.clientContext)}async upsert(e,t){return tZ(async i=>{let n={};if(!x(e,n))throw n;let r=T(this.database.url,K.user),o=v(this.database.url),s=await this.clientContext.upsert({body:e,path:r,resourceType:K.user,resourceId:o,options:t,diagnosticNode:i}),a=new rZ(this.database,s.result.id,this.clientContext);return new rY(s.result,s.headers,s.code,a,tG())},this.clientContext)}}class r0 extends tm{constructor(e,t,i,n,r){super(e,t,i,r),this.database=n}database}class r1{client;id;clientContext;encryptionManager;containers;users;get url(){return L(this.id)}_rid;constructor(e,t,i,n,r){this.client=e,this.id=t,this.clientContext=i,this.encryptionManager=n,this.containers=new r$(this,this.clientContext,this.encryptionManager),this.users=new rX(this,this.clientContext),this._rid=r}container(e){return new rV(this,e,this.clientContext,this.encryptionManager)}user(e){return new rZ(this,e,this.clientContext)}async read(e){return tZ(async t=>this.readInternal(t,e),this.clientContext)}async readInternal(e,t){let i=T(this.url),n=v(this.url),r=await this.clientContext.read({path:i,resourceType:K.database,resourceId:n,options:t,diagnosticNode:e});return new r0(r.result,r.headers,r.code,this,tG())}async delete(e){return tZ(async t=>{let i=T(this.url),n=v(this.url),r=await this.clientContext.delete({path:i,resourceType:K.database,resourceId:n,options:e,diagnosticNode:t});return new r0(r.result,r.headers,r.code,this,tG())},this.clientContext)}async readOffer(e={}){return tZ(async t=>{let{resource:i}=await tY(async e=>this.readInternal(e),t,ep.DatabaseLookUp),n=i._self,r=await this.clientContext.queryFeed({path:"/offers",resourceId:"",resourceType:K.offer,query:`SELECT * from root where root.resource = "${n}"`,resultFn:e=>e.Offers,options:e,diagnosticNode:t}),o=r.result[0]?new n5(this.client,r.result[0].id,this.clientContext):void 0;return new n3(r.result[0],r.headers,r.code,tG(),o)},this.clientContext)}async createClientEncryptionKey(e,t,i){if(null==e||!e.trim())throw Error("encryption key id cannot be null or empty");if(t!==eb.AEAD_AES_256_CBC_HMAC_SHA256)throw Error(`Invalid encryption algorithm '${t}' passed.`);if(!i)throw Error("encryptionKeyWrapMetadata cannot be null.");if(i.algorithm!==eT.RSA_OAEP)throw Error(`Invalid key wrap algorithm '${i.algorithm}' passed.`);if(!this.clientContext.enableEncryption)throw Error("Creating a client encryption key requires the use of an encryption-enabled client.");let n=this.encryptionManager.keyEncryptionKeyCache.getOrCreate(i.name,i.value,this.encryptionManager.encryptionKeyStoreProvider),r=(await this.encryptionManager.protectedDataEncryptionKeyCache.getOrCreate(e,n)).encryptedValue,o={id:e,encryptionAlgorithm:t,keyWrapMetadata:i,wrappedDataEncryptionKey:r.toString("base64")};return tZ(async e=>{let t=T(this.url,K.clientencryptionkey),i=v(this.url),n=await this.clientContext.create({body:o,path:t,resourceType:K.clientencryptionkey,resourceId:i,diagnosticNode:e}),r={id:n.result.id,encryptionAlgorithm:n.result.encryptionAlgorithm,etag:n.result._etag,wrappedDataEncryptionKey:new Uint8Array(Buffer.from(n.result.wrappedDataEncryptionKey,"base64")),encryptionKeyWrapMetadata:n.result.keyWrapMetadata};return new n8(n.result,n.headers,n.code,r,tG())},this.clientContext)}async readClientEncryptionKey(e){if(null==e||!e.trim())throw new d("encryption key id cannot be null or empty");return tZ(async t=>{if(!this._rid){let i=await this.readInternal(t);if(!i||!i.resource)throw new d(`Error reading database with id ${e}`);this._rid=i.resource._rid}let i=T(this.url,K.clientencryptionkey),n=v(this.url),r=await this.clientContext.read({path:i+`/${e}`,resourceType:K.clientencryptionkey,resourceId:n+`/${K.clientencryptionkey}/${e}`,options:{databaseRid:this._rid},diagnosticNode:t});if(!r||!r.result)throw new d(`Error reading client encryption key with id ${e}`);let o={id:r.result.id,encryptionAlgorithm:r.result.encryptionAlgorithm,etag:r.result._etag,wrappedDataEncryptionKey:new Uint8Array(Buffer.from(r.result.wrappedDataEncryptionKey,"base64")),encryptionKeyWrapMetadata:r.result.keyWrapMetadata};return new n8(r.result,r.headers,r.code,o,tG())},this.clientContext)}async rewrapClientEncryptionKey(e,t){if(null==e||!e.trim())throw new d("encryption key id cannot be null or empty");if(!t)throw new d("encryptionKeyWrapMetadata cannot be null.");if(t.algorithm!==eT.RSA_OAEP)throw new d(`Invalid key wrap algorithm '${t.algorithm}' passed.`);if(!this.clientContext.enableEncryption)throw new d("Rewrapping a client encryption key requires the use of an encryption-enabled client.");let i=await this.readClientEncryptionKey(e);if(!i||!i.clientEncryptionKeyProperties)throw new d(`Error reading client encryption key with id ${e}`);let n=i.clientEncryptionKeyProperties,r=this.encryptionManager.keyEncryptionKeyCache.getOrCreate(n.encryptionKeyWrapMetadata.name,n.encryptionKeyWrapMetadata.value,this.encryptionManager.encryptionKeyStoreProvider),o=await r.unwrapEncryptionKey(Buffer.from(n.wrappedDataEncryptionKey));r=this.encryptionManager.keyEncryptionKeyCache.getOrCreate(t.name,t.value,this.encryptionManager.encryptionKeyStoreProvider);let s=await r.wrapEncryptionKey(o);n={id:e,encryptionAlgorithm:n.encryptionAlgorithm,etag:n.etag,wrappedDataEncryptionKey:s,encryptionKeyWrapMetadata:t};let a={id:e,encryptionAlgorithm:n.encryptionAlgorithm,keyWrapMetadata:t,wrappedDataEncryptionKey:s.toString("base64")};return tZ(async t=>{let i=T(this.url,K.clientencryptionkey),r=v(this.url),o={accessCondition:{type:"IfMatch",condition:n.etag}},s=await this.clientContext.replace({body:a,path:i+`/${e}`,resourceType:K.clientencryptionkey,resourceId:r+`/${K.clientencryptionkey}/${e}`,options:o,diagnosticNode:t});if(!s||!s.result)throw new d(`Error rewrapping client encryption key with id ${e}`);let c={id:s.result.id,encryptionAlgorithm:s.result.encryptionAlgorithm,etag:s.result._etag,wrappedDataEncryptionKey:new Uint8Array(Buffer.from(s.result.wrappedDataEncryptionKey,"base64")),encryptionKeyWrapMetadata:s.result.keyWrapMetadata};return new n8(s.result,s.headers,s.code,c,tG())},this.clientContext)}}class r2{client;clientContext;encryptionManager;constructor(e,t,i){this.client=e,this.clientContext=t,this.encryptionManager=i}query(e,t){return new nv(this.clientContext,e,t,(t,i)=>this.clientContext.queryFeed({path:"/dbs",resourceType:K.database,resourceId:"",resultFn:e=>e.Databases,query:e,options:i,diagnosticNode:t}))}async create(e,t={}){return tZ(async i=>this.createInternal(i,e,t),this.clientContext)}async createInternal(e,t,i={}){let n={};if(!x(t,n))throw n;if(rW(t),t.maxThroughput){let e={maxThroughput:t.maxThroughput};t.autoUpgradePolicy&&(e.autoUpgradePolicy=t.autoUpgradePolicy);let n=JSON.stringify(e);i.initialHeaders=Object.assign({},i.initialHeaders,{[s.HttpHeaders.AutoscaleSettings]:n}),delete t.maxThroughput,delete t.autoUpgradePolicy}t.throughput&&(i.initialHeaders=Object.assign({},i.initialHeaders,{[s.HttpHeaders.OfferThroughput]:t.throughput}),delete t.throughput);let r=await this.clientContext.create({body:t,path:"/dbs",resourceType:K.database,resourceId:void 0,diagnosticNode:e,options:i}),o=new r1(this.client,t.id,this.clientContext,this.encryptionManager,r.result._rid);return new r0(r.result,r.headers,r.code,o,tG())}async createIfNotExists(e,t){if(!e||null===e.id||void 0===e.id)throw Error("body parameter must be an object with an id property");return tZ(async i=>{try{return await this.client.database(e.id).readInternal(i,t)}catch(n){if(n.code===k.NotFound){let r=await this.createInternal(i,e,t);return tM(r.headers,n.headers),r}throw n}},this.clientContext)}readAll(e){return this.query(void 0,e)}}async function r6(e,t,i,n){if(!t.plugins)return i(t,e,void 0);let r=0,o=s=>++r>=s.plugins.length?i(t,e,void 0):s.plugins[r].on!==n?o(t):s.plugins[r].plugin(s,e,o);return t.plugins[r].on!==n?o(t):t.plugins[r].plugin(t,e,o)}!function(e){e.request="request",e.operation="operation"}(eB||(eB={}));let r3=[10004,10009,10013,10014,10022,10035,10036,10048,10054,10058,10060,10061,10063,10064,10065,"ECONNRESET",tk,"EPIPE"];class r5{operationType;maxTries=10;currentRetryAttemptCount=0;retryAfterInMs=1e3;constructor(e){this.operationType=e}async shouldRetry(e,t){if(e){var i,n;if(this.currentRetryAttemptCount<this.maxTries&&(i=this.operationType,n=e.code,(i===q.Read||i===q.Query)&&r3.includes(n)))return t.addData({successfulRetryPolicy:"default"}),this.currentRetryAttemptCount++,!0}return!1}}class r4{globalEndpointManager;resourceType;operationType;globalPartitionEndpointManager;currentRetryAttemptCount;retryAfterInMs;maxTries;static maxTries=120;static retryAfterInMs=1e3;constructor(e,t,i,n){this.globalEndpointManager=e,this.resourceType=t,this.operationType=i,this.globalPartitionEndpointManager=n,this.maxTries=r4.maxTries,this.currentRetryAttemptCount=0,this.retryAfterInMs=r4.retryAfterInMs}async shouldRetry(e,t,i,n,r){return!!e&&!!i&&!!n&&!!this.globalEndpointManager.enableEndpointDiscovery&&(!!(this.globalPartitionEndpointManager&&await this.globalPartitionEndpointManager.tryPartitionLevelFailover(r,t))||!(this.currentRetryAttemptCount>=this.maxTries)&&(this.currentRetryAttemptCount++,i.retryCount=this.currentRetryAttemptCount,i.clearSessionTokenNotAvailable=!1,i.retryRequestOnPreferredLocations=!1,t.addData({successfulRetryPolicy:"endpointDiscovery"}),this.resourceType===K.none&&this.operationType===q.Read||(C(this.operationType)?await this.globalEndpointManager.markCurrentLocationUnavailableForRead(t,n):await this.globalEndpointManager.markCurrentLocationUnavailableForWrite(t,n),!0)))}}class r8{globalEndpointManager;resourceType;operationType;connectionPolicy;currentRetryAttemptCount=0;retryAfterInMs=0;constructor(e,t,i,n){this.globalEndpointManager=e,this.resourceType=t,this.operationType=i,this.connectionPolicy=n}async shouldRetry(e,t,i){if(!e||!i||!this.connectionPolicy.enableEndpointDiscovery)return!1;if(this.globalEndpointManager.canUseMultipleWriteLocations(this.resourceType,this.operationType)){let e=C(this.operationType)?await this.globalEndpointManager.getReadEndpoints():await this.globalEndpointManager.getWriteEndpoints();return!(this.currentRetryAttemptCount>e.length)&&(this.currentRetryAttemptCount++,i.retryCount++,i.retryRequestOnPreferredLocations=this.currentRetryAttemptCount>1,i.clearSessionTokenNotAvailable=this.currentRetryAttemptCount===e.length,t.addData({successfulRetryPolicy:"session"}),!0)}return!(this.currentRetryAttemptCount>1)&&(this.currentRetryAttemptCount++,i.retryCount++,i.retryRequestOnPreferredLocations=!1,i.clearSessionTokenNotAvailable=!0,t.addData({successfulRetryPolicy:"session"}),!0)}}class r9{globalEndpointManager;headers;methodType;resourceType;operationType;enableEndPointDiscovery;globalPartitionEndpointManager;maxRetryAttemptCount=120;maxServiceUnavailableRetryCount=1;retryAfterInMs=0;failoverRetryCount=0;request;locationEndpoint;constructor(e,t,i,n,r,o,s){this.globalEndpointManager=e,this.headers=t,this.methodType=i,this.resourceType=n,this.operationType=r,this.enableEndPointDiscovery=o,this.globalPartitionEndpointManager=s}isValidRequestForTimeoutError(){let e=s.HttpHeaders.IsQuery in this.headers,t=s.HttpHeaders.IsQueryPlan in this.headers;return this.methodType===H.get||!!e||!!t}async shouldRetry(e,t,i,n,r){if(!e||!i||!n||!this.enableEndPointDiscovery||(r&&this.globalPartitionEndpointManager&&await this.globalPartitionEndpointManager.tryPartitionLevelFailover(r,t),e.code===tk&&!this.isValidRequestForTimeoutError()||e.code===k.ServiceUnavailable&&this.failoverRetryCount>=this.maxServiceUnavailableRetryCount||this.failoverRetryCount>=this.maxRetryAttemptCount))return!1;let o=this.globalEndpointManager.canUseMultipleWriteLocations(this.resourceType,this.operationType),s=C(this.operationType);return!!(o||s||this.globalPartitionEndpointManager?.isPartitionLevelAutomaticFailoverEnabled())&&(this.failoverRetryCount++,i.retryLocationServerIndex=await this.findEndpointIndex(this.failoverRetryCount),t.addData({successfulRetryPolicy:"timeout-failover"}),!0)}async findEndpointIndex(e){let t=this.globalEndpointManager.preferredLocationsCount,i=C(this.operationType),n=0;if(0!==t)n=e%t;else if(i){let t=await this.globalEndpointManager.getReadEndpoints();t&&t.length>0&&(n=e%t.length)}else{let t=await this.globalEndpointManager.getWriteEndpoints();t&&t.length>0&&(n=e%t.length)}return n}}async function r7({diagnosticNode:e,retryContext:t={retryCount:0},retryPolicies:i,requestContext:n,executeRequest:r}){return tJ(async o=>{o.addData({requestAttempNumber:t.retryCount}),i||(i={endpointDiscoveryRetryPolicy:new r4(n.globalEndpointManager,n.resourceType,n.operationType,n.globalPartitionEndpointManager),resourceThrottleRetryPolicy:new nL(n.connectionPolicy.retryOptions??{}),sessionReadRetryPolicy:new r8(n.globalEndpointManager,n.resourceType,n.operationType,n.connectionPolicy),defaultRetryPolicy:new r5(n.operationType),timeoutFailoverRetryPolicy:new r9(n.globalEndpointManager,n.headers,n.method,n.resourceType,n.operationType,n.connectionPolicy.enableEndpointDiscovery,n.globalPartitionEndpointManager)}),t&&t.clearSessionTokenNotAvailable&&(n.client.clearSessionToken(n.path),delete n.headers["x-ms-session-token"]),t&&t.retryLocationServerIndex?n.endpoint=await n.globalEndpointManager.resolveServiceEndpointInternal({diagnosticNode:o,resourceType:n.resourceType,operationType:n.operationType,startServiceEndpointIndex:t.retryLocationServerIndex,excludedLocations:n.options?.excludedLocations}):n.endpoint=await n.globalEndpointManager.resolveServiceEndpointInternal({diagnosticNode:o,resourceType:n.resourceType,operationType:n.operationType,startServiceEndpointIndex:0,excludedLocations:n.options?.excludedLocations});let a=t_(),c=n.headers[s.HttpHeaders.CorrelatedActivityId];n.globalPartitionEndpointManager&&(n=await n.globalPartitionEndpointManager.tryAddPartitionLevelLocationOverride(n,o));try{let e=await r(o,n);return e.headers[s.ThrottleRetryCount]=i.resourceThrottleRetryPolicy.currentRetryAttemptCount,e.headers[s.ThrottleRetryWaitTimeInMs]=i.resourceThrottleRetryPolicy.cummulativeWaitTimeinMs,c&&(e.headers[s.HttpHeaders.CorrelatedActivityId]=c),e}catch(p){var l;let u=null,h=p.headers||{};c&&(h[s.HttpHeaders.CorrelatedActivityId]=c),u=p.code===k.ENOTFOUND||"REQUEST_SEND_ERROR"===p.code||p.code===k.Forbidden&&(p.substatus===O.DatabaseAccountNotFound||p.substatus===O.WriteForbidden)?i.endpointDiscoveryRetryPolicy:p.code===k.TooManyRequests&&("batch"!==(l=n).operationType||l.headers[s.HttpHeaders.IsBatchAtomic])?i.resourceThrottleRetryPolicy:p.code===k.NotFound&&p.substatus===O.ReadSessionNotAvailable?i.sessionReadRetryPolicy:p.code===k.ServiceUnavailable||p.code===tk?i.timeoutFailoverRetryPolicy:i.defaultRetryPolicy;let d=await u.shouldRetry(p,o,t,n.endpoint,n);if(d){n.retryCount++;let s=d[1];return void 0!==s&&(n.endpoint=s),o.recordFailedNetworkCall(a,n,t.retryCount,p.code,p.subsstatusCode,h),await E(u.retryAfterInMs),r7({diagnosticNode:e,executeRequest:r,requestContext:n,retryContext:t,retryPolicies:i})}throw h[s.ThrottleRetryCount]=i.resourceThrottleRetryPolicy.currentRetryAttemptCount,h[s.ThrottleRetryWaitTimeInMs]=i.resourceThrottleRetryPolicy.cummulativeWaitTimeinMs,p.headers={...p.headers,...h},p}},e,ef.HTTP_REQUEST)}let oe=new rp.Agent({keepAlive:!0,minVersion:"TLSv1.2"}),ot=new rd.Agent({keepAlive:!0}),oi=tt("RequestHandler");async function on(e,t){return r6(e,t,or,eB.request)}async function or(e,t){var i,n;let o,a;let c=new AbortController,l=c.signal,u=e.options&&e.options.abortSignal;u&&(u.aborted?c.abort():(a=()=>{c.abort()},u.addEventListener("abort",a)));let h=e.connectionPolicy.requestTimeout;(e.globalPartitionEndpointManager?.isPartitionLevelAutomaticFailoverEnabled()||e.globalPartitionEndpointManager?.isPartitionLevelCircuitBreakerEnabled())&&e.partitionKeyRangeId&&e.resourceType===K.item&&C(e.operationType)&&(h=Math.min(e.connectionPolicy.requestTimeout,s.RequestTimeoutForReadsInMs));let p=setTimeout(()=>{c.abort()},h);e.body&&(e.body=iF(e.body));let y=e.httpClient??(r||(r=function(){let e=new rx;return{async sendRequest(t){let{abortSignal:i,cleanup:n}=t.abortSignal?function(e){if(e instanceof AbortSignal)return{abortSignal:e};if(e.aborted)return{abortSignal:AbortSignal.abort(e.reason)};let t=new AbortController,i=!0;function n(){i&&(e.removeEventListener("abort",r),i=!1)}function r(){t.abort(e.reason),n()}return e.addEventListener("abort",r),{abortSignal:t.signal,cleanup:n}}(t.abortSignal):{};try{return t.abortSignal=i,await e.sendRequest(t)}finally{n?.()}}}}()),r),f=(i=e.endpoint,n=e.path,R(i)+n),g=new rt({url:f,headers:new re(e.headers),method:e.method,abortSignal:l,body:e.body});if(e.requestAgent)g.agent=e.requestAgent;else{let e=new URL(f);g.agent="http:"===e.protocol?ot:oe,g.allowInsecureConnection="http:"===e.protocol}let m=t_();try{o=e.pipeline?await e.pipeline.sendRequest(y,g):await y.sendRequest(g)}catch(t){if("AbortError"===t.name){if(u&&!0===u.aborted)throw t;throw new tO(`Timeout Error! Request took more than ${e.connectionPolicy.requestTimeout} ms`)}throw t}finally{clearTimeout(p),u&&a&&u.removeEventListener("abort",a)}let E=204===o.status||304===o.status||""===o.bodyAsText?null:JSON.parse(o.bodyAsText),w=o.headers.toJSON(),x=w[s.HttpHeaders.SubStatus]?parseInt(w[s.HttpHeaders.SubStatus],10):void 0;if(t.recordSuccessfulNetworkCall(m,e,o,x,f),o.status>=400){let t=new d(E.message);throw oi.warning(o.status+" "+e.endpoint+" "+e.path+" "+E.message),t.code=o.status,t.body=E,t.headers=w,s.HttpHeaders.ActivityId in w&&(t.activityId=w[s.HttpHeaders.ActivityId]),s.HttpHeaders.SubStatus in w&&(t.substatus=x),s.HttpHeaders.RetryAfterInMs in w&&(t.retryAfterInMs=parseInt(w[s.HttpHeaders.RetryAfterInMs],10),Object.defineProperty(t,"retryAfterInMilliseconds",{get:()=>t.retryAfterInMs})),t}return{headers:w,result:E,code:o.status,substatus:x}}let oo={request:async function(e,t){if(e.body&&(e.body=iF(e.body),!e.body))throw Error("parameter data must be a javascript object, string, or Buffer");return tJ(async t=>r7({diagnosticNode:t,requestContext:e,executeRequest:on}),t,ef.REQUEST_ATTEMPTS)}};class os{version;globalLsn;localLsnByregion;sessionToken;static SEGMENT_SEPARATOR="#";static REGION_PROGRESS_SEPARATOR="=";constructor(e,t,i,n){if(this.version=e,this.globalLsn=t,this.localLsnByregion=i,this.sessionToken=n,!this.sessionToken){let e=[];for(let[t,i]of this.localLsnByregion.entries())e.push(`${t}${os.REGION_PROGRESS_SEPARATOR}${i}`);let t=e.join(os.SEGMENT_SEPARATOR);""===t?this.sessionToken=`${this.version}${os.SEGMENT_SEPARATOR}${this.globalLsn}`:this.sessionToken=`${this.version}${os.SEGMENT_SEPARATOR}${this.globalLsn}${os.SEGMENT_SEPARATOR}${t}`}}static create(e){let[t,i,...n]=e.split(os.SEGMENT_SEPARATOR),r=parseInt(t,10),o=parseFloat(i);if("number"!=typeof r||"number"!=typeof o)return null;let s=new Map;for(let e of n){let t;let[i,n]=e.split(os.REGION_PROGRESS_SEPARATOR);if(!i||!n)return null;let r=parseInt(i,10);try{t=n}catch(e){return null}if("number"!=typeof r)return null;s.set(r,t)}return new os(r,o,s,e)}equals(e){return!!e&&this.version===e.version&&this.globalLsn===e.globalLsn&&this.areRegionProgressEqual(e.localLsnByregion)}merge(e){if(null==e)throw Error("other (Vector Session Token) must not be null");if(this.version===e.version&&this.localLsnByregion.size!==e.localLsnByregion.size)throw Error(`Compared session tokens ${this.sessionToken} and ${e.sessionToken} have unexpected regions`);let[t,i]=this.version<e.version?[e,this]:[this,e],n=new Map;for(let[r,o]of t.localLsnByregion.entries()){let t=i.localLsnByregion.get(r);if(t)n.set(r,o.length===t.length?o>t?o:t:o.length>t.length?o:t);else if(this.version===e.version)throw Error(`Compared session tokens have unexpected regions. Session 1: ${this.sessionToken} - Session 2: ${this.sessionToken}`);else n.set(r,o)}return new os(Math.max(this.version,e.version),Math.max(this.globalLsn,e.globalLsn),n)}toString(){return this.sessionToken}areRegionProgressEqual(e){if(this.localLsnByregion.size!==e.size)return!1;for(let[t,i]of this.localLsnByregion.entries())if(i!==e.get(t))return!1;return!0}}class oa{collectionNameToCollectionResourceId;collectionResourceIdToSessionTokens;static EMPTY_SESSION_TOKEN="";static SESSION_TOKEN_SEPARATOR=",";static SESSION_TOKEN_PARTITION_SPLITTER=":";constructor(e=new Map,t=new Map){this.collectionNameToCollectionResourceId=e,this.collectionResourceIdToSessionTokens=t}get(e){if(!e)throw Error("request cannot be null");let t=w(R(e.resourceAddress)),i=this.getPartitionKeyRangeIdToTokenMap(t);return oa.getCombinedSessionTokenString(i)}remove(e){let t;let i=w(R(e.resourceAddress));i&&(t=this.collectionNameToCollectionResourceId.get(i),this.collectionNameToCollectionResourceId.delete(i)),void 0!==t&&this.collectionResourceIdToSessionTokens.delete(t)}set(e,t){if(!t||oa.isReadingFromMaster(e.resourceType,e.operationType))return;let i=t[s.HttpHeaders.SessionToken];if(!i)return;let n=this.getContainerName(e,t),r=e.isNameBased&&t[s.HttpHeaders.OwnerId]||e.resourceId;if(r&&n&&this.validateOwnerID(r)){this.collectionResourceIdToSessionTokens.has(r)||this.collectionResourceIdToSessionTokens.set(r,new Map),this.collectionNameToCollectionResourceId.has(n)||this.collectionNameToCollectionResourceId.set(n,r);let e=this.collectionResourceIdToSessionTokens.get(r);oa.compareAndSetToken(i,e)}}validateOwnerID(e){var t;return 8===(t=e.replace(/-/g,"/"),Buffer.from(t,"base64").toString("binary")).length}getPartitionKeyRangeIdToTokenMap(e){let t=null;return e&&this.collectionNameToCollectionResourceId.has(e)&&(t=this.collectionResourceIdToSessionTokens.get(this.collectionNameToCollectionResourceId.get(e))),t}static getCombinedSessionTokenString(e){if(!e||0===e.size)return oa.EMPTY_SESSION_TOKEN;let t="";for(let[i,n]of e.entries())t+=i+oa.SESSION_TOKEN_PARTITION_SPLITTER+n.toString()+oa.SESSION_TOKEN_SEPARATOR;return t.slice(0,-1)}static compareAndSetToken(e,t){if(e)for(let i of e.split(oa.SESSION_TOKEN_SEPARATOR)){let e=i.split(oa.SESSION_TOKEN_PARTITION_SPLITTER);if(2!==e.length)return;let n=e[0],r=os.create(e[1]),o=t.get(n)?t.get(n).merge(r):r;t.set(n,o)}}static isReadingFromMaster(e,t){return e===s.Path.OffersPathSegment||e===s.Path.DatabasesPathSegment||e===s.Path.UsersPathSegment||e===s.Path.PermissionsPathSegment||e===s.Path.TopologyPathSegment||e===s.Path.DatabaseAccountPathSegment||e===s.Path.PartitionKeyRangesPathSegment||e===s.Path.CollectionsPathSegment&&t===q.Query}getContainerName(e,t){let i=t[s.HttpHeaders.OwnerFullName];return i||(i=R(e.resourceAddress)),w(i)}}function oc(e){return e.replace(/\s+/g,"").toLowerCase()}class ol{logger=tt("CosmosDBDiagnostics");async write(e){this.logger.verbose(e)}}class ou{async write(e){}}class oh{format(e){return JSON.stringify(e)}}function od(e,t){let i;let n=`${(i="<environment undetectable>",globalThis.navigator&&globalThis.navigator.userAgent&&(i=globalThis.navigator.userAgent),globalThis.process&&globalThis.process.version&&(i=`Node.js/${process.version.slice(1)} (${process.platform}; ${process.arch})`),i)} ${s.SDKName}/${s.SDKVersion}`;return t&&(n=n+" "+t),e&&e.userAgentSuffix&&(n=n+" "+e.userAgentSuffix),n}let op=tt("ClientContext"),oy="application/query+json",of=s.HttpHeaders;class og{cosmosClientOptions;globalEndpointManager;clientConfig;diagnosticLevel;globalPartitionEndpointManager;sessionContainer;connectionPolicy;pipeline;diagnosticWriter;diagnosticFormatter;partitionKeyDefinitionCache;partitionKeyRangeCache;enableEncryption=!1;constructor(e,t,i,n,r){if(this.cosmosClientOptions=e,this.globalEndpointManager=t,this.clientConfig=i,this.diagnosticLevel=n,this.globalPartitionEndpointManager=r,e.clientEncryptionOptions&&(this.enableEncryption=!0),this.connectionPolicy=e.connectionPolicy,this.sessionContainer=new oa,this.partitionKeyDefinitionCache={},this.pipeline=null,e.aadCredentials){this.pipeline=rn.create();let t=new URL(e.endpoint).href.replace(/\/$/,""),i=`${t}/.default`,n=e.aadScope||i;this.pipeline.addPolicy(function(e){let{credential:t,scopes:i,challengeCallbacks:n}=e,r=e.logger||rv,o={authorizeRequest:n?.authorizeRequest?.bind(n)??rD,authorizeRequestOnChallenge:n?.authorizeRequestOnChallenge?.bind(n)},s=t?function(e,t){let i,n=null,r=null,o={...rP},s={get isRefreshing(){return null!==n},get shouldRefresh(){if(s.isRefreshing)return!1;if(r?.refreshAfterTimestamp&&r.refreshAfterTimestamp<Date.now())return!0;return(r?.expiresOnTimestamp??0)-o.refreshWindowInMs<Date.now()},get mustRefresh(){return null===r||r.expiresOnTimestamp-o.forcedRefreshWindowInMs<Date.now()}};function a(t,a){return s.isRefreshing||(n=rA(()=>e.getToken(t,a),o.retryIntervalInMs,r?.expiresOnTimestamp??Date.now()).then(e=>(n=null,r=e,i=a.tenantId,r)).catch(e=>{throw n=null,r=null,i=void 0,e})),n}return async(e,t)=>{let n=!!t.claims,o=i!==t.tenantId;return(n&&(r=null),o||n||s.mustRefresh)?a(e,t):(s.shouldRefresh&&a(e,t),r)}}(t):()=>Promise.resolve(null);return{name:"bearerTokenAuthenticationPolicy",async sendRequest(e,t){let n,a;if(!e.url.toLowerCase().startsWith("https://"))throw Error("Bearer token authentication is not permitted for non-TLS protected (non-https) URLs.");if(await o.authorizeRequest({scopes:Array.isArray(i)?i:[i],request:e,getAccessToken:s,logger:r}),[n,a]=await rM(e,t),rk(n)){let c=rL(n.headers.get("WWW-Authenticate"));if(c){let o;try{o=atob(c)}catch(e){return r.warning(`The WWW-Authenticate header contains "claims" that cannot be parsed. Unable to perform the Continuous Access Evaluation authentication flow. Unparsable claims: ${c}`),n}await rO({scopes:Array.isArray(i)?i:[i],response:n,request:e,getAccessToken:s,logger:r},o)&&([n,a]=await rM(e,t))}else if(o.authorizeRequestOnChallenge&&(await o.authorizeRequestOnChallenge({scopes:Array.isArray(i)?i:[i],request:e,response:n,getAccessToken:s,logger:r})&&([n,a]=await rM(e,t)),rk(n)&&(c=rL(n.headers.get("WWW-Authenticate"))))){let o;try{o=atob(c)}catch(e){return r.warning(`The WWW-Authenticate header contains "claims" that cannot be parsed. Unable to perform the Continuous Access Evaluation authentication flow. Unparsable claims: ${c}`),n}await rO({scopes:Array.isArray(i)?i:[i],response:n,request:e,getAccessToken:s,logger:r},o)&&([n,a]=await rM(e,t))}}if(!a)return n;throw a}}}({credential:e.aadCredentials,scopes:n,challengeCallbacks:{async authorizeRequest({request:t,getAccessToken:i}){try{let e=await i([n],{}),r=`${a}${e.token}`;t.headers.set(s.HttpHeaders.Authorization,r)}catch(n){if(!e.aadScope&&n?.message?.includes("AADSTS500011"))try{let e=await i(["https://cosmos.azure.com/.default"],{}),n=`${a}${e.token}`;t.headers.set(s.HttpHeaders.Authorization,n)}catch(e){throw n}else throw n}}}}))}this.initializeDiagnosticSettings(n),this.partitionKeyRangeCache=new id(this)}async read({path:e,resourceType:t,resourceId:i,options:n={},partitionKey:r,diagnosticNode:o,partitionKeyRangeId:s}){try{let a={...this.getContextDerivedPropsForRequestCreation(),method:H.get,path:e,operationType:q.Read,resourceId:i,options:n,resourceType:t,partitionKey:r};o.addData({operationType:q.Read,resourceType:t}),a.headers=await this.buildHeaders(a),a.partitionKeyRangeId=s,t===K.clientencryptionkey&&(a.headers[of.AllowCachedReadsHeader]=!0,n.databaseRid&&(a.headers[of.DatabaseRidHeader]=n.databaseRid)),this.applySessionToken(a),a.endpoint=await this.globalEndpointManager.resolveServiceEndpointInternal({diagnosticNode:o,resourceType:a.resourceType,operationType:a.operationType,startServiceEndpointIndex:0,excludedLocations:n?.excludedLocations});let c=await r6(o,a,oo.request,eB.operation);return this.captureSessionToken(void 0,e,q.Read,c.headers),c}catch(t){throw this.captureSessionToken(t,e,q.Upsert,t.headers),t}}async queryFeed({path:e,resourceType:t,resourceId:i,resultFn:n,query:r,options:o,diagnosticNode:s,partitionKeyRangeId:a,partitionKey:c,startEpk:l,endEpk:u,correlatedActivityId:h}){let d={...this.getContextDerivedPropsForRequestCreation(),method:H.get,path:e,operationType:q.Query,partitionKeyRangeId:a,resourceId:i,resourceType:t,options:o,body:r,partitionKey:c};s.addData({operationType:q.Query,resourceType:t});let p=tV();void 0!==r&&(d.method=H.post),d.endpoint=await this.globalEndpointManager.resolveServiceEndpointInternal({diagnosticNode:s,resourceType:d.resourceType,operationType:d.operationType,startServiceEndpointIndex:0,excludedLocations:o?.excludedLocations}),d.headers=await this.buildHeaders(d),void 0!==l&&void 0!==u&&(d.headers[of.StartEpk]=l,d.headers[of.EndEpk]=u,d.headers[of.ReadFeedKeyType]="EffectivePartitionKeyRange"),void 0!==r&&(void 0!==h&&(d.headers[of.CorrelatedActivityId]=h),d.headers[of.IsQuery]="true",d.headers[of.ContentType]=oy,"string"==typeof r&&(d.body={query:r})),this.applySessionToken(d),op.info("query "+p+" started"+(d.partitionKeyRangeId?" pkrid: "+d.partitionKeyRangeId:"")),op.verbose(d);let y=Date.now(),f=await oo.request(d,s);return op.info("query "+p+" finished - "+(Date.now()-y)+"ms"),this.captureSessionToken(void 0,e,q.Query,f.headers),this.processQueryFeedResponse(f,!!r,n)}async getQueryPlan(e,t,i,n,r={},o,s){let a={...this.getContextDerivedPropsForRequestCreation(),method:H.post,path:e,operationType:q.Read,resourceId:i,resourceType:t,options:r,body:n};o.addData({operationType:q.Read,resourceType:t}),a.endpoint=await this.globalEndpointManager.resolveServiceEndpointInternal({diagnosticNode:o,resourceType:a.resourceType,operationType:a.operationType,startServiceEndpointIndex:0,excludedLocations:r?.excludedLocations}),a.headers=await this.buildHeaders(a),void 0!==s&&(a.headers[of.CorrelatedActivityId]=s),a.headers[of.IsQueryPlan]="True",a.headers[of.QueryVersion]="1.4",a.headers[of.ContentType]=oy,a.headers[of.SupportedQueryFeatures]=function(e){let t=Object.keys(Q),i=[];return e.disableNonStreamingOrderByQuery&&i.push(Q.NonStreamingOrderBy),e.disableHybridSearchQueryPlanOptimization&&i.push(Q.HybridSearchSkipOrderByRewrite),t.filter(e=>!i.includes(e)).join(",")}(r),"string"==typeof n&&(a.body={query:n}),this.applySessionToken(a);let c=await oo.request(a,o);return this.captureSessionToken(void 0,e,q.Query,c.headers),c}queryPartitionKeyRanges(e,t,i){let n=T(e,K.pkranges),r=v(e),o=async(e,i)=>await this.queryFeed({path:n,resourceType:K.pkranges,resourceId:r,resultFn:e=>e.PartitionKeyRanges,query:t,options:i,diagnosticNode:e});return new nv(this,t,i,o)}async delete({path:e,resourceType:t,resourceId:i,options:n={},partitionKey:r,method:o=H.delete,diagnosticNode:s,partitionKeyRangeId:a}){try{let c={...this.getContextDerivedPropsForRequestCreation(),method:o,operationType:q.Delete,path:e,resourceType:t,options:n,resourceId:i,partitionKey:r};s.addData({operationType:q.Delete,resourceType:t}),c.headers=await this.buildHeaders(c),c.partitionKeyRangeId=a,this.applySessionToken(c),c.endpoint=await this.globalEndpointManager.resolveServiceEndpointInternal({diagnosticNode:s,resourceType:c.resourceType,operationType:c.operationType,startServiceEndpointIndex:0,excludedLocations:n?.excludedLocations});let l=await r6(s,c,oo.request,eB.operation);return"colls"!==m(e).type?this.captureSessionToken(void 0,e,q.Delete,l.headers):this.clearSessionToken(e),l}catch(t){throw this.captureSessionToken(t,e,q.Upsert,t.headers),t}}async patch({body:e,path:t,resourceType:i,resourceId:n,options:r={},partitionKey:o,diagnosticNode:s,partitionKeyRangeId:a}){try{let c={...this.getContextDerivedPropsForRequestCreation(),method:H.patch,operationType:q.Patch,path:t,resourceType:i,body:e,resourceId:n,options:r,partitionKey:o};s.addData({operationType:q.Patch,resourceType:i}),c.headers=await this.buildHeaders(c),c.partitionKeyRangeId=a,this.applySessionToken(c),c.endpoint=await this.globalEndpointManager.resolveServiceEndpointInternal({diagnosticNode:s,resourceType:c.resourceType,operationType:c.operationType,startServiceEndpointIndex:0,excludedLocations:r?.excludedLocations});let l=await r6(s,c,oo.request,eB.operation);return this.captureSessionToken(void 0,t,q.Patch,l.headers),l}catch(e){throw this.captureSessionToken(e,t,q.Upsert,e.headers),e}}async create({body:e,path:t,resourceType:i,resourceId:n,diagnosticNode:r,options:o={},partitionKey:s,partitionKeyRangeId:a}){try{let c={...this.getContextDerivedPropsForRequestCreation(),method:H.post,operationType:q.Create,path:t,resourceType:i,resourceId:n,body:e,options:o,partitionKey:s};r.addData({operationType:q.Create,resourceType:i}),c.headers=await this.buildHeaders(c),c.partitionKeyRangeId=a,this.applySessionToken(c),c.endpoint=await this.globalEndpointManager.resolveServiceEndpointInternal({diagnosticNode:r,resourceType:c.resourceType,operationType:c.operationType,startServiceEndpointIndex:0,excludedLocations:o?.excludedLocations});let l=await r6(r,c,oo.request,eB.operation);return this.captureSessionToken(void 0,t,q.Create,l.headers),l}catch(e){throw this.captureSessionToken(e,t,q.Upsert,e.headers),e}}processQueryFeedResponse(e,t,i){return t?{result:i(e.result),headers:e.headers,code:e.code}:{result:i(e.result).map(e=>e),headers:e.headers,code:e.code}}applySessionToken(e){let t=this.getSessionParams(e.path);if(e.headers&&e.headers[of.SessionToken])return;let i=e.headers[of.ConsistencyLevel];if(i&&i===Y.Session&&t.resourceAddress){let i=this.sessionContainer.get(t);i&&(e.headers[of.SessionToken]=i)}}async replace({body:e,path:t,resourceType:i,resourceId:n,options:r={},partitionKey:o,diagnosticNode:s,partitionKeyRangeId:a}){try{let c={...this.getContextDerivedPropsForRequestCreation(),method:H.put,operationType:q.Replace,path:t,resourceType:i,body:e,resourceId:n,options:r,partitionKey:o};s.addData({operationType:q.Replace,resourceType:i}),c.headers=await this.buildHeaders(c),c.partitionKeyRangeId=a,this.applySessionToken(c),c.endpoint=await this.globalEndpointManager.resolveServiceEndpointInternal({diagnosticNode:s,resourceType:c.resourceType,operationType:c.operationType,startServiceEndpointIndex:0,excludedLocations:r?.excludedLocations});let l=await r6(s,c,oo.request,eB.operation);return this.captureSessionToken(void 0,t,q.Replace,l.headers),l}catch(e){throw this.captureSessionToken(e,t,q.Upsert,e.headers),e}}async upsert({body:e,path:t,resourceType:i,resourceId:n,options:r={},partitionKey:o,diagnosticNode:s,partitionKeyRangeId:a}){try{let c={...this.getContextDerivedPropsForRequestCreation(),method:H.post,operationType:q.Upsert,path:t,resourceType:i,body:e,resourceId:n,options:r,partitionKey:o};s.addData({operationType:q.Upsert,resourceType:i}),c.headers=await this.buildHeaders(c),c.partitionKeyRangeId=a,c.headers[of.IsUpsert]=!0,this.applySessionToken(c),c.endpoint=await this.globalEndpointManager.resolveServiceEndpointInternal({diagnosticNode:s,resourceType:c.resourceType,operationType:c.operationType,startServiceEndpointIndex:0,excludedLocations:r?.excludedLocations});let l=await r6(s,c,oo.request,eB.operation);return this.captureSessionToken(void 0,t,q.Upsert,l.headers),l}catch(e){throw this.captureSessionToken(e,t,q.Upsert,e.headers),e}}async execute({sprocLink:e,params:t,options:i={},partitionKey:n,diagnosticNode:r,partitionKeyRangeId:o}){null==t||Array.isArray(t)||(t=[t]);let s=T(e),a=v(e),c={...this.getContextDerivedPropsForRequestCreation(),method:H.post,operationType:q.Execute,path:s,resourceType:K.sproc,options:i,resourceId:a,body:t,partitionKey:n};return r.addData({operationType:q.Execute,resourceType:K.sproc}),c.headers=await this.buildHeaders(c),c.partitionKeyRangeId=o,c.endpoint=await this.globalEndpointManager.resolveServiceEndpointInternal({diagnosticNode:r,resourceType:c.resourceType,operationType:c.operationType,startServiceEndpointIndex:0,excludedLocations:i?.excludedLocations}),await r6(r,c,oo.request,eB.operation)}async getDatabaseAccount(e,t={}){let i=t.urlConnection||this.cosmosClientOptions.endpoint,n={...this.getContextDerivedPropsForRequestCreation(),endpoint:i,method:H.get,operationType:q.Read,path:"",resourceType:K.none,options:t};e.addData({operationType:q.Read,resourceType:K.none}),n.headers=await this.buildHeaders(n);let{result:r,headers:o,code:s,substatus:a,diagnostics:c}=await r6(e,n,oo.request,eB.operation);return{result:new tn(r,o),headers:o,diagnostics:c,code:s,substatus:a}}getWriteEndpoint(e){return this.globalEndpointManager.getWriteEndpoint(e)}getReadEndpoint(e){return this.globalEndpointManager.getReadEndpoint(e)}getWriteEndpoints(){return this.globalEndpointManager.getWriteEndpoints()}getReadEndpoints(){return this.globalEndpointManager.getReadEndpoints()}async batch({body:e,path:t,partitionKey:i,resourceId:n,options:r={},diagnosticNode:o,partitionKeyRangeId:s}){try{let a={...this.getContextDerivedPropsForRequestCreation(),method:H.post,operationType:q.Batch,path:t,body:e,resourceType:K.item,resourceId:n,options:r,partitionKey:i};o.addData({operationType:q.Batch,resourceType:K.item}),a.headers=await this.buildHeaders(a),a.partitionKeyRangeId=s,a.headers[of.IsBatchRequest]=!0,a.headers[of.IsBatchAtomic]=!0,this.applySessionToken(a),a.endpoint=await this.globalEndpointManager.resolveServiceEndpointInternal({diagnosticNode:o,resourceType:a.resourceType,operationType:a.operationType,startServiceEndpointIndex:0,excludedLocations:r?.excludedLocations});let c=await r6(o,a,oo.request,eB.operation);return this.captureSessionToken(void 0,t,q.Batch,c.headers),c.diagnostics=o.toDiagnostic(this.getClientConfig()),c}catch(e){throw this.captureSessionToken(e,t,q.Upsert,e.headers),e}}async bulk({body:e,path:t,partitionKeyRangeId:i,resourceId:n,bulkOptions:r={},options:o={},diagnosticNode:s}){try{let a={...this.getContextDerivedPropsForRequestCreation(),method:H.post,operationType:q.Batch,path:t,body:e,resourceType:K.item,resourceId:n,options:o};s.addData({operationType:q.Batch,resourceType:K.item}),a.headers=await this.buildHeaders(a),a.partitionKeyRangeId=i,a.headers[of.IsBatchRequest]=!0,a.headers[of.PartitionKeyRangeID]=i,a.headers[of.IsBatchAtomic]=!1,a.headers[of.BatchContinueOnError]=r.continueOnError??!0,this.applySessionToken(a),a.endpoint=await this.globalEndpointManager.resolveServiceEndpointInternal({diagnosticNode:s,resourceType:a.resourceType,operationType:a.operationType,startServiceEndpointIndex:0,excludedLocations:o?.excludedLocations});let c=await r6(s,a,oo.request,eB.operation);return this.captureSessionToken(void 0,t,q.Batch,c.headers),c}catch(e){throw this.captureSessionToken(e,t,q.Upsert,e.headers),e}}captureSessionToken(e,t,i,n){let r=this.getSessionParams(t);r.operationType=i,e&&(this.isMasterResource(r.resourceType)||e.code!==k.PreconditionFailed&&e.code!==k.Conflict&&(e.code!==k.NotFound||e.substatus===O.ReadSessionNotAvailable))||this.sessionContainer.set(r,n)}clearSessionToken(e){let t=this.getSessionParams(e);this.sessionContainer.remove(t)}recordDiagnostics(e){let t=this.diagnosticFormatter.format(e);this.diagnosticWriter.write(t)}initializeDiagnosticSettings(e){(this.diagnosticFormatter=new oh,e===ey.info)?this.diagnosticWriter=new ou:this.diagnosticWriter=new ol}getSessionParams(e){let t=null,i=m(e);return{resourceId:null,resourceAddress:i.objectBody.self,resourceType:i.type,isNameBased:!0}}isMasterResource(e){return e===s.Path.OffersPathSegment||e===s.Path.DatabasesPathSegment||e===s.Path.UsersPathSegment||e===s.Path.PermissionsPathSegment||e===s.Path.TopologyPathSegment||e===s.Path.DatabaseAccountPathSegment||e===s.Path.PartitionKeyRangesPathSegment||e===s.Path.CollectionsPathSegment}buildHeaders(e){return iK({clientOptions:this.cosmosClientOptions,defaultHeaders:{...this.cosmosClientOptions.defaultHeaders,...e.options.initialHeaders},verb:e.method,path:e.path,resourceId:e.resourceId,resourceType:e.resourceType,options:e.options,partitionKeyRangeId:e.partitionKeyRangeId,useMultipleWriteLocations:this.connectionPolicy.useMultipleWriteLocations,partitionKey:void 0!==e.partitionKey?to(e.partitionKey):void 0,operationType:e.operationType})}getContextDerivedPropsForRequestCreation(){return{globalEndpointManager:this.globalEndpointManager,requestAgent:this.cosmosClientOptions.agent,connectionPolicy:this.connectionPolicy,client:this,plugins:this.cosmosClientOptions.plugins,pipeline:this.pipeline,httpClient:this.cosmosClientOptions.httpClient,globalPartitionEndpointManager:this.globalPartitionEndpointManager}}getClientConfig(){return this.clientConfig}refreshUserAgent(e){let t=od(this.cosmosClientOptions,e);this.cosmosClientOptions.defaultHeaders[s.HttpHeaders.UserAgent]=t,this.cosmosClientOptions.defaultHeaders[s.HttpHeaders.CustomUserAgent]=t}getRetryOptions(){return this.connectionPolicy.retryOptions}isPartitionLevelFailOverEnabled(){return this.globalEndpointManager.lastKnownPPAFEnabled||this.globalEndpointManager.lastKnownPPCBEnabled}}let om=eV.env[s.CosmosDbDiagnosticLevelEnvVarName],oC=ey.info,oE=Object.values(ey).map(e=>e.toString());function ow(e){return oE.includes(e)}(function(e){return"string"==typeof e&&e.trim().length>0})(om)&&(ow(om)?function(e){if(e&&!ow(e))throw Error(`Unknown diagnostic level '${e}'. Acceptable values: ${oE.join(",")}`);o=e}(om):console.error(`${s.CosmosDbDiagnosticLevelEnvVarName} set to unknown diagnostic level '${om}'; Setting Cosmos Db diagnostic level to info. Acceptable values: ${oE.join(", ")}.`));class oR{cacheTimeToLive;cache;cacheRefresher;constructor(e){this.cacheTimeToLive=e,this.cache=new Map,this.clearCacheOnTtlExpiry()}get(e){if(this.cache.has(e))return this.cache.get(e)[1]}set(e,t){0!==this.cacheTimeToLive&&this.cache.set(e,[new Date,t])}async clearCacheOnTtlExpiry(){this.cacheRefresher=tN(async()=>{let e=new Date;for(let t of this.cache.keys())e.getTime()-this.cache.get(t)[0].getTime()>this.cacheTimeToLive&&this.cache.delete(t)},s.EncryptionCacheRefreshIntervalInMs)}async createProtectedDataEncryptionKey(e,t,i){let n,r;i?(n=await t.unwrapEncryptionKey(i),r=i):(n=this.generateColumnEncryptionKey(),r=await t.wrapEncryptionKey(n));let o=new rz(e,t,n,r);if(0!==this.cacheTimeToLive){let i=JSON.stringify([e,t.name,t.path,r.toString("hex")]);this.set(i,o)}return o}async getOrCreate(e,t,i,n){let r=i?Buffer.from(i):void 0;if(0===this.cacheTimeToLive||n)return this.createProtectedDataEncryptionKey(e,t,r);if(r){let i=JSON.stringify([e,t.name,t.path,r.toString("hex")]),n=this.get(i);if(n)return n}return this.createProtectedDataEncryptionKey(e,t,r)}generateColumnEncryptionKey(){return(0,eK.randomBytes)(32)}}class ox{cache;constructor(){this.cache=new Map}getOrCreate(e,t,i){let n=JSON.stringify([e,t]),r=this.get(n);return r||(r=new rq(e,t,i),this.set(n,r)),r}get(e){return this.cache.get(e)}set(e,t){this.cache.set(e,t)}}class ob{id;containerRid;partitionKeyPaths;pathsToEncrypt=[];encryptionSettingForProperties={};constructor(e,t,i){this.id=e,this.containerRid=t,this.partitionKeyPaths=i}setEncryptionSettingForProperty(e,t){this.encryptionSettingForProperties[e]=t}getEncryptionSettingForProperty(e){return this.encryptionSettingForProperties[e]}}class ov{cache;constructor(){this.cache=new Map}async create(e,t,i,n){let r=new ob(e,t,i);if(n){for(let e of n.includedPaths){let t=new rN(e);r.pathsToEncrypt.push(e.path),r.setEncryptionSettingForProperty(e.path,t)}return this.set(e,r),r}}get(e){return this.cache.get(e)}set(e,t){this.cache.set(e,t)}}class oT{clientEncryptionKeyPropertiesCache;constructor(){this.clientEncryptionKeyPropertiesCache=new Map}get(e){return this.clientEncryptionKeyPropertiesCache.get(e)}set(e,t){this.clientEncryptionKeyPropertiesCache.set(e,t)}}class oS{cacheTimeToLive;encryptionKeyStoreProvider;protectedDataEncryptionKeyCache;keyEncryptionKeyCache;encryptionSettingsCache;clientEncryptionKeyPropertiesCache;constructor(e,t){this.cacheTimeToLive=void 0!==t?t:s.DefaultEncryptionCacheTimeToLiveInSeconds;let i=this.getCacheTTlInMs();this.encryptionKeyStoreProvider=new rH(e,i),this.protectedDataEncryptionKeyCache=new oR(i),this.keyEncryptionKeyCache=new ox,this.encryptionSettingsCache=new ov,this.clientEncryptionKeyPropertiesCache=new oT}getCacheTTlInMs(){return Number(1e3*this.cacheTimeToLive)}}class oI{readDatabaseAccount;defaultEndpoint;enableEndpointDiscovery;isRefreshing;options;preferredLocations;writeableLocations=[];readableLocations=[];unavailableReadableLocations=[];unavailableWriteableLocations=[];enableMultipleWriteLocations;preferredLocationsCount;enablePartitionLevelFailover;enablePartitionLevelCircuitBreaker;lastKnownPPAFEnabled;lastKnownPPCBEnabled;onEnablePartitionLevelFailoverConfigChanged;constructor(e,t){this.readDatabaseAccount=t,this.options=e,this.defaultEndpoint=e.endpoint,this.enableEndpointDiscovery=e.connectionPolicy.enableEndpointDiscovery,this.isRefreshing=!1,this.preferredLocations=this.options.connectionPolicy.preferredLocations,this.preferredLocationsCount=this.preferredLocations?this.preferredLocations.length:0,this.enablePartitionLevelFailover=e.connectionPolicy.enablePartitionLevelFailover,this.enablePartitionLevelCircuitBreaker=e.connectionPolicy.enablePartitionLevelCircuitBreaker,this.lastKnownPPCBEnabled=e.connectionPolicy.enablePartitionLevelCircuitBreaker,this.lastKnownPPAFEnabled=!1}async getReadEndpoint(e){return this.resolveServiceEndpoint(e,K.item,q.Read)}async getWriteEndpoint(e){return this.resolveServiceEndpoint(e,K.item,q.Replace)}async getReadEndpoints(){return this.readableLocations.map(e=>e.databaseAccountEndpoint)}async getWriteEndpoints(){return this.writeableLocations.map(e=>e.databaseAccountEndpoint)}async getReadLocations(){return this.readableLocations}async markCurrentLocationUnavailableForRead(e,t){await this.refreshEndpointList(e);let i=this.readableLocations.find(e=>e.databaseAccountEndpoint===t);i&&(i.unavailable=!0,i.lastUnavailabilityTimestampInMs=Date.now(),this.unavailableReadableLocations.push(i))}async markCurrentLocationUnavailableForWrite(e,t){await this.refreshEndpointList(e);let i=this.writeableLocations.find(e=>e.databaseAccountEndpoint===t);i&&(i.unavailable=!0,i.lastUnavailabilityTimestampInMs=Date.now(),this.unavailableWriteableLocations.push(i))}canUseMultipleWriteLocations(e,t){let i=this.options.connectionPolicy.useMultipleWriteLocations&&this.enableMultipleWriteLocations;return e&&(i=i&&(e===K.item||e===K.sproc&&t===q.Execute)),i}getEffectiveExcludedLocations(e=[],t){return t!==K.item?new Set:e.length?new Set(e.map(oc)):new Set}filterExcludedLocations(e,t){return t&&0!==t.size?e.filter(e=>!t.has(oc(e))):e}async resolveServiceEndpoint(e,t,i,n=0){return this.resolveServiceEndpointInternal({diagnosticNode:e,resourceType:t,operationType:i,startServiceEndpointIndex:n})}async resolveServiceEndpointInternal(e){let t;let{diagnosticNode:i,resourceType:n,operationType:r,startServiceEndpointIndex:o,excludedLocations:s=[]}=e;if(!this.options.connectionPolicy.enableEndpointDiscovery)return i.addData({readFromCache:!0},"default_endpoint"),i.recordEndpointResolution(this.defaultEndpoint),this.defaultEndpoint;if(n===K.none)return i.addData({readFromCache:!0},"none_resource"),i.recordEndpointResolution(this.defaultEndpoint),this.defaultEndpoint;if(0===this.readableLocations.length||0===this.writeableLocations.length){let e=await tY(async e=>this.readDatabaseAccount(e,{urlConnection:this.defaultEndpoint}),i,ep.DatabaseAccountLookUp);this.writeableLocations=e.resource.writableLocations,this.readableLocations=e.resource.readableLocations,this.enableMultipleWriteLocations=e.resource.enableMultipleWritableLocations,this.enablePartitionLevelFailover&&this.refreshPPAFFeatureFlag(e.resource)}let a=C(r)?this.readableLocations:this.writeableLocations,c=this.getEffectiveExcludedLocations(s,n);i.addData({excludedLocations:Array.from(c)},"excluded_locations");let l=this.filterExcludedLocations(this.preferredLocations,c);if(l&&l.length>0&&o<l.length){this.preferredLocationsCount=l.length;for(let e=o;e<l.length;e++){let i=l[e];if(t=a.find(e=>!0!==e.unavailable&&oc(e.name)===oc(i)))break}}return t||(t=(o>=0&&o<a.length?a.slice(o):a).find(e=>!0!==e.unavailable&&!c.has(oc(e.name)))),t=t||{name:"",databaseAccountEndpoint:this.defaultEndpoint},i.recordEndpointResolution(t.databaseAccountEndpoint),t.databaseAccountEndpoint}async refreshEndpointList(e){if(!this.isRefreshing&&this.enableEndpointDiscovery){this.isRefreshing=!0;let t=await this.getDatabaseAccountFromAnyEndpoint(e);t&&(this.enablePartitionLevelFailover&&this.refreshPPAFFeatureFlag(t),this.refreshStaleUnavailableLocations(),this.refreshEndpoints(t)),this.isRefreshing=!1}}refreshEndpoints(e){let t=this.writeableLocations,i=this.readableLocations;function n(e,t){let i=t.find(t=>t.name===e.name);return i&&(e.unavailable=i.unavailable,e.lastUnavailabilityTimestampInMs=i.lastUnavailabilityTimestampInMs),e}this.writeableLocations=e.writableLocations.map(e=>n({...e},t)),this.readableLocations=e.readableLocations.map(e=>n({...e},i))}refreshStaleUnavailableLocations(){let e=Date.now();this.updateLocation(e,this.unavailableReadableLocations,this.readableLocations),this.unavailableReadableLocations=this.cleanUnavailableLocationList(e,this.unavailableReadableLocations),this.updateLocation(e,this.unavailableWriteableLocations,this.writeableLocations),this.unavailableWriteableLocations=this.cleanUnavailableLocationList(e,this.unavailableWriteableLocations)}updateLocation(e,t,i){for(let n of t){let t=i.find(e=>e.name===n.name);t&&e-t.lastUnavailabilityTimestampInMs>s.LocationUnavailableExpirationTimeInMs&&(t.unavailable=!1)}}cleanUnavailableLocationList(e,t){return t.filter(t=>e-t.lastUnavailabilityTimestampInMs<s.LocationUnavailableExpirationTimeInMs)}async getDatabaseAccountFromAnyEndpoint(e){try{let t={urlConnection:this.defaultEndpoint},{resource:i}=await this.readDatabaseAccount(e,t);return i}catch(e){}if(this.preferredLocations)for(let t of this.preferredLocations)try{let i={urlConnection:oI.getLocationalEndpoint(this.defaultEndpoint,t)},{resource:n}=await this.readDatabaseAccount(e,i);if(n)return n}catch(e){}}static getLocationalEndpoint(e,t){let i=new URL(e);if(i.hostname){let n=i.hostname.toString().toLowerCase().split(".");if(n){let i=n[0],r=i+"-"+t.replace(" ","");return e.toLowerCase().replace(i,r)}}return null}refreshPPAFFeatureFlag(e){let t=!1;t=!!this.enablePartitionLevelCircuitBreaker||!!this.enablePartitionLevelFailover&&(e.enablePerPartitionFailover??this.lastKnownPPAFEnabled??!1),this.lastKnownPPAFEnabled=e.enablePerPartitionFailover,this.lastKnownPPCBEnabled!==t&&(this.lastKnownPPCBEnabled=t,this.onEnablePartitionLevelFailoverConfigChanged?.(t))}}class oP{failedEndPoints=[];currentEndPoint;consecutiveReadRequestFailureCount=0;consecutiveWriteRequestFailureCount=0;firstRequestFailureTime=Date.now();lastRequestFailureTime=Date.now();failureCountSemaphore;tryMoveNextLocationSemaphore;constructor(e){this.currentEndPoint=e,this.failureCountSemaphore=i8(1),this.tryMoveNextLocationSemaphore=i8(1)}async canCircuitBreakerTriggerPartitionFailOver(e){let{consecutiveReadRequestFailureCount:t,consecutiveWriteRequestFailureCount:i}=await this.snapshotConsecutiveRequestFailureCount();return e?t>s.ReadRequestFailureCountThreshold:i>s.WriteRequestFailureCountThreshold}async incrementRequestFailureCounts(e,t){return new Promise((i,n)=>{this.failureCountSemaphore.take(async()=>{try{let{lastRequestFailureTime:n}=await this.snapshotPartitionFailoverTimestamps();return t-n>s.ConsecutiveFailureCountResetIntervalInMS&&(this.consecutiveReadRequestFailureCount=0,this.consecutiveWriteRequestFailureCount=0),e?this.consecutiveReadRequestFailureCount++:this.consecutiveWriteRequestFailureCount++,this.lastRequestFailureTime=t,i()}catch(e){n(e)}finally{this.failureCountSemaphore.leave()}})})}async snapshotPartitionFailoverTimestamps(){return{firstRequestFailureTime:this.firstRequestFailureTime,lastRequestFailureTime:this.lastRequestFailureTime}}async tryMoveNextLocation(e,t,i,n){return t!==this.currentEndPoint||new Promise((r,o)=>{this.tryMoveNextLocationSemaphore.take(()=>{try{for(let i of e)if(!(this.currentEndPoint===i||this.failedEndPoints.includes(i)))return this.failedEndPoints.push(t),this.currentEndPoint=i,r(!0);return i.addData({partitionKeyRangeFailoverInfo:`PartitionKeyRangeId: ${n}, failedLocations: ${this.failedEndPoints}, newLocation: ${this.currentEndPoint}`}),r(!1)}catch(e){o(e)}finally{this.tryMoveNextLocationSemaphore.leave()}})})}getCurrentEndPoint(){return this.currentEndPoint}async snapshotConsecutiveRequestFailureCount(){return{consecutiveReadRequestFailureCount:this.consecutiveReadRequestFailureCount,consecutiveWriteRequestFailureCount:this.consecutiveWriteRequestFailureCount}}}class oA{globalEndpointManager;partitionKeyRangeToLocationForWrite;partitionKeyRangeToLocationForReadAndWrite;preferredLocations;preferredLocationsCount;circuitBreakerFailbackBackgroundRefresher;constructor(e,t){this.globalEndpointManager=t,this.partitionKeyRangeToLocationForWrite=new Map,this.partitionKeyRangeToLocationForReadAndWrite=new Map,this.preferredLocations=e.connectionPolicy.preferredLocations,this.preferredLocationsCount=this.preferredLocations?this.preferredLocations.length:0,this.globalEndpointManager.lastKnownPPCBEnabled&&this.initiateCircuitBreakerFailbackLoop()}async tryPartitionLevelFailover(e,t){if(!await this.isRequestEligibleForPartitionFailover(e,!0))return!1;let i=this.isRequestEligibleForPerPartitionAutomaticFailover(e),n=this.isRequestEligibleForPartitionLevelCircuitBreaker(e);return!!(i||n&&await this.incrementFailureCounterAndCheckFailover(e,i,n))&&this.tryMarkEndpointUnavailableForPartitionKeyRange(e,t,i,n)}async tryAddPartitionLevelLocationOverride(e,t){if(!await this.isRequestEligibleForPartitionFailover(e,!1))return e;let i=e.partitionKeyRangeId;if(this.isRequestEligibleForPerPartitionAutomaticFailover(e)){if(this.partitionKeyRangeToLocationForWrite.has(i)){let n=this.partitionKeyRangeToLocationForWrite.get(i);e.endpoint=n.getCurrentEndPoint(),t.recordEndpointResolution(e.endpoint)}}else if(this.isRequestEligibleForPartitionLevelCircuitBreaker(e)&&this.partitionKeyRangeToLocationForReadAndWrite.has(i)){let n=this.partitionKeyRangeToLocationForReadAndWrite.get(i);await n.canCircuitBreakerTriggerPartitionFailOver(C(e.operationType))&&(e.endpoint=n.getCurrentEndPoint(),t.recordEndpointResolution(e.endpoint))}return e}dispose(){this.circuitBreakerFailbackBackgroundRefresher&&(clearTimeout(this.circuitBreakerFailbackBackgroundRefresher),this.circuitBreakerFailbackBackgroundRefresher=void 0)}async tryMarkEndpointUnavailableForPartitionKeyRange(e,t,i,n){let r=e.partitionKeyRangeId,o=e.endpoint,s=await this.globalEndpointManager.getReadLocations(),a=[];if(i){for(let e of s)a.push(e.databaseAccountEndpoint);return this.tryAddOrUpdatePartitionFailoverInfoAndMoveToNextLocation(r,o,a,this.partitionKeyRangeToLocationForWrite,t)}if(n){if(this.preferredLocations&&this.preferredLocations.length>0){for(let e of this.preferredLocations){let t=s.find(t=>oc(t.name)===oc(e));t&&a.push(t.databaseAccountEndpoint)}for(let e of s)a.includes(e.databaseAccountEndpoint)||a.push(e.databaseAccountEndpoint)}else for(let e of s)a.push(e.databaseAccountEndpoint);return this.tryAddOrUpdatePartitionFailoverInfoAndMoveToNextLocation(r,o,a,this.partitionKeyRangeToLocationForReadAndWrite,t)}return!1}async incrementFailureCounterAndCheckFailover(e,t,i){let n;let r=e.partitionKeyRangeId,o=e.endpoint;if(t){if(!this.partitionKeyRangeToLocationForWrite.has(r)){let e=new oP(o);this.partitionKeyRangeToLocationForWrite.set(r,e)}n=this.partitionKeyRangeToLocationForWrite.get(r)}else{if(!i)return!1;if(!this.partitionKeyRangeToLocationForReadAndWrite.has(r)){let e=new oP(o);this.partitionKeyRangeToLocationForReadAndWrite.set(r,e)}n=this.partitionKeyRangeToLocationForReadAndWrite.get(r)}ty(n,"partitionKeyRangeFailoverInfo should be set if failover flags are true.");let s=Date.now();return await n.incrementRequestFailureCounts(C(e.operationType),s),n.canCircuitBreakerTriggerPartitionFailOver(C(e.operationType))}async isRequestEligibleForPartitionFailover(e,t){return!!(e&&e.operationType&&e.resourceType&&e.partitionKeyRangeId&&await this.canUsePartitionLevelFailoverLocations(e.operationType,e.resourceType))&&(!t||!!e.endpoint)}async canUsePartitionLevelFailoverLocations(e,t){return!((await this.globalEndpointManager.getReadEndpoints()).length<=1)&&(t===K.item||t===K.sproc&&e===q.Execute)}isRequestEligibleForPerPartitionAutomaticFailover(e){return this.isPartitionLevelAutomaticFailoverEnabled()&&!C(e.operationType)&&!this.globalEndpointManager.canUseMultipleWriteLocations(e.resourceType,e.operationType)}isRequestEligibleForPartitionLevelCircuitBreaker(e){return!!this.isPartitionLevelCircuitBreakerEnabled()&&(!!C(e.operationType)||this.globalEndpointManager.canUseMultipleWriteLocations(e.resourceType,e.operationType))}async tryAddOrUpdatePartitionFailoverInfoAndMoveToNextLocation(e,t,i,n,r){if(!n.has(e)){let i=new oP(t);n.set(e,i)}let o=n.get(e);return!!await o.tryMoveNextLocation(i,t,r,e)||(n.delete(e),!1)}initiateCircuitBreakerFailbackLoop(){this.circuitBreakerFailbackBackgroundRefresher=tN(async()=>{try{await this.openConnectionToUnhealthyEndpointsWithFailback()}catch(e){console.error("Failed to open connection to unhealthy endpoints: ",e)}},s.StalePartitionUnavailabilityRefreshIntervalInMs)}async openConnectionToUnhealthyEndpointsWithFailback(){for(let e of this.partitionKeyRangeToLocationForReadAndWrite.keys()){let t=this.partitionKeyRangeToLocationForReadAndWrite.get(e);if(!t)continue;let{firstRequestFailureTime:i}=await t.snapshotPartitionFailoverTimestamps();new Date().getTime()-i>s.AllowedPartitionUnavailabilityDurationInMs&&this.partitionKeyRangeToLocationForReadAndWrite.delete(e)}}changeCircuitBreakerFailbackLoop(e){e?this.circuitBreakerFailbackBackgroundRefresher||this.initiateCircuitBreakerFailbackLoop():this.circuitBreakerFailbackBackgroundRefresher&&this.dispose()}isPartitionLevelAutomaticFailoverEnabled(){return this.globalEndpointManager.lastKnownPPAFEnabled}isPartitionLevelCircuitBreakerEnabled(){return this.globalEndpointManager.lastKnownPPCBEnabled}}class oM{databases;offers;clientContext;endpointRefresher;encryptionManager;globalPartitionEndpointManager;constructor(e){var t;if("string"==typeof e)e=A(e);else if(e.connectionString){let{endpoint:t,key:i}=A(e.connectionString);e.endpoint=t,e.key=i}if(new URL(e.endpoint),e.clientEncryptionOptions){if(!e.clientEncryptionOptions.keyEncryptionKeyResolver)throw Error("KeyEncryptionKeyResolver needs to be provided to enable client-side encryption.");if(e.clientEncryptionOptions.encryptionKeyTimeToLiveInSeconds&&e.clientEncryptionOptions.encryptionKeyTimeToLiveInSeconds<60)throw Error("EncryptionKeyTimeToLiveInSeconds needs to be >= 60 seconds.");this.encryptionManager=new oS(e.clientEncryptionOptions.keyEncryptionKeyResolver,e.clientEncryptionOptions.encryptionKeyTimeToLiveInSeconds)}let i=this.initializeClientConfigDiagnostic(e);e.connectionPolicy=Object.assign({},ti,e.connectionPolicy),e.connectionPolicy.enableEndpointDiscovery||(e.connectionPolicy.enablePartitionLevelFailover=!1,e.connectionPolicy.enablePartitionLevelCircuitBreaker=!1),e.defaultHeaders=e.defaultHeaders||{},e.defaultHeaders[s.HttpHeaders.CacheControl]="no-cache",e.defaultHeaders[s.HttpHeaders.Version]=s.CurrentVersion,void 0!==e.consistencyLevel&&(e.defaultHeaders[s.HttpHeaders.ConsistencyLevel]=e.consistencyLevel),void 0!==e.throughputBucket&&(e.defaultHeaders[s.HttpHeaders.ThroughputBucket]=e.throughputBucket);let n=od(e);e.defaultHeaders[s.HttpHeaders.UserAgent]=n,e.defaultHeaders[s.HttpHeaders.CustomUserAgent]=n;let r=new oI(e,async(e,t)=>this.getDatabaseAccountInternal(e,t));(e.connectionPolicy.enablePartitionLevelFailover||e.connectionPolicy.enablePartitionLevelCircuitBreaker)&&(this.globalPartitionEndpointManager=new oA(e,r),r.onEnablePartitionLevelFailoverConfigChanged=e=>{this.globalPartitionEndpointManager?.changeCircuitBreakerFailbackLoop(e)}),this.clientContext=new og(e,r,i,(t=e.diagnosticLevel,o??t??oC),this.globalPartitionEndpointManager),e.connectionPolicy?.enableEndpointDiscovery&&e.connectionPolicy?.enableBackgroundEndpointRefreshing&&this.backgroundRefreshEndpointList(r,e.connectionPolicy.endpointRefreshRateInMs||ti.endpointRefreshRateInMs),this.databases=new r2(this,this.clientContext,this.encryptionManager),this.offers=new n4(this,this.clientContext)}initializeClientConfigDiagnostic(e){return{endpoint:e.endpoint,resourceTokensConfigured:void 0!==e.resourceTokens,tokenProviderConfigured:void 0!==e.tokenProvider,aadCredentialsConfigured:void 0!==e.aadCredentials,connectionPolicyConfigured:void 0!==e.connectionPolicy,consistencyLevel:e.consistencyLevel,defaultHeaders:e.defaultHeaders,agentConfigured:void 0!==e.agent,userAgentSuffix:e.userAgentSuffix,diagnosticLevel:e.diagnosticLevel,pluginsConfigured:void 0!==e.plugins,sDKVersion:s.SDKVersion,aadScopeOverride:void 0!==e.aadScope}}async getDatabaseAccount(e){return tZ(async t=>this.getDatabaseAccountInternal(t,e),this.clientContext)}async getDatabaseAccountInternal(e,t){let i=await this.clientContext.getDatabaseAccount(e,t);return new tm(i.result,i.headers,i.code,tG(),i.substatus)}async getWriteEndpoint(){return tZ(async e=>this.clientContext.getWriteEndpoint(e),this.clientContext)}async getReadEndpoint(){return tZ(async e=>this.clientContext.getReadEndpoint(e),this.clientContext)}getWriteEndpoints(){return this.clientContext.getWriteEndpoints()}getReadEndpoints(){return this.clientContext.getReadEndpoints()}database(e){return new r1(this,e,this.clientContext,this.encryptionManager)}offer(e){return new n5(this,e,this.clientContext)}dispose(){clearTimeout(this.endpointRefresher),this.clientContext.enableEncryption&&(clearTimeout(this.encryptionManager.encryptionKeyStoreProvider.cacheRefresher),clearTimeout(this.encryptionManager.protectedDataEncryptionKeyCache.cacheRefresher)),this.globalPartitionEndpointManager&&this.globalPartitionEndpointManager.dispose()}async backgroundRefreshEndpointList(e,t){this.endpointRefresher=setInterval(()=>{try{return tZ(async t=>e.refreshEndpointList(t),this.clientContext,ef.BACKGROUND_REFRESH_THREAD)}catch(e){console.warn("Failed to refresh endpoints",e)}},t),this.endpointRefresher.unref&&"function"==typeof this.endpointRefresher.unref&&this.endpointRefresher.unref()}async updateHostFramework(e){this.clientContext.refreshUserAgent(e)}}},8547:(e,t,i)=>{"use strict";i.d(t,{Z:()=>c});var n=i(6005);let r={randomUUID:n.randomUUID},o=new Uint8Array(256),s=o.length,a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));let c=function(e,t,i){return!r.randomUUID||t||e?function(e,t,i){let r=(e=e||{}).random??e.rng?.()??(s>o.length-16&&((0,n.randomFillSync)(o),s=0),o.slice(s,s+=16));if(r.length<16)throw Error("Random bytes length must be >= 16");if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){if((i=i||0)<0||i+16>t.length)throw RangeError(`UUID byte range ${i}:${i+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[i+e]=r[e];return t}return function(e,t=0){return(a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]).toLowerCase()}(r)}(e,t,i):r.randomUUID()}}};