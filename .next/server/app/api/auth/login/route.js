"use strict";(()=>{var e={};e.id=873,e.ids=[873,868],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7790:e=>{e.exports=require("assert")},9714:e=>{e.exports=require("constants")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},9801:e=>{e.exports=require("os")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},4175:e=>{e.exports=require("tty")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},6005:e=>{e.exports=require("node:crypto")},8849:e=>{e.exports=require("node:http")},2286:e=>{e.exports=require("node:https")},612:e=>{e.exports=require("node:os")},7742:e=>{e.exports=require("node:process")},4492:e=>{e.exports=require("node:stream")},7261:e=>{e.exports=require("node:util")},5628:e=>{e.exports=require("node:zlib")},1494:(e,r,s)=>{s.r(r),s.d(r,{originalPathname:()=>g,patchFetch:()=>y,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>O,staticGenerationAsyncStorage:()=>v});var t={};s.r(t),s.d(t,{POST:()=>x});var n=s(9303),a=s(8716),i=s(670),o=s(7070),u=s(989),l=s(6868),c=s(1375),m=s(1047),d=s(9276),p=s(2038);async function x(e){try{if(!process.env.COSMOS_ENDPOINT||!process.env.COSMOS_KEY)return console.error("Missing required environment variables: COSMOS_ENDPOINT or COSMOS_KEY"),(0,d.jl)("Configuration serveur incorrecte","SERVER_CONFIG_ERROR",500);let r=await e.json();console.log("Login attempt for user:",r.username);let s=m.dm.safeParse(r);if(!s.success)return console.log("Validation error:",s.error),(0,d.S3)(s.error);let{username:t,password:n}=s.data;console.log("Looking up user:",t);let a=await (0,u.dQ)(t);if(a||(console.log("User not found by username, trying email"),a=await (0,u.CX)(t)),!a||!a.isActive)return console.log("User not found or inactive"),(0,d.jl)(p.s.auth.invalidCredentials,"INVALID_CREDENTIALS",401);if(console.log("User found, verifying password"),!await (0,l.G)(n,a.passwordHash))return console.log("Password verification failed"),(0,d.jl)(p.s.auth.invalidCredentials,"INVALID_CREDENTIALS",401);console.log("Password verified, creating session");let i=await (0,c.ed)(a.id,a.username,a.role);await (0,u.Cf)(a.id,a.username),console.log("Login successful for user:",t);let x=(0,c.Uj)(i),f=o.NextResponse.json({data:{username:a.username,role:a.role},message:p.s.success.loginSuccess},{status:200});return f.cookies.set(x),f}catch(e){return console.error("Login error:",e),e instanceof Error&&(console.error("Error message:",e.message),console.error("Error stack:",e.stack)),(0,d.S3)(e)}}let f=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"C:\\GIT\\HuronPortal\\app\\api\\auth\\login\\route.ts",nextConfigOutput:"standalone",userland:t}),{requestAsyncStorage:h,staticGenerationAsyncStorage:v,serverHooks:O}=f,g="/api/auth/login/route";function y(){return(0,i.patchFetch)({serverHooks:O,staticGenerationAsyncStorage:v})}},6868:(e,r,s)=>{s.d(r,{G:()=>i,hashPassword:()=>a});var t=s(5430),n=s(565);async function a(e){let r=crypto.getRandomValues(new Uint8Array(16)),s=(0,t.n)(n.JQ,e,r,{c:1e5,dkLen:32});return Buffer.from(r).toString("hex")+":"+Buffer.from(s).toString("hex")}async function i(e,r){let[s,a]=r.split(":");if(!s||!a)return!1;let i=new Uint8Array(Buffer.from(s,"hex")),o=Buffer.from(a,"hex"),u=(0,t.n)(n.JQ,e,i,{c:1e5,dkLen:32});if(u.length!==o.length)return!1;let l=0;for(let e=0;e<u.length;e++)l|=u[e]^o[e];return 0===l}},1375:(e,r,s)=>{s.d(r,{Gg:()=>d,Rf:()=>x,Uj:()=>p,ed:()=>l,v6:()=>m});var t=s(6890),n=s(1463),a=s(1615);let i=new TextEncoder().encode(process.env.SESSION_SECRET||"development-secret-key-change-in-production"),o=Number(process.env.SESSION_DURATION)||3600,u="session";async function l(e,r,s){let n=Math.floor(Date.now()/1e3),a=n+o;return await new t.N({userId:e,username:r,role:s,createdAt:n,expiresAt:a}).setProtectedHeader({alg:"HS256"}).setIssuedAt(n).setExpirationTime(a).sign(i)}async function c(e){try{let{payload:r}=await (0,n._)(e,i),s=Math.floor(Date.now()/1e3);if(r.expiresAt&&"number"==typeof r.expiresAt&&r.expiresAt<s)return null;return r}catch(e){return null}}async function m(e){let r=e.cookies.get(u)?.value;return r?c(r):null}async function d(){let e=await (0,a.cookies)(),r=e.get(u)?.value;return r?c(r):null}function p(e){return{name:u,value:e,httpOnly:!0,secure:!0,sameSite:"lax",maxAge:o,path:"/"}}function x(){return{name:u,value:"",httpOnly:!0,secure:!0,sameSite:"lax",maxAge:0,path:"/"}}},25:(e,r,s)=>{s.d(r,{IK:()=>c,ZO:()=>l});var t=s(8657);let n=null,a=process.env.COSMOS_DATABASE||"huronportal-db",i=null;async function o(){let e=function(){if(!n){let e=process.env.COSMOS_ENDPOINT,r=process.env.COSMOS_KEY;if(!e||!r)throw console.error("Cosmos DB configuration error:"),console.error("COSMOS_ENDPOINT:",e?"set":"missing"),console.error("COSMOS_KEY:",r?"set":"missing"),Error("COSMOS_ENDPOINT and COSMOS_KEY must be defined in environment variables");console.log("Initializing Cosmos DB client with endpoint:",e),n=new t.Pi({endpoint:e,key:r})}return n}();if(!i){let{database:r}=await e.databases.createIfNotExists({id:a});i=r}return i}let u={users:null,machines:null,clients:null};async function l(e){if(!u[e]){let r=await o(),{container:s}=await r.containers.createIfNotExists({id:e,partitionKey:{paths:[{users:"/username",machines:"/id",clients:"/id"}[e]]}});u[e]=s}return u[e]}function c(e){if(409===e.code)throw Error("DUPLICATE_ENTRY");if(404===e.code)throw Error("NOT_FOUND");if(412===e.code)throw Error("CONCURRENT_MODIFICATION");throw e}},989:(e,r,s)=>{s.d(r,{CX:()=>o,Cf:()=>d,GA:()=>u,Nq:()=>l,dQ:()=>i,h8:()=>c,r4:()=>a,yw:()=>m});var t=s(25),n=s(8547);async function a(e){try{let r=await (0,t.ZO)("users"),s=new Date().toISOString(),a={id:(0,n.Z)(),username:e.username,email:e.email,name:e.name,passwordHash:e.passwordHash,role:e.role,isActive:e.isActive,createdAt:s,updatedAt:s},{resource:i}=await r.items.create(a);return i}catch(e){return(0,t.IK)(e)}}async function i(e){try{let r=await (0,t.ZO)("users"),{resources:s}=await r.items.query({query:"SELECT * FROM users u WHERE u.username = @username",parameters:[{name:"@username",value:e}]}).fetchAll();return s[0]||null}catch(e){return console.error("Error fetching user:",e),null}}async function o(e){try{let r=await (0,t.ZO)("users"),{resources:s}=await r.items.query({query:"SELECT * FROM users u WHERE u.email = @email",parameters:[{name:"@email",value:e}]}).fetchAll();return s[0]||null}catch(e){return console.error("Error fetching user by email:",e),null}}async function u(e){try{let r=await (0,t.ZO)("users"),{resources:s}=await r.items.query({query:"SELECT * FROM users u WHERE u.id = @id",parameters:[{name:"@id",value:e}]}).fetchAll();return s[0]||null}catch(e){return console.error("Error fetching user by id:",e),null}}async function l(e,r,s,n){try{let a=await (0,t.ZO)("users"),i=await a.item(e,r).read();if(!i.resource)throw Error("NOT_FOUND");let o={...i.resource,...s,updatedAt:new Date().toISOString()},{resource:u}=await a.item(e,r).replace(o,n?{accessCondition:{type:"IfMatch",condition:n}}:void 0);if(!u)throw Error("NOT_FOUND");return u}catch(e){return(0,t.IK)(e)}}async function c(e,r){try{let s=await (0,t.ZO)("users");await s.item(e,r).delete()}catch(e){return(0,t.IK)(e)}}async function m(e){try{let r=await (0,t.ZO)("users"),s="SELECT * FROM users u WHERE 1=1",n=[];e?.role&&(s+=" AND u.role = @role",n.push({name:"@role",value:e.role})),e?.isActive!==void 0&&(s+=" AND u.isActive = @isActive",n.push({name:"@isActive",value:e.isActive}));let a={query:s+=" ORDER BY u.username",parameters:n},{resources:i}=await r.items.query(a).fetchAll();return i}catch(e){return console.error("Error listing users:",e),[]}}async function d(e,r){try{let s=await (0,t.ZO)("users"),n=await s.item(e,r).read();if(n.resource){let t={...n.resource,lastLogin:new Date().toISOString(),updatedAt:new Date().toISOString()};await s.item(e,r).replace(t)}}catch(e){console.error("Error updating last login:",e)}}},9276:(e,r,s)=>{s.d(r,{S3:()=>a,jl:()=>n});var t=s(6263);function n(e,r,s=400,t){return Response.json({error:e,code:r,details:t},{status:s})}function a(e){if(console.error("Error:",e),e instanceof t.jmq)return n("Donn\xe9es invalides","VALIDATION_ERROR",400,e.issues.map(e=>({field:e.path.join("."),message:e.message})));if(e instanceof Error)switch(e.message){case"DUPLICATE_ENTRY":return n("Un enregistrement avec ces informations existe d\xe9j\xe0","DUPLICATE_ENTRY",409);case"NOT_FOUND":return n("Ressource non trouv\xe9e","NOT_FOUND",404);case"CONCURRENT_MODIFICATION":return n("Cet enregistrement a \xe9t\xe9 modifi\xe9 par un autre utilisateur","CONCURRENT_MODIFICATION",412);case"UNAUTHORIZED":return n("Authentification requise","UNAUTHORIZED",401);case"FORBIDDEN":return n("Acc\xe8s interdit","FORBIDDEN",403)}return n("Une erreur est survenue","SERVER_ERROR",500)}},2038:(e,r,s)=>{s.d(r,{s:()=>t});let t={required:"Ce champ est requis",invalid:"Valeur invalide",minLength:e=>`Minimum ${e} caract\xe8res requis`,maxLength:e=>`Maximum ${e} caract\xe8res autoris\xe9s`,email:"Adresse courriel invalide",password:{required:"Le mot de passe est requis",minLength:"Le mot de passe doit contenir au moins 8 caract\xe8res",maxLength:"Le mot de passe ne peut pas d\xe9passer 128 caract\xe8res"},user:{usernameRequired:"Le nom d'utilisateur est requis",usernameMin:"Le nom d'utilisateur doit contenir au moins 3 caract\xe8res",usernameMax:"Le nom d'utilisateur ne peut pas d\xe9passer 50 caract\xe8res",usernameFormat:"Le nom d'utilisateur ne peut contenir que des lettres minuscules, chiffres, points, traits d'union et underscores",nameRequired:"Le nom complet est requis",nameMax:"Le nom ne peut pas d\xe9passer 100 caract\xe8res",emailRequired:"Le courriel est requis",emailInvalid:"Adresse courriel invalide",emailMax:"Le courriel ne peut pas d\xe9passer 100 caract\xe8res",roleRequired:"Le r\xf4le est requis",roleInvalid:"R\xf4le invalide. Choisir: Admin, Contr\xf4leur ou Utilisateur",duplicateUsername:e=>`Le nom d'utilisateur "${e}" est d\xe9j\xe0 utilis\xe9. Veuillez en choisir un autre.`,duplicateEmail:e=>`Le courriel "${e}" est d\xe9j\xe0 utilis\xe9. Veuillez en choisir un autre.`},machine:{numeroOLRequired:"Le num\xe9ro #OL est requis",numeroOLMax:"Le num\xe9ro #OL ne peut pas d\xe9passer 50 caract\xe8res",numeroOLFormat:"Le num\xe9ro #OL ne peut contenir que des lettres majuscules, chiffres et tirets",duplicateOL:e=>`Le num\xe9ro #OL "${e}" existe d\xe9j\xe0`,typeRequired:"Le type de machine est requis",typeMax:"Le type ne peut pas d\xe9passer 200 caract\xe8res",clientRequired:"Le client est requis",clientInvalid:"Client invalide"},client:{companyNameRequired:"Le nom de l'entreprise est requis",companyNameMax:"Le nom de l'entreprise ne peut pas d\xe9passer 200 caract\xe8res",addressRequired:"L'adresse est requise",addressMax:"L'adresse ne peut pas d\xe9passer 300 caract\xe8res",provinceRequired:"La province est requise",provinceInvalid:"Province invalide",postalCodeRequired:"Le code postal est requis",postalCodeFormat:"Format de code postal invalide (A1A 1A1 ou A1A1A1)",hasMatches:e=>`Ce client a ${e} machine(s) associ\xe9e(s). Veuillez d'abord supprimer ou r\xe9assigner les machines.`},auth:{invalidCredentials:"Identifiants invalides",sessionExpired:"Votre session a expir\xe9. Veuillez vous reconnecter.",unauthorized:"Authentification requise",forbidden:"Acc\xe8s interdit",forbiddenRole:e=>`Vous n'avez pas les permissions n\xe9cessaires pour ${e}`},concurrency:{modified:"Cet enregistrement a \xe9t\xe9 modifi\xe9 par un autre utilisateur. Veuillez rafra\xeechir et r\xe9essayer.",machineModified:"Cette machine a \xe9t\xe9 modifi\xe9e par un autre utilisateur. Veuillez rafra\xeechir et r\xe9essayer.",clientModified:"Ce client a \xe9t\xe9 modifi\xe9 par un autre utilisateur. Veuillez rafra\xeechir et r\xe9essayer.",userModified:"Cet utilisateur a \xe9t\xe9 modifi\xe9 par un autre administrateur. Veuillez rafra\xeechir et r\xe9essayer."},deletion:{cannotDeleteSelf:"Vous ne pouvez pas supprimer votre propre compte utilisateur.",cannotDeleteLastAdmin:"Impossible de supprimer le dernier administrateur du syst\xe8me.",confirmDelete:"\xcates-vous s\xfbr de vouloir supprimer cet \xe9l\xe9ment?"},success:{created:e=>`${e} cr\xe9\xe9 avec succ\xe8s`,updated:e=>`${e} modifi\xe9 avec succ\xe8s`,deleted:e=>`${e} supprim\xe9 avec succ\xe8s`,loginSuccess:"Connexion r\xe9ussie",logoutSuccess:"D\xe9connexion r\xe9ussie"},server:{error:"Une erreur est survenue",unavailable:"Le service est temporairement indisponible"}}},1047:(e,r,s)=>{s.d(r,{J6:()=>a,Lf:()=>c,c5:()=>u,dm:()=>o,g:()=>l,gV:()=>i,rR:()=>m});var t=s(6263),n=s(2038);let a=t.Ryn({username:t.Z_8().min(3,n.s.user.usernameMin).max(50,n.s.user.usernameMax).regex(/^[a-z0-9._-]+$/,n.s.user.usernameFormat),email:t.Z_8().min(1,n.s.user.emailRequired).email(n.s.user.emailInvalid).max(100,n.s.user.emailMax),name:t.Z_8().min(1,n.s.user.nameRequired).max(100,n.s.user.nameMax),password:t.Z_8().min(8,n.s.password.minLength).max(128,n.s.password.maxLength),role:t.KmV(["Admin","Contr\xf4leur","Utilisateur"],{message:n.s.user.roleInvalid}),isActive:t.O72().default(!0)}),i=t.Ryn({username:t.Z_8().min(3,n.s.user.usernameMin).max(50,n.s.user.usernameMax).regex(/^[a-z0-9._-]+$/,n.s.user.usernameFormat).optional(),email:t.Z_8().email(n.s.user.emailInvalid).max(100,n.s.user.emailMax).optional(),name:t.Z_8().min(1,n.s.user.nameRequired).max(100,n.s.user.nameMax).optional(),password:t.Z_8().min(8,n.s.password.minLength).max(128,n.s.password.maxLength).optional(),role:t.KmV(["Admin","Contr\xf4leur","Utilisateur"],{message:n.s.user.roleInvalid}).optional(),isActive:t.O72().optional()}),o=t.Ryn({username:t.Z_8().min(1,"Le nom d'utilisateur ou courriel est requis"),password:t.Z_8().min(1,n.s.password.required)}),u=t.Ryn({numeroOL:t.Z_8().min(1,n.s.machine.numeroOLRequired).max(50,n.s.machine.numeroOLMax).regex(/^[A-Z0-9-]+$/,n.s.machine.numeroOLFormat),type:t.Z_8().min(1,n.s.machine.typeRequired).max(200,n.s.machine.typeMax),clientId:t.Z_8().uuid(n.s.machine.clientInvalid)}),l=t.Ryn({numeroOL:t.Z_8().min(1,n.s.machine.numeroOLRequired).max(50,n.s.machine.numeroOLMax).regex(/^[A-Z0-9-]+$/,n.s.machine.numeroOLFormat).optional(),type:t.Z_8().min(1,n.s.machine.typeRequired).max(200,n.s.machine.typeMax).optional(),clientId:t.Z_8().uuid(n.s.machine.clientInvalid).optional()}),c=t.Ryn({companyName:t.Z_8().min(1,n.s.client.companyNameRequired).max(200,n.s.client.companyNameMax),address:t.Z_8().min(1,n.s.client.addressRequired).max(300,n.s.client.addressMax),province:t.KmV(["QC","ON","AB","BC","MB","NB","NL","NT","NS","NU","PE","SK","YT"],{message:n.s.client.provinceInvalid}),postalCode:t.Z_8().regex(/^[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d$/,n.s.client.postalCodeFormat).transform(e=>e.replace(/[ -]/g,"").toUpperCase())}),m=t.Ryn({companyName:t.Z_8().min(1,n.s.client.companyNameRequired).max(200,n.s.client.companyNameMax).optional(),address:t.Z_8().min(1,n.s.client.addressRequired).max(300,n.s.client.addressMax).optional(),province:t.KmV(["QC","ON","AB","BC","MB","NB","NL","NT","NS","NU","PE","SK","YT"],{message:n.s.client.provinceInvalid}).optional(),postalCode:t.Z_8().regex(/^[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d$/,n.s.client.postalCodeFormat).transform(e=>e.replace(/[ -]/g,"").toUpperCase()).optional()})}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[276,112,418,972,263,997],()=>s(1494));module.exports=t})();